<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>互動式路燈電氣設計指南</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Calm Harmony -->
    <!-- Application Structure Plan: The SPA is structured into five main, logical tabs: '設計案例' (Case Studies), '壓降, 線徑, 保護裝置計算' (Calculator), '單線圖設計' (SLD Design), '設計總結' (Summary), and '補充說明' (Supplementary Info). The calculator is enhanced with a hierarchical verification logic, including feeder and total voltage drop, reflecting a complete panel design workflow. The SLD is now dynamic, reflecting the calculator's inputs. -->
    <!-- Visualization & Content Choices: 
        - Report Info: Design verification logic. Goal: Inform/Apply. Viz: Interactive dropdowns and color-coded text results for a feeder, two branch circuits, and one main panel, now including busbar and voltage-dependent grounding checks. Justification: Simulates a realistic design workflow, allowing users to verify individual components and the overall system's compliance with 3%-3%-5% rule. Library/Method: Vanilla JS.
        - Report Info: SLD components. Goal: Organize & Inform. Viz: A dynamic SVG-based diagram. Interaction: Selections in the calculator tab update the diagram's text content. Justification: Creates a powerful feedback loop between design parameters and visual representation. Library/Method: Vanilla JS and inline SVG.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #F8F7F4;
            color: #334155;
        }
        .tab-active {
            border-color: #4A6C6F;
            color: #4A6C6F;
            font-weight: 700;
        }
        .tab-inactive {
            border-color: transparent;
            color: #64748b;
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .sld-highlight {
            transition: all 0.3s ease-in-out;
            cursor: pointer;
        }
        .sld-highlight.active {
            background-color: rgba(74, 108, 111, 0.1);
            color: #4A6C6F;
            font-weight: 700;
        }
        .sld-component-line {
            stroke: #334155;
            stroke-width: 1.5;
        }
        .sld-component-box {
            fill: #f1f5f9;
            stroke: #64748b;
            stroke-width: 1;
        }
        .sld-component-text, .sld-label-text {
            font-size: 10px;
            font-family: 'Noto Sans TC', sans-serif;
            fill: #334155;
        }
        .sld-title-text {
             font-size: 14px;
             font-weight: bold;
             font-family: 'Noto Sans TC', sans-serif;
             fill: #1e293b;
        }
        .verification-grid {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 0.5rem 1rem;
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-800">互動式路燈電氣設計指南</h1>
            <p class="mt-2 text-lg text-slate-600">從傳統照明到智慧杆：單線圖與壓降分析的實踐</p>
        </header>

        <nav class="mb-8 border-b border-slate-300">
            <ul class="flex flex-wrap -mb-px text-sm font-medium text-center">
                <li class="mr-2">
                    <button class="nav-tab inline-block p-4 border-b-2 rounded-t-lg tab-active" data-tab="cases">設計案例</button>
                </li>
                <li class="mr-2">
                    <button class="nav-tab inline-block p-4 border-b-2 rounded-t-lg tab-inactive" data-tab="calculator">壓降, 線徑, 保護裝置計算</button>
                </li>
                <li class="mr-2">
                    <button class="nav-tab inline-block p-4 border-b-2 rounded-t-lg tab-inactive" data-tab="sld">單線圖設計</button>
                </li>
                <li class="mr-2">
                    <button class="nav-tab inline-block p-4 border-b-2 rounded-t-lg tab-inactive" data-tab="summary">設計總結</button>
                </li>
                <li>
                    <button class="nav-tab inline-block p-4 border-b-2 rounded-t-lg tab-inactive" data-tab="supplement">補充說明</button>
                </li>
            </ul>
        </nav>

        <main>
            <section id="sld" class="content-section">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-bold mb-2 text-[#4A6C6F]">單線圖 (SLD)：電力系統的藍圖</h2>
                    <p class="mb-6 text-slate-700 leading-relaxed">此單線圖會根據您在「計算機」頁面中的選擇動態更新，以反映您當前的設計。</p>
                    
                    <div class="grid md:grid-cols-3 gap-6">
                        <div class="md:col-span-1">
                            <h3 class="text-lg font-semibold mb-3">主要元件列表</h3>
                            <ul class="space-y-2">
                                <li><button class="sld-highlight w-full text-left p-2 rounded" data-component="power-source">1. 電源 (Power Source)</button></li>
                                <li><button class="sld-highlight w-full text-left p-2 rounded" data-component="breaker">2. 主斷路器 (Main Breaker)</button></li>
                                <li><button class="sld-highlight w-full text-left p-2 rounded" data-component="feeder">3. 幹線電纜 (Feeder Cable)</button></li>
                                <li><button class="sld-highlight w-full text-left p-2 rounded" data-component="control-box">4. 控制箱 (Control Box)</button></li>
                                <li><button class="sld-highlight w-full text-left p-2 rounded" data-component="branch-breaker">5. 分路斷路器 (Branch Breaker)</button></li>
                                <li><button class="sld-highlight w-full text-left p-2 rounded" data-component="branch-circuit">6. 分路電纜 (Branch Circuit)</button></li>
                                <li><button class="sld-highlight w-full text-left p-2 rounded" data-component="load">7. 負載 (Load)</button></li>
                            </ul>
                        </div>
                        <div class="md:col-span-2">
                            <div class="border rounded-lg p-4 bg-slate-50">
                                <svg id="sld-diagram" viewBox="0 0 500 500" class="w-full h-auto">
                                    <!-- Power Source -->
                                    <g class="sld-component" data-id="power-source">
                                        <text x="250" y="20" text-anchor="middle" class="sld-title-text" id="sld_power_source">電源</text>
                                        <line class="sld-component-line" x1="250" y1="30" x2="250" y2="50" />
                                        <path class="sld-component-line" d="M 245 50 L 255 50 L 250 60 Z" fill="#334155" />
                                    </g>
                                    
                                    <!-- Feeder Cable -->
                                    <g class="sld-component" data-id="feeder">
                                        <line class="sld-component-line" x1="250" y1="60" x2="250" y2="90" />
                                        <text x="260" y="75" class="sld-label-text" id="sld_feeder_wire">XLPE, 14-2/C</text>
                                    </g>

                                    <!-- Control Box L1 -->
                                    <g class="sld-component" data-id="control-box">
                                        <rect x="50" y="90" width="400" height="300" class="sld-component-box" />
                                        <rect x="60" y="100" width="40" height="20" class="sld-component-box" />
                                        <text x="80" y="110" text-anchor="middle" class="sld-title-text">L1</text>
                                    </g>

                                    <!-- Main Breaker NFB -->
                                    <g class="sld-component" data-id="breaker">
                                        <line class="sld-component-line" x1="250" y1="90" x2="250" y2="120" />
                                        <path d="M 250 120 C 240 125, 240 135, 250 140" stroke="#334155" stroke-width="1.5" fill="none" />
                                        <line class="sld-component-line" x1="250" y1="140" x2="230" y2="155" />
                                        <text x="260" y="125" class="sld-label-text">NFB</text>
                                        <text x="260" y="135" class="sld-label-text">2P</text>
                                        <text x="275" y="135" class="sld-label-text" id="sld_main_nfb_at">30 AT</text>
                                    </g>

                                    <!-- Bus Bar -->
                                    <line class="sld-component-line" x1="100" y1="170" x2="400" y2="170" />
                                    <line class="sld-component-line" x1="250" y1="150" x2="250" y2="170" />
                                    <text x="250" y="163" text-anchor="middle" class="sld-label-text" id="sld_busbar_size">CU BUS BAR</text>

                                    <!-- Grounding -->
                                    <g>
                                        <line class="sld-component-line" x1="380" y1="170" x2="380" y2="190" />
                                        <rect x="370" y="190" width="20" height="10" class="sld-component-box" />
                                        <text x="380" y="195" text-anchor="middle" class="sld-label-text">G</text>
                                        <line class="sld-component-line" x1="380" y1="200" x2="430" y2="200" />
                                        <line class="sld-component-line" x1="430" y1="200" x2="430" y2="220" />
                                        <path d="M 425 220 L 435 220 L 430 230 Z" fill="#334155" />
                                        <text x="430" y="240" text-anchor="middle" class="sld-label-text" id="sld_grounding_resistance">R≤50Ω</text>
                                    </g>

                                    <!-- Branch 1 -->
                                    <g class="sld-component" data-id="branch-breaker">
                                        <line class="sld-component-line" x1="150" y1="170" x2="150" y2="200" />
                                        <path d="M 150 200 C 140 205, 140 215, 150 220" stroke="#334155" stroke-width="1.5" fill="none" />
                                        <line class="sld-component-line" x1="150" y1="220" x2="130" y2="235" />
                                        <circle cx="150" cy="245" r="3" fill="none" stroke="#334155" stroke-width="1.5" />
                                        <text x="160" y="202" class="sld-label-text">ELCB</text>
                                        <text x="160" y="212" class="sld-label-text">2P</text>
                                        <text x="175" y="212" class="sld-label-text" id="sld_branch1_elcb_at">20 AT</text>
                                    </g>
                                    <g class="sld-component" data-id="branch-circuit">
                                        <line class="sld-component-line" x1="150" y1="250" x2="150" y2="390" />
                                        <text x="160" y="270" class="sld-label-text" id="sld_branch1_wire">XLPE, 8-2/C</text>
                                    </g>
                                    <g class="sld-component" data-id="load">
                                        <circle cx="150" cy="410" r="12" class="sld-component-box" />
                                        <text x="150" y="410" text-anchor="middle" dominant-baseline="central" class="sld-label-text">①</text>
                                        <text x="150" y="435" text-anchor="middle" class="sld-label-text">迴路 1</text>
                                        <text x="150" y="448" text-anchor="middle" class="sld-label-text" id="sld_branch1_load">總負載: 1440 W</text>
                                    </g>

                                    <!-- Branch 2 -->
                                    <g class="sld-component" data-id="branch-breaker">
                                        <line class="sld-component-line" x1="350" y1="170" x2="350" y2="200" />
                                        <path d="M 350 200 C 340 205, 340 215, 350 220" stroke="#334155" stroke-width="1.5" fill="none" />
                                        <line class="sld-component-line" x1="350" y1="220" x2="330" y2="235" />
                                        <circle cx="350" cy="245" r="3" fill="none" stroke="#334155" stroke-width="1.5" />
                                        <text x="360" y="202" class="sld-label-text">ELCB</text>
                                        <text x="360" y="212" class="sld-label-text">2P</text>
                                        <text x="375" y="212" class="sld-label-text" id="sld_branch2_elcb_at">15 AT</text>
                                    </g>
                                     <g class="sld-component" data-id="branch-circuit">
                                        <line class="sld-component-line" x1="350" y1="250" x2="350" y2="390" />
                                        <text x="360" y="270" class="sld-label-text" id="sld_branch2_wire">XLPE, 8-2/C</text>
                                    </g>
                                    <g class="sld-component" data-id="load">
                                        <circle cx="350" cy="410" r="12" class="sld-component-box" />
                                        <text x="350" y="410" text-anchor="middle" dominant-baseline="central" class="sld-label-text">②</text>
                                        <text x="350" y="435" text-anchor="middle" class="sld-label-text">迴路 2</text>
                                        <text x="350" y="448" text-anchor="middle" class="sld-label-text" id="sld_branch2_load">總負載: 1200 W</text>
                                    </g>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8 pt-6 border-t border-slate-200">
                        <h3 class="text-xl font-bold mb-4 text-[#4A6C6F]">設計建議值</h3>
                        <div class="grid md:grid-cols-3 gap-4">
                            <div class="border border-slate-200 p-4 rounded-lg">
                                <h4 class="font-semibold text-lg mb-2">導線線徑 (Wire Size)</h4>
                                <p class="text-sm text-slate-600 mb-2"><strong>分路：</strong>依規定最小應使用 3.5mm²。但長距離(>100m)迴路常需提升至 5.5mm² 或 8mm²，以確保壓降在3%內。</p>
                                <p class="text-sm text-slate-600"><strong>幹線：</strong>無固定值，需經由總壓降計算決定。長距離幹線(>200m)可能需使用 22mm² 以上線徑，以滿足總壓降5%的要求。</p>
                            </div>
                            <div class="border border-slate-200 p-4 rounded-lg">
                                <h4 class="font-semibold text-lg mb-2">漏電斷路器 (ELCB)</h4>
                                <p class="text-sm text-slate-600 mb-2"><strong>安裝位置：</strong>建議總開關及各分路開關均加裝。</p>
                                <p class="text-sm text-slate-600"><strong>額定感度電流：</strong>為達最佳人身安全保護，建議選用 30mA 高靈敏度型。</p>
                                 <p class="text-sm text-slate-600"><strong>動作時間：</strong>應在 0.1 秒以內。</p>
                            </div>
                            <div class="border border-slate-200 p-4 rounded-lg">
                                <h4 class="font-semibold text-lg mb-2">無熔絲開關 (NFB)</h4>
                                <p class="text-sm text-slate-600 mb-2"><strong>額定電流 (AT)：</strong>應大於迴路設計電流，建議取「設計電流 x 1.25倍」作為安全裕度。</p>
                                <p class="text-sm text-slate-600"><strong>啟斷容量 (IC)：</strong>必須大於安裝點的「預期最大短路電流」。此為關鍵安全參數，需向電力公司查詢或計算，確保短路時能安全跳脫。</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="calculator" class="content-section">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-bold mb-2 text-[#4A6C6F]">壓降, 線徑, 保護裝置計算</h2>
                    <p class="mb-6 text-slate-700 leading-relaxed">此工具模擬一個開關箱的設計流程。請分別輸入兩個分路迴路的負載參數，並為各分路及總開關選擇規格，系統將自動進行計算與檢核。</p>
                    
                    <div class="grid lg:grid-cols-2 gap-8">
                        <div>
                            <!-- Common Inputs -->
                            <div class="space-y-4 p-4 border border-slate-200 rounded-lg mb-6">
                                <h3 class="font-semibold text-lg text-slate-800">1. 幹線與共通參數</h3>
                                <div>
                                    <label for="systemType" class="block text-sm font-medium text-slate-700">系統類型</label>
                                    <select id="systemType" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-[#4A6C6F] focus:border-[#4A6C6F]">
                                        <option value="1p2w">單相二線式 (1φ2W)</option>
                                        <option value="1p3w">單相三線式 (1φ3W)</option>
                                        <option value="3p4w" selected>三相四線式 (3φ4W)</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="voltage" class="block text-sm font-medium text-slate-700">標稱電壓 (V)</label>
                                    <input type="number" id="voltage" value="220" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                                </div>
                                 <div>
                                    <label for="length_feeder" class="block text-sm font-medium text-slate-700">幹線長度 (m)</label>
                                    <input type="number" id="length_feeder" value="50" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                                </div>
                                <div>
                                    <label for="checkWireSize_feeder" class="block text-sm font-medium text-slate-700">幹線線徑</label>
                                    <select id="checkWireSize_feeder" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                                        <option value="8">8 mm²</option>
                                        <option value="14" selected>14 mm²</option>
                                        <option value="22">22 mm²</option>
                                        <option value="38">38 mm²</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Circuit 1 -->
                            <div class="space-y-4 p-4 border border-sky-200 rounded-lg mb-6">
                                <h3 class="font-semibold text-lg text-sky-800">2. 迴路 1 (分路)</h3>
                                <div>
                                    <label for="power1" class="block text-sm font-medium text-slate-700">總負載功率 (W)</label>
                                    <input type="number" id="power1" value="1440" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                                </div>
                                <div>
                                    <label for="pf1" class="block text-sm font-medium text-slate-700">功率因數 (PF)</label>
                                    <input type="number" id="pf1" value="0.9" step="0.01" min="0" max="1" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                                </div>
                                <div>
                                    <label for="length1" class="block text-sm font-medium text-slate-700">線路長度 (m)</label>
                                    <input type="number" id="length1" value="150" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                                </div>
                                <div class="pt-2 mt-2 border-t">
                                    <label for="checkWireSize1" class="block text-sm font-medium text-slate-700">導線線徑</label>
                                    <select id="checkWireSize1" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                                        <option value="5.5">5.5 mm²</option>
                                        <option value="8" selected>8 mm²</option>
                                        <option value="14">14 mm²</option>
                                    </select>
                                    <label for="checkElcbAT1" class="block text-sm font-medium text-slate-700 mt-2">ELCB 額定電流 (AT)</label>
                                    <select id="checkElcbAT1" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                                        <option value="15">15 A</option>
                                        <option value="20" selected>20 A</option>
                                        <option value="30">30 A</option>
                                    </select>
                                </div>
                            </div>

                             <!-- Circuit 2 -->
                            <div class="space-y-4 p-4 border border-teal-200 rounded-lg mb-6">
                                <h3 class="font-semibold text-lg text-teal-800">3. 迴路 2 (分路)</h3>
                                <div>
                                    <label for="power2" class="block text-sm font-medium text-slate-700">總負載功率 (W)</label>
                                    <input type="number" id="power2" value="1200" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                                </div>
                                <div>
                                    <label for="pf2" class="block text-sm font-medium text-slate-700">功率因數 (PF)</label>
                                    <input type="number" id="pf2" value="0.9" step="0.01" min="0" max="1" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                                </div>
                                <div>
                                    <label for="length2" class="block text-sm font-medium text-slate-700">線路長度 (m)</label>
                                    <input type="number" id="length2" value="120" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                                </div>
                                 <div class="pt-2 mt-2 border-t">
                                    <label for="checkWireSize2" class="block text-sm font-medium text-slate-700">導線線徑</label>
                                    <select id="checkWireSize2" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                                        <option value="5.5">5.5 mm²</option>
                                        <option value="8" selected>8 mm²</option>
                                        <option value="14">14 mm²</option>
                                    </select>
                                    <label for="checkElcbAT2" class="block text-sm font-medium text-slate-700 mt-2">ELCB 額定電流 (AT)</label>
                                    <select id="checkElcbAT2" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                                        <option value="15" selected>15 A</option>
                                        <option value="20">20 A</option>
                                        <option value="30">30 A</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Main Panel -->
                            <div class="space-y-4 p-4 border border-slate-300 rounded-lg">
                                <h3 class="font-semibold text-lg text-slate-800">4. 開關箱 (總開關)</h3>
                                <div>
                                    <label for="busbarSize" class="block text-sm font-medium text-slate-700">匯流排尺寸 (mm)</label>
                                    <select id="busbarSize" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                                        <option value="15x2">15 x 2</option>
                                        <option value="20x3" selected>20 x 3</option>
                                        <option value="25x3">25 x 3</option>
                                        <option value="30x5">30 x 5</option>
                                    </select>
                                </div>
                                 <div>
                                    <label for="groundingResistance" class="block text-sm font-medium text-slate-700">接地電阻實測/目標值 (Ω)</label>
                                    <input type="number" id="groundingResistance" value="25" step="1" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                                </div>
                                <div class="pt-2 mt-2 border-t">
                                    <label for="checkNfbAT" class="block text-sm font-medium text-slate-700">NFB 額定電流 (AT)</label>
                                    <select id="checkNfbAT" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                                        <option value="20">20 A</option>
                                        <option value="30" selected>30 A</option>
                                        <option value="50">50 A</option>
                                        <option value="75">75 A</option>
                                    </select>
                                     <label for="checkNfbIC" class="block text-sm font-medium text-slate-700 mt-2">NFB 啟斷容量 (IC)</label>
                                    <select id="checkNfbIC" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                                        <option value="5">5 kA</option>
                                        <option value="10" selected>10 kA</option>
                                        <option value="15">15 kA</option>
                                    </select>
                                    <label for="shortCircuitCurrent" class="block text-sm font-medium text-slate-700 mt-2">預期最大短路電流 (kA)</label>
                                    <input type="number" id="shortCircuitCurrent" value="3.5" step="0.1" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                                </div>
                            </div>
                             <button id="calculateBtn" class="w-full bg-[#4A6C6F] text-white font-bold py-3 px-4 rounded-lg hover:bg-[#3E5A5C] transition-colors mt-6 text-lg">計算與檢核</button>
                        </div>
                        <div class="space-y-6">
                            <div>
                                <h3 class="text-lg font-semibold mb-3 text-center text-sky-800">迴路 1 計算與檢核結果</h3>
                                <div id="resultCircuit1" class="text-sm space-y-3 bg-sky-50 p-4 rounded-lg">
                                     <p class="text-base text-center">請點擊「計算與檢核」。</p>
                                </div>
                            </div>
                             <div>
                                <h3 class="text-lg font-semibold mb-3 text-center text-teal-800">迴路 2 計算與檢核結果</h3>
                                <div id="resultCircuit2" class="text-sm space-y-3 bg-teal-50 p-4 rounded-lg">
                                     <p class="text-base text-center">請點擊「計算與檢核」。</p>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold mb-3 text-center">幹線 & 總開關檢核結果</h3>
                                <div id="resultPanel" class="text-sm space-y-3 bg-slate-100 p-4 rounded-lg">
                                     <p class="text-base text-center">請點擊「計算與檢核」。</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="cases" class="content-section active">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-bold mb-4 text-[#4A6C6F]">設計案例分析</h2>
                    <p class="mb-6 text-slate-700 leading-relaxed">理論結合實踐是最好的學習方式。這裡我們將報告中的三個經典案例數位化，您可以選擇任一案例，點擊「載入參數至計算機」按鈕，系統將自動為您填入該案例的數據，讓您親自驗證壓降計算的過程與結果。</p>
                    
                    <div class="grid md:grid-cols-3 gap-6">
                        <div class="border border-slate-200 p-4 rounded-lg flex flex-col">
                            <h3 class="text-xl font-semibold mb-2">案例一：住宅區迴路</h3>
                            <p class="text-sm text-slate-600 flex-grow">單相三線式(1φ3W) 220V，供應10盞150W LED燈，線長200公尺。挑戰在於長距離下如何選擇合適線徑以符合3%分路壓降限制。</p>
                            <button class="case-loader mt-4 w-full bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700 transition-colors" data-case="1">載入參數至計算機</button>
                        </div>
                        <div class="border border-slate-200 p-4 rounded-lg flex flex-col">
                            <h3 class="text-xl font-semibold mb-2">案例二：主幹道系統</h3>
                            <p class="text-sm text-slate-600 flex-grow">三相四線式(3φ4W) 380/220V，500公尺幹線供應3個控制箱，每個控制箱再接100公尺分路。此案例完美展示了「3%-3%-5%」規則中，總壓降超標的「合規性陷阱」。</p>
                            <button class="case-loader mt-4 w-full bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700 transition-colors" data-case="2">載入參數至計算機</button>
                        </div>
                        <div class="border border-slate-200 p-4 rounded-lg flex flex-col">
                            <h3 class="text-xl font-semibold mb-2">案例三：全功能智慧杆</h3>
                            <p class="text-sm text-slate-600 flex-grow">混合AC/DC負載，包含照明、5G基地台、攝影機等。此案例重點在於功率預算、AC輸入電流計算，以及對敏感電子設備的內部DC壓降校核。</p>
                            <button class="case-loader mt-4 w-full bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700 transition-colors" data-case="3">載入參數至計算機</button>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="summary" class="content-section">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-bold mb-4 text-[#4A6C6F]">設計總結與檢核清單</h2>
                    <p class="mb-6 text-slate-700 leading-relaxed">一個成功的電氣設計是安全、可靠、高效且合規的。在完成您的設計前，請使用以下清單進行最終審核，確保萬無一失。</p>
                    <ul class="space-y-3 text-slate-700">
                        <li class="flex items-start"><span class="mr-3 text-xl text-[#4A6C6F]">✅</span> <strong>單線圖完整性：</strong>所有元件是否已繪製並準確標註規格、尺寸、長度？</li>
                        <li class="flex items-start"><span class="mr-3 text-xl text-[#4A6C6F]">✅</span> <strong>負載計算與平衡：</strong>是否已準確計算總功率？三相系統負載是否已盡可能平衡？</li>
                        <li class="flex items-start"><span class="mr-3 text-xl text-[#4A6C6F]">✅</span> <strong>壓降合規性：</strong>幹線、分路及總壓降是否「同時」滿足法規的「3%-3%-5%」要求？</li>
                        <li class="flex items-start"><span class="mr-3 text-xl text-[#4A6C6F]">✅</span> <strong>保護協調：</strong>斷路器選擇是否同時考慮了負載電流（AT）與短路電流（IC）？</li>
                        <li class="flex items-start"><span class="mr-3 text-xl text-[#4A6C6F]">✅</span> <strong>智慧杆特殊要求：</strong>是否已校核DC壓降？是否已規劃備用電源與獨立計費？</li>
                        <li class="flex items-start"><span class="mr-3 text-xl text-[#4A6C6F]">✅</span> <strong>預留未來容量：</strong>幹線電纜和管道尺寸是否已預留至少25%-50%的擴充裕量？</li>
                    </ul>
                </div>
            </section>

            <section id="supplement" class="content-section">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-bold mb-4 text-[#4A6C6F]">供電系統選擇指南</h2>
                    <p class="mb-6 text-slate-700 leading-relaxed">在電氣系統設計中，選擇正確的供電方式是首要步驟。這個選擇主要取決於**負載的總功率、設備所需的電壓類型、以及對電力傳輸效率的要求**。</p>

                    <div class="space-y-8">
                        <div>
                            <h3 class="text-xl font-semibold mb-3 text-slate-800 border-b pb-2">1. 單相二線式 (1φ2W)</h3>
                            <p class="text-slate-700 mt-3">這是最基礎、最簡單的供電方式。</p>
                            <ul class="mt-4 space-y-2 list-disc list-inside text-slate-600">
                                <li><strong>系統組成:</strong>
                                    <ul class="pl-6 list-['-_'] list-inside">
                                        <li>**110V 系統**: 1條火線 (L) + 1條中性線 (N)。</li>
                                        <li>**220V 系統**: 2條火線 (L1, L2)。</li>
                                    </ul>
                                </li>
                                <li><strong>特性:</strong> 結構簡單，配線最少；僅能提供單一種電壓；適用於功率較小的負載。</li>
                                <li><strong>應用場景:</strong> 單一的家用電器、小功率的照明迴路、獨立的馬達或泵浦（220V）。</li>
                                <li><strong>何時選擇:</strong> 當您的負載很單純，總功率不高（通常在 3kW 以下），並且只需要一種電壓時，這是最經濟的選擇。</li>
                                <li><strong>限制:</strong> 傳輸相同功率時，電流最高，線路壓降和能量損耗最顯著，不適合長距離或大功率傳輸。</li>
                            </ul>
                        </div>

                        <div>
                            <h3 class="text-xl font-semibold mb-3 text-slate-800 border-b pb-2">2. 單相三線式 (1φ3W)</h3>
                            <p class="text-slate-700 mt-3">這是台灣住宅和小型商業場所最標準的供電方式，兼具靈活性與效率。</p>
                             <ul class="mt-4 space-y-2 list-disc list-inside text-slate-600">
                                <li><strong>系統組成:</strong> 2條火線 (L1, L2) + 1條中性線 (N)。</li>
                                <li><strong>提供電壓:</strong>
                                    <ul class="pl-6 list-['-_'] list-inside">
                                        <li>火線 (L1 或 L2) 對 中性線 (N) = **110V**</li>
                                        <li>火線 (L1) 對 火線 (L2) = **220V**</li>
                                    </ul>
                                </li>
                                <li><strong>特性:</strong> 能同時提供兩種電壓，極具彈性；是單相系統中傳輸效率最高的選擇。</li>
                                <li><strong>應用場景:</strong> 所有住宅用戶、小型商店、辦公室、需要220V及110V的路燈控制箱。</li>
                                <li><strong>何時選擇:</strong> 當需要同時使用110V和220V，或負載總功率較大（> 3kW）但未達三相電程度時。</li>
                                <li><strong>核心優勢:</strong> **負載平衡**。若能將110V的負載平均分配，中性線上的電流會趨近於零，大幅降低線路損耗。</li>
                            </ul>
                        </div>

                        <div>
                            <h3 class="text-xl font-semibold mb-3 text-slate-800 border-b pb-2">3. 三相四線式 (3φ4W)</h3>
                            <p class="text-slate-700 mt-3">這是工業和大型商業設施的標準，也是電力傳輸的最高效形式。</p>
                             <ul class="mt-4 space-y-2 list-disc list-inside text-slate-600">
                                <li><strong>系統組成:</strong> 3條火線 (R, S, T) + 1條中性線 (N)。</li>
                                <li><strong>提供電壓 (以380V/220V系統為例):</strong>
                                    <ul class="pl-6 list-['-_'] list-inside">
                                        <li>任一火線 對 中性線 (N) = **220V** (單相電壓)</li>
                                        <li>任二火線 對 火線 = **380V** (三相電壓)</li>
                                    </ul>
                                </li>
                                <li><strong>特性:</strong> 電力輸送最穩定、效率最高；能直接驅動三相馬達。</li>
                                <li><strong>應用場景:</strong> 工廠、大樓、**路燈系統的「幹線」**、大型泵浦或空調。</li>
                                <li><strong>何時選擇:</strong> 當總負載功率非常大（> 10kW）、有三相設備需求、或需長距離電力輸送時。</li>
                                <li><strong>核心優勢:</strong> **高傳輸效率與負載平衡**。將單相負載（如路燈控制箱）均勻分配到三相上，可最大化傳輸效率。</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="mt-8 pt-8 border-t border-slate-200">
                        <h2 class="text-2xl font-bold mb-4 text-[#4A6C6F]">壓降計算機之計算原理</h2>
                        <p class="mb-6 text-slate-700 leading-relaxed">本指南中的互動式壓降計算機，是基於專業電工法規所要求的精確阻抗法進行計算。其核心公式與計算步驟如下，了解其組成有助於您更深入地運用此工具。</p>
                        
                        <div class="p-4 bg-slate-100 rounded-lg text-center mb-6">
                            <code class="text-sm md:text-base text-slate-800 font-mono">VD = K1 × I × L × (R × cosθ + X × sinθ)</code>
                        </div>

                        <div class="space-y-6">
                            <div>
                                <h4 class="font-semibold text-lg text-slate-800">第一步：計算設計電流 (I)</h4>
                                <p class="text-slate-600">根據您輸入的總負載功率(P)、標稱電壓(V)及功率因數(PF)，計算出迴路上的設計電流(A)。</p>
                                <p class="mt-2 p-2 bg-slate-50 rounded"><code class="font-mono">I = P / (V × PF)</code></p>
                            </div>
                             <div>
                                <h4 class="font-semibold text-lg text-slate-800">第二步：查找導線參數 (R & X)</h4>
                                <p class="text-slate-600">當您選擇導線截面積時，計算機會從內建的資料表中，自動查找出對應線徑每公里(km)的交流電阻(R)與電抗(X)值。</p>
                            </div>
                            <div>
                                <h4 class="font-semibold text-lg text-slate-800">第三步：計算有效阻抗 (Rcosθ + Xsinθ)</h4>
                                <p class="text-slate-600">此部分是壓降公式的核心，它綜合了導線的電阻(R)、電抗(X)以及負載的功率因數(cosθ)，計算出實際影響壓降的有效阻抗值。</p>
                                 <ul class="pl-6 list-disc list-inside text-slate-600 mt-2">
                                    <li><code class="font-mono bg-slate-100 px-1 rounded">cosθ</code> 即為您輸入的功率因數(PF)。</li>
                                    <li><code class="font-mono bg-slate-100 px-1 rounded">sinθ</code> 則由三角函數公式 <code class="font-mono bg-slate-100 px-1 rounded">√(1 - cosθ²)</code> 自動算出。</li>
                                </ul>
                            </div>
                             <div>
                                <h4 class="font-semibold text-lg text-slate-800">第四步：計算總電壓降 (VD)</h4>
                                <p class="text-slate-600">將前述所有參數代入核心公式，計算出最終的電壓下降數值，單位為伏特(V)。其中系統係數(K1)會根據您選擇的供電方式自動設定：</p>
                                <ul class="pl-6 list-disc list-inside text-slate-600 mt-2">
                                    <li><strong>單相二線式 (1φ2W):</strong> K1 = 2 (計算來回兩條線)</li>
                                    <li><strong>單相三線式 (1φ3W):</strong> K1 = 1 (假設負載平衡)</li>
                                    <li><strong>三相四線式 (3φ4W):</strong> K1 = 1 (計算線對中性線)</li>
                                </ul>
                            </div>
                             <div>
                                <h4 class="font-semibold text-lg text-slate-800">第五步：換算為百分比 (VD%)</h4>
                                <p class="text-slate-600">最後，計算機將VD(伏特)換算為壓降百分比，並以圖表呈現，讓您能直觀地與3%及5%的法規限制進行比較。</p>
                                <p class="mt-2 p-2 bg-slate-50 rounded"><code class="font-mono">VD% = (VD / 標稱電壓) × 100%</code></p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-8 pt-8 border-t border-slate-200">
                        <h2 class="text-2xl font-bold mb-4 text-[#4A6C6F]">電氣設計檢核指南</h2>
                        <p class="mb-6 text-slate-700 leading-relaxed">在完成負載電流與壓降計算後，下一步是利用這些數據來檢核或選定最合適的導線線徑與保護裝置。此檢核過程需同時滿足**法規要求、安全裕度、以及保護協調**三大原則。</p>
                        <div class="space-y-8">
                            <div>
                                <h3 class="text-xl font-semibold mb-3 text-slate-800 border-b pb-2">1. 導線線徑 (Wire Size) 之檢核</h3>
                                <p class="mt-4 text-slate-600">導線線徑的選擇必須通過以下**兩項關鍵檢核**，缺一不可：</p>
                                <div class="mt-4 space-y-4">
                                    <div class="p-4 border-l-4 border-sky-500 bg-sky-50">
                                        <h4 class="font-bold text-sky-800">✅ 檢核項目一：壓降 (Voltage Drop)</h4>
                                        <p class="mt-1 text-slate-700">這是性能上的首要檢核。若計算出的壓降百分比 > 法規限制 (分路3%, 總和5%) → **不合格**。必須**加大線徑**後重新計算。</p>
                                    </div>
                                    <div class="p-4 border-l-4 border-sky-500 bg-sky-50">
                                        <h4 class="font-bold text-sky-800">✅ 檢核項目二：安全電流 (Ampacity)</h4>
                                        <p class="mt-1 text-slate-700">這是確保導線不會過熱的**絕對安全底線**。所選線徑的「額定安全電流」必須大於迴路的「設計電流」。若安全電流 < 設計電流 → **不合格**，必須加大線徑。</p>
                                    </div>
                                </div>
                            </div>
                             <div>
                                <h3 class="text-xl font-semibold mb-3 text-slate-800 border-b pb-2">2. 漏電斷路器 (ELCB) 之檢核</h3>
                                <div class="mt-4 space-y-4">
                                    <div class="p-4 border-l-4 border-amber-500 bg-amber-50">
                                        <h4 class="font-bold text-amber-800">✅ 檢核項目一：額定電流 (AT - Ampere Trip)</h4>
                                        <p class="mt-1 text-slate-700">確保斷路器能穩定運作並提供過載保護。常用準則: `AT ≥ 設計電流 (I) × 1.25`。應選擇大於計算值且最接近的標準AT值。</p>
                                    </div>
                                    <div class="p-4 border-l-4 border-amber-500 bg-amber-50">
                                        <h4 class="font-bold text-amber-800">✅ 檢核項目二：額定感度電流 (mA)</h4>
                                        <p class="mt-1 text-slate-700">決定漏電保護的靈敏度。**戶外路燈建議優先選用 30mA (高靈敏度)**，以提供最佳人身安全保護。</p>
                                    </div>
                                </div>
                            </div>
                             <div>
                                <h3 class="text-xl font-semibold mb-3 text-slate-800 border-b pb-2">3. 無熔絲開關 (NFB / MCCB) 之檢核</h3>
                                <div class="mt-4 space-y-4">
                                    <div class="p-4 border-l-4 border-rose-500 bg-rose-50">
                                        <h4 class="font-bold text-rose-800">✅ 檢核項目一：額定電流 (AT - Ampere Trip)</h4>
                                        <p class="mt-1 text-slate-700">檢核方式與 ELCB 完全相同。</p>
                                    </div>
                                    <div class="p-4 border-l-4 border-rose-500 bg-rose-50">
                                        <h4 class="font-bold text-rose-800">✅ 檢核項目二：啟斷容量 (IC - Interrupting Capacity)</h4>
                                        <p class="mt-1 text-slate-700">**最重要的安全檢核**。NFB的啟斷容量(kA)必須**大於**其安裝點的「預期最大短路電流」。若 IC < 預期短路電流 → **絕對不合格**，為極度危險的設計錯誤。</p>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-xl font-semibold mb-3 text-slate-800 border-b pb-2">4. 匯流排 (Busbar) 之設計檢核</h3>
                                <div class="mt-4 space-y-4">
                                    <div class="p-4 border-l-4 border-indigo-500 bg-indigo-50">
                                        <h4 class="font-bold text-indigo-800">✅ 檢核項目：載流量 (Ampacity)</h4>
                                        <p class="mt-1 text-slate-700">匯流排的載流量必須大於總開關(NFB)的額定電流(AT)。一個常用的經驗法則是，銅匯流排每 mm² 約可承載 2A 電流。因此，`(寬度 × 厚度 × 2) > NFB AT`。</p>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-xl font-semibold mb-3 text-slate-800 border-b pb-2">5. 接地電阻 (Grounding Resistance) 之設計考量</h3>
                                <div class="mt-4 space-y-4">
                                    <div class="p-4 border-l-4 border-emerald-500 bg-emerald-50">
                                        <h4 class="font-bold text-emerald-800">✅ 檢核項目：電阻值 (R)</h4>
                                        <p class="mt-1 text-slate-700">接地電阻的目標是提供一條極低阻抗的故障電流路徑。其要求依「對地電壓」而定：</p>
                                        <ul class="list-disc list-inside mt-2 text-slate-700 pl-4">
                                            <li>對地電壓 150V 以下：電阻應在 **100Ω 以下**。</li>
                                            <li>對地電壓 151V 至 300V：電阻應在 **50Ω 以下**。</li>
                                            <li>對地電壓 301V 以上：電阻應在 **10Ω 以下**。</li>
                                        </ul>
                                        <p class="mt-2 text-slate-700">此數值需透過接地電阻計實際量測，若不符合，則需增加接地棒數量或使用接地改善劑。</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const tabs = document.querySelectorAll('.nav-tab');
            const sections = document.querySelectorAll('.content-section');
            const calculateBtn = document.getElementById('calculateBtn');
            const sldHighlights = document.querySelectorAll('.sld-highlight');
            const sldDiagramComponents = document.querySelectorAll('#sld-diagram .sld-component');
            const caseLoaders = document.querySelectorAll('.case-loader');

            const wireData = {
                '3.5': { R: 6.79, X: 0.095, ampacity: 30 },
                '5.5': { R: 4.31, X: 0.091, ampacity: 40 },
                '8': { R: 2.98, X: 0.088, ampacity: 50 },
                '14': { R: 1.68, X: 0.083, ampacity: 75 },
                '22': { R: 1.06, X: 0.080, ampacity: 100 },
                '38': { R: 0.618, X: 0.077, ampacity: 135 },
            };

            const sldDescriptions = {
                'power-source': '<strong>電源:</strong> 標示電力公司的供電點、電壓等級（如 1φ2W 220V）及系統頻率。這是整個系統的起點。',
                'breaker': '<strong>主斷路器:</strong> 總開關 (NFB)，保護整個系統免於過載和短路。此案例為 30A/50AF。',
                'feeder': '<strong>幹線電纜:</strong> 從電源接戶點到控制箱的主電纜。此案例使用 22mm² XLPE 電纜。',
                'control-box': '<strong>控制箱 (L1):</strong> 包含分路保護裝置的箱體，是電力分配的核心。',
                'branch-breaker': '<strong>分路斷路器:</strong> 保護單一照明迴路的漏電斷路器 (ELCB)。此案例為 15A/50AF，感度100mA。',
                'branch-circuit': '<strong>分路電纜:</strong> 從控制箱連接至末端路燈的線路。此案例使用 8mm² XLPE 電纜。',
                'load': '<strong>負載:</strong> 指路燈本身。此案例每個迴路供應5支72W雙臂路燈，總計720W。'
            };
            
            function setActiveTab(tab) {
                tabs.forEach(t => {
                    t.classList.remove('tab-active');
                    t.classList.add('tab-inactive');
                });
                tab.classList.add('tab-active');
                tab.classList.remove('tab-inactive');
            }

            function showSection(tabId) {
                sections.forEach(section => {
                    if (section.id === tabId) {
                        section.classList.add('active');
                    } else {
                        section.classList.remove('active');
                    }
                });
            }
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.dataset.tab;
                    setActiveTab(tab);
                    showSection(tabId);
                });
            });

            function updateSLD() {
                const systemType = document.getElementById('systemType').options[document.getElementById('systemType').selectedIndex].text;
                const voltage = parseFloat(document.getElementById('voltage').value);
                document.getElementById('sld_power_source').textContent = `${systemType} ${voltage}V 供電`;

                const feederWire = document.getElementById('checkWireSize_feeder').value;
                document.getElementById('sld_feeder_wire').textContent = `XLPE, ${feederWire}-2/C`;

                const nfbAT = document.getElementById('checkNfbAT').value;
                document.getElementById('sld_main_nfb_at').textContent = `${nfbAT} AT`;
                
                const busbarSize = document.getElementById('busbarSize').value;
                document.getElementById('sld_busbar_size').textContent = `CU BUS BAR ${busbarSize}mm`;

                let groundingTarget = 50;
                if (voltage <= 150) { groundingTarget = 100; }
                else if (voltage >= 301) { groundingTarget = 10; }
                document.getElementById('sld_grounding_resistance').textContent = `R≤${groundingTarget}Ω`;

                const wire1 = document.getElementById('checkWireSize1').value;
                const elcb1 = document.getElementById('checkElcbAT1').value;
                const power1 = document.getElementById('power1').value;
                document.getElementById('sld_branch1_wire').textContent = `XLPE, ${wire1}-2/C`;
                document.getElementById('sld_branch1_elcb_at').textContent = `${elcb1} AT`;
                document.getElementById('sld_branch1_load').textContent = `總負載: ${power1} W`;

                const wire2 = document.getElementById('checkWireSize2').value;
                const elcb2 = document.getElementById('checkElcbAT2').value;
                const power2 = document.getElementById('power2').value;
                document.getElementById('sld_branch2_wire').textContent = `XLPE, ${wire2}-2/C`;
                document.getElementById('sld_branch2_elcb_at').textContent = `${elcb2} AT`;
                document.getElementById('sld_branch2_load').textContent = `總負載: ${power2} W`;
            }

            if (calculateBtn) {
                calculateBtn.addEventListener('click', () => {
                    const systemType = document.getElementById('systemType').value;
                    const V = parseFloat(document.getElementById('voltage').value);
                    
                    // --- Feeder Data ---
                    const L_feeder_m = parseFloat(document.getElementById('length_feeder').value);
                    const checkWire_feeder = document.getElementById('checkWireSize_feeder').value;

                    // --- Circuit 1 Data ---
                    const P1 = parseFloat(document.getElementById('power1').value);
                    const pf1 = parseFloat(document.getElementById('pf1').value);
                    const L1_m = parseFloat(document.getElementById('length1').value);
                    const checkWire1 = document.getElementById('checkWireSize1').value;
                    const checkElcbAT1 = parseFloat(document.getElementById('checkElcbAT1').value);

                    // --- Circuit 2 Data ---
                    const P2 = parseFloat(document.getElementById('power2').value);
                    const pf2 = parseFloat(document.getElementById('pf2').value);
                    const L2_m = parseFloat(document.getElementById('length2').value);
                    const checkWire2 = document.getElementById('checkWireSize2').value;
                    const checkElcbAT2 = parseFloat(document.getElementById('checkElcbAT2').value);
                    
                    // --- Panel Data ---
                    const busbarSize = document.getElementById('busbarSize').value.split('x');
                    const busbarWidth = parseFloat(busbarSize[0]);
                    const busbarThickness = parseFloat(busbarSize[1]);
                    const groundingResistance = parseFloat(document.getElementById('groundingResistance').value);
                    const checkNfbAT = parseFloat(document.getElementById('checkNfbAT').value);
                    const checkNfbIC = parseFloat(document.getElementById('checkNfbIC').value);
                    const shortCircuit = parseFloat(document.getElementById('shortCircuitCurrent').value);

                    function calculateVD(I, pf, L_m, checkWire) {
                        if (!V || !I || !pf || !L_m || !checkWire) return null;
                        const L_km = L_m / 1000;
                        const R = wireData[checkWire].R;
                        const X = wireData[checkWire].X;
                        const ampacity = wireData[checkWire].ampacity;
                        const sin_theta = Math.sqrt(1 - pf * pf);
                        const effective_z = (R * pf + X * sin_theta);
                        let V_base = V;
                        let K1 = 1;
                        if (systemType === '1p2w') { K1 = 2; }
                        const VD = K1 * I * L_km * effective_z;
                        const VD_percent = (VD / V_base) * 100;
                        return { VD_percent, ampacity };
                    }
                    
                    const I1 = (P1 && V && pf1) ? P1 / (V * pf1) : 0;
                    const I2 = (P2 && V && pf2) ? P2 / (V * pf2) : 0;
                    const total_I = I1 + I2;
                    
                    const result1 = calculateVD(I1, pf1, L1_m, checkWire1);
                    const result2 = calculateVD(I2, pf2, L2_m, checkWire2);
                    const pf_avg = (pf1 * I1 + pf2 * I2) / total_I || 0.9; // Weighted average PF
                    const result_feeder = calculateVD(total_I, pf_avg, L_feeder_m, checkWire_feeder);

                    function displayBranchResults(result, containerId, circuitNum, feeder_vd_percent) {
                        const container = document.getElementById(containerId);
                        const P = circuitNum === 1 ? P1 : P2;
                        const I = circuitNum === 1 ? I1 : I2;
                        const checkElcbAT = circuitNum === 1 ? checkElcbAT1 : checkElcbAT2;

                        if (!result || !P) {
                            container.innerHTML = '<p class="text-base text-center text-red-500">請輸入完整的迴路參數。</p>';
                            return;
                        }

                        const total_vd_percent = feeder_vd_percent + result.VD_percent;
                        
                        let branchVdCheckHTML = result.VD_percent <= 3 ? '<span class="font-bold text-green-600">合格 (≤3%)</span>' : '<span class="font-bold text-red-600">不合格 (>3%)</span>';
                        let totalVdCheckHTML = total_vd_percent <= 5 ? '<span class="font-bold text-green-600">合格 (≤5%)</span>' : '<span class="font-bold text-red-600">不合格 (>5%)</span>';
                        let ampacityCheckHTML = result.ampacity > I ? '<span class="font-bold text-green-600">合格</span>' : `<span class="font-bold text-red-600">不合格</span>`;
                        
                        const recommendedElcbAT = I * 1.25;
                        let elcbAtCheckHTML;
                        if (checkElcbAT < I) { elcbAtCheckHTML = '<span class="font-bold text-red-600">不合格 (AT過低)</span>'; }
                        else if (checkElcbAT < recommendedElcbAT) { elcbAtCheckHTML = '<span class="font-bold text-amber-600">注意 (裕度不足)</span>'; }
                        else if (checkElcbAT > result.ampacity) { elcbAtCheckHTML = '<span class="font-bold text-red-600">不合格 (無法保護線纜)</span>'; }
                        else { elcbAtCheckHTML = '<span class="font-bold text-green-600">合格</span>'; }

                        container.innerHTML = `
                            <p class="verification-grid"><span>設計電流 I:</span> <strong>${I.toFixed(2)} A</strong> <span></span></p>
                            <hr class="col-span-3 my-1">
                            <p class="verification-grid"><span>分路壓降 VD%:</span> <strong class="${result.VD_percent > 3 ? 'text-red-600' : 'text-green-600'}">${result.VD_percent.toFixed(2)} %</strong> ${branchVdCheckHTML}</p>
                            <p class="verification-grid"><span>總壓降 VD%:</span> <strong class="${total_vd_percent > 5 ? 'text-red-600' : 'text-green-600'}">${total_vd_percent.toFixed(2)} %</strong> ${totalVdCheckHTML}</p>
                             <p class="verification-grid"><span></span> <small class="text-slate-500 col-span-2">(幹線 ${feeder_vd_percent.toFixed(2)}% + 分路 ${result.VD_percent.toFixed(2)}%)</small> <span></span></p>
                            <hr class="col-span-3 my-1">
                            <p class="verification-grid"><span>線徑安全電流:</span> <span>${result.ampacity}A > ${I.toFixed(2)}A</span> ${ampacityCheckHTML}</p>
                            <hr class="col-span-3 my-1">
                            <p class="verification-grid"><span>ELCB AT 檢核:</span> <span>選用 ${checkElcbAT}A</span> ${elcbAtCheckHTML}</p>
                            <p class="verification-grid"><span></span> <small class="text-slate-500 col-span-2">建議值 ≥ ${recommendedElcbAT.toFixed(2)}A</small> <span></span></p>
                        `;
                    }

                    const feeder_vd_percent = result_feeder ? result_feeder.VD_percent : 0;
                    displayBranchResults(result1, 'resultCircuit1', 1, feeder_vd_percent);
                    displayBranchResults(result2, 'resultCircuit2', 2, feeder_vd_percent);

                    // Panel Verification
                    const panelResultDiv = document.getElementById('resultPanel');
                    if(result_feeder) {
                        const recommendedNfbAT = total_I * 1.25;
                        const busbarArea = busbarWidth * busbarThickness;
                        const busbarAmpacity = busbarArea * 2; // Rule of thumb: 2A/mm^2

                        let feederVdCheckHTML = result_feeder.VD_percent <= 3 ? '<span class="font-bold text-green-600">合格 (≤3%)</span>' : '<span class="font-bold text-red-600">不合格 (>3%)</span>';
                        let nfbAtCheckHTML;
                        if (checkNfbAT < total_I) { nfbAtCheckHTML = '<span class="font-bold text-red-600">不合格 (AT過低)</span>'; }
                        else if (checkNfbAT < recommendedNfbAT) { nfbAtCheckHTML = '<span class="font-bold text-amber-600">注意 (裕度不足)</span>'; }
                        else { nfbAtCheckHTML = '<span class="font-bold text-green-600">合格</span>'; }

                        let icCheckHTML = checkNfbIC > shortCircuit ? '<span class="font-bold text-green-600">合格</span>' : '<span class="font-bold text-red-600">不合格 (IC不足)</span>';
                        let busbarCheckHTML = busbarAmpacity > checkNfbAT ? '<span class="font-bold text-green-600">合格</span>' : '<span class="font-bold text-red-600">不合格</span>';
                        
                        let groundingTargetResistance = 50;
                        if (V <= 150) { groundingTargetResistance = 100; }
                        else if (V >= 301) { groundingTargetResistance = 10; }
                        let groundingCheckHTML = groundingResistance <= groundingTargetResistance ? '<span class="font-bold text-green-600">合格</span>' : `<span class="font-bold text-red-600">不合格 (R > ${groundingTargetResistance}Ω)</span>`;


                        panelResultDiv.innerHTML = `
                            <p class="verification-grid"><span>總設計電流:</span> <strong>${total_I.toFixed(2)} A</strong> <span></span></p>
                            <p class="verification-grid"><span>幹線壓降 VD%:</span> <strong class="${result_feeder.VD_percent > 3 ? 'text-red-600' : 'text-green-600'}">${result_feeder.VD_percent.toFixed(2)} %</strong> ${feederVdCheckHTML}</p>
                            <hr class="col-span-3 my-1">
                            <p class="verification-grid"><span>NFB AT 檢核:</span> <span>選用 ${checkNfbAT}A</span> ${nfbAtCheckHTML}</p>
                            <p class="verification-grid"><span></span> <small class="text-slate-500 col-span-2">建議值 ≥ ${recommendedNfbAT.toFixed(2)}A</small> <span></span></p>
                             <p class="verification-grid"><span>NFB IC 檢核:</span> <span>${checkNfbIC}kA > ${shortCircuit}kA</span> ${icCheckHTML}</p>
                             <hr class="col-span-3 my-1">
                             <p class="verification-grid"><span>匯流排載流量:</span> <span>${busbarAmpacity.toFixed(0)}A > ${checkNfbAT}A</span> ${busbarCheckHTML}</p>
                             <p class="verification-grid"><span>接地電阻檢核:</span> <span>${groundingResistance}Ω ≤ ${groundingTargetResistance}Ω</span> ${groundingCheckHTML}</p>
                        `;

                    } else {
                        panelResultDiv.innerHTML = '<p class="text-base text-center">請先完成所有迴路計算。</p>';
                    }
                    updateSLD();
                });
            }

            sldHighlights.forEach(btn => {
                btn.addEventListener('click', () => {
                    const componentId = btn.dataset.component;
                    sldHighlights.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    sldDiagramComponents.forEach(comp => {
                        const group = comp.closest('.sld-component');
                        if (group && group.dataset.id === componentId) {
                           group.style.opacity = '1';
                           group.querySelectorAll('rect, circle, path').forEach(shape => {
                               if(shape.getAttribute('fill') !== '#334155') shape.style.fill = 'rgba(74, 108, 111, 0.2)'
                           });
                        } else if (group) {
                           group.style.opacity = '0.7';
                           group.querySelectorAll('rect, circle, path').forEach(shape => {
                               if(shape.getAttribute('fill') !== '#334155') shape.style.fill = '#f1f5f9'
                           });
                        }
                    });
                });
            });

            caseLoaders.forEach(button => {
                button.addEventListener('click', () => {
                    const caseNum = button.dataset.case;
                    
                    if (caseNum === '1') {
                        document.getElementById('power1').value = 1500;
                        document.getElementById('pf1').value = 0.95;
                        document.getElementById('length1').value = 200;
                        document.getElementById('checkWireSize1').value = '8';
                        document.getElementById('checkElcbAT1').value = '15';
                    } else if (caseNum === '2') {
                         document.getElementById('length_feeder').value = 500;
                         document.getElementById('checkWireSize_feeder').value = '38';
                         document.getElementById('power1').value = 2500;
                         document.getElementById('pf1').value = 0.8;
                         document.getElementById('length1').value = 100;
                         document.getElementById('checkWireSize1').value = '5.5';
                         document.getElementById('checkElcbAT1').value = '20';
                    } else if (caseNum === '3') {
                        document.getElementById('power1').value = 644.4;
                        document.getElementById('pf1').value = 0.95;
                        document.getElementById('length1').value = 100;
                        document.getElementById('checkWireSize1').value = '3.5';
                        document.getElementById('checkElcbAT1').value = '15';
                    }
                    
                    const calculatorTab = document.querySelector('.nav-tab[data-tab="calculator"]');
                    setActiveTab(calculatorTab);
                    showSection('calculator');
                    if (calculateBtn) {
                        calculateBtn.click();
                    }
                    window.scrollTo({ top: calculatorTab.offsetTop, behavior: 'smooth' });
                });
            });
            updateSLD();
        });
    </script>
</body>
</html>
