<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACI 318-19 I形梁彎矩、剪力與慣性矩計算工具 (台灣單位版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- KaTeX for beautiful math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" xintegrity="sha384-n8MVd4RsNIU0KOVEMmg9ikOAiqPpbleCACPUPotA27Kk2zmj/5uCYMWYCsgpLotx" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" xintegrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" xintegrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
    
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            scroll-behavior: smooth;
        }
        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
        }
        .input-item {
            display: flex;
            flex-direction: column;
        }
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .result-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <!-- 標題 -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">I形梁彎矩、剪力與慣性矩計算器</h1>
            <p class="mt-2 text-lg text-gray-600">依據 ACI 318-19 規範</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <!-- 左側：輸入參數 -->
            <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-2xl font-bold mb-6 border-b pb-3 text-blue-700">1. 輸入參數</h2>
                
                <form id="beam-form">
                    <!-- 幾何尺寸 -->
                    <fieldset class="mb-6"><legend class="text-xl font-semibold mb-4 text-gray-700">1.1 梁斷面幾何尺寸 (cm)</legend>
                        <div class="input-group">
                            <div class="input-item"><label for="b_f_top" class="text-sm font-medium text-gray-600 mb-1">上翼版寬度 ($b_{f,top}$)</label><input type="number" step="1" id="b_f_top" value="60" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></div>
                            <div class="input-item"><label for="h_f_top" class="text-sm font-medium text-gray-600 mb-1">上翼版厚度 ($h_{f,top}$)</label><input type="number" step="1" id="h_f_top" value="15" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></div>
                            <div class="input-item"><label for="b_w" class="text-sm font-medium text-gray-600 mb-1">腹版寬度 ($b_w$)</label><input type="number" step="1" id="b_w" value="15" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></div>
                            <div class="input-item"><label for="h" class="text-sm font-medium text-gray-600 mb-1">梁總深度 ($h$)</label><input type="number" step="1" id="h" value="100" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></div>
                            <div class="input-item"><label for="h_f_bot" class="text-sm font-medium text-gray-600 mb-1">下翼版厚度 ($h_{f,bot}$)</label><input type="number" step="1" id="h_f_bot" value="20" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></div>
                            <div class="input-item"><label for="b_f_bot" class="text-sm font-medium text-gray-600 mb-1">下翼版寬度 ($b_{f,bot}$)</label><input type="number" step="1" id="b_f_bot" value="40" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></div>
                        </div>
                    </fieldset>
                    <!-- 材料性質 -->
                    <fieldset class="mb-6"><legend class="text-xl font-semibold mb-4 text-gray-700">1.2 材料性質 (kgf/cm²)</legend>
                        <div class="input-group">
                            <div class="input-item"><label for="fc_prime" class="text-sm font-medium text-gray-600 mb-1">混凝土抗壓強度 $f'_c$</label><input type="number" step="1" id="fc_prime" value="350" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></div>
                            <div class="input-item"><label for="fy" class="text-sm font-medium text-gray-600 mb-1">鋼筋降伏強度 $f_y$</label><input type="number" step="1" id="fy" value="4200" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></div>
                            <div class="input-item"><label for="fpu" class="text-sm font-medium text-gray-600 mb-1">預力鋼鍵極限強度 $f_{pu}$</label><input type="number" step="1" id="fpu" value="18600" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></div>
                        </div>
                    </fieldset>
                    <!-- 彎矩鋼筋 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-6">
                        <fieldset><legend class="text-xl font-semibold mb-4 text-gray-700">1.3 壓力鋼筋</legend>
                            <div class="space-y-4">
                                <div class="input-item"><label for="As_prime" class="text-sm font-medium text-gray-600 mb-1">總面積 $A'_s$ (cm²)</label><input type="number" step="1" id="As_prime" value="6" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></div>
                                <div class="input-item"><label for="d_prime" class="text-sm font-medium text-gray-600 mb-1">至頂面距離 $d'$ (cm)</label><input type="number" step="0.1" id="d_prime" value="7.5" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></div>
                            </div>
                        </fieldset>
                        <fieldset><legend class="text-xl font-semibold mb-4 text-gray-700">1.4 拉力鋼筋</legend>
                            <div class="space-y-4">
                                <div class="input-item"><label for="As" class="text-sm font-medium text-gray-600 mb-1">總面積 $A_s$ (cm²)</label><input type="number" step="1" id="As" value="20" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></div>
                                <div class="input-item"><label for="d" class="text-sm font-medium text-gray-600 mb-1">至頂面距離 $d$ (cm)</label><input type="number" step="1" id="d" value="90" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></div>
                            </div>
                        </fieldset>
                    </div>
                     <!-- 預力與剪力鋼筋 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-6">
                        <fieldset><legend class="text-xl font-semibold mb-4 text-gray-700">1.5 預力鋼鍵</legend>
                             <div class="space-y-4">
                                <div class="input-item"><label for="Aps" class="text-sm font-medium text-gray-600 mb-1">總面積 $A_{ps}$ (cm²)</label><input type="number" step="1" id="Aps" value="15" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></div>
                                <div class="input-item"><label for="dp" class="text-sm font-medium text-gray-600 mb-1">至頂面距離 $d_p$ (cm)</label><input type="number" step="1" id="dp" value="85" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></div>
                                <div class="input-item"><label for="fse" class="text-sm font-medium text-gray-600 mb-1">有效應力 $f_{se}$ (kgf/cm²)</label><input type="number" step="1" id="fse" value="11000" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></div>
                            </div>
                        </fieldset>
                         <fieldset><legend class="text-xl font-semibold mb-4 text-gray-700">1.6 剪力鋼筋</legend>
                             <div class="space-y-4">
                                <div class="input-item"><label for="Av" class="text-sm font-medium text-gray-600 mb-1">剪力筋面積 $A_{v}$ (cm²)</label><input type="number" step="0.1" id="Av" value="1.42" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></div>
                                <div class="input-item"><label for="fyt" class="text-sm font-medium text-gray-600 mb-1">剪力筋降伏強度 $f_{yt}$ (kgf/cm²)</label><input type="number" step="1" id="fyt" value="2800" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></div>
                                <div class="input-item"><label for="s" class="text-sm font-medium text-gray-600 mb-1">剪力筋間距 $s$ (cm)</label><input type="number" step="1" id="s" value="15" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></div>
                            </div>
                        </fieldset>
                    </div>

                    <!-- 操作按鈕 -->
                    <div class="mt-8">
                        <button type="submit" id="calculate-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-300 ease-in-out">
                            計算斷面強度
                        </button>
                    </div>
                </form>
            </div>

            <!-- 右側：計算結果 -->
            <div class="lg:col-span-2 space-y-8">
                <div class="bg-white p-6 rounded-xl shadow-md h-fit">
                    <!-- 示意圖區塊 -->
                    <div class="mb-6 p-2 bg-gray-100 rounded-lg flex justify-center items-center border">
                        <svg id="beam-diagram" width="100%" viewBox="0 0 450 400"></svg>
                    </div>

                    <!-- 斷面性質 -->
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold mb-4 border-b pb-3 text-gray-700">2. 斷面性質</h2>
                        <div id="geometry-results-container" class="space-y-2">
                             <div class="result-item"><span class="font-semibold text-gray-700">斷面面積 ($A_g$)</span><span id="result_Ag" class="font-mono text-lg font-bold text-gray-900">-- cm²</span></div>
                             <div class="result-item"><span class="font-semibold text-gray-700">斷面慣性矩 ($I_g$)</span><span id="result_Ig" class="font-mono text-lg font-bold text-gray-900">-- cm⁴</span></div>
                             <div class="result-item"><span class="font-semibold text-gray-700">迴轉半徑 ($r$)</span><span id="result_r" class="font-mono text-lg font-bold text-gray-900">-- cm</span></div>
                        </div>
                    </div>
                    
                    <!-- 彎矩強度 -->
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold mb-4 border-b pb-3 text-green-700">3. 彎矩強度結果</h2>
                        <div id="flexure-results-container" class="space-y-2">
                            <div class="result-item"><span class="font-semibold text-gray-700">中性軸深度 ($c$)</span><span id="result_c" class="font-mono text-lg font-bold text-gray-900">-- cm</span></div>
                            <div class="result-item"><span class="font-semibold text-gray-700">極限拉力應變 ($\epsilon_t$)</span><span id="result_epsilon_t" class="font-mono text-lg font-bold text-gray-900">--</span></div>
                            <div class="result-item"><span class="font-semibold text-gray-700">強度折減係數 ($\phi_b$)</span><span id="result_phi" class="font-mono text-lg font-bold text-gray-900">--</span></div>
                            <div class="result-item bg-blue-50 rounded-md"><span class="font-bold text-blue-800">標稱彎矩強度 ($M_n$)</span><span id="result_Mn" class="font-mono text-xl font-extrabold text-blue-800">-- tf-m</span></div>
                            <div class="result-item bg-green-50 rounded-md"><span class="font-bold text-green-800">設計彎矩強度 ($\phi_b M_n$)</span><span id="result_phiMn" class="font-mono text-xl font-extrabold text-green-800">-- tf-m</span></div>
                        </div>
                    </div>
                    
                     <!-- 剪力強度 -->
                    <div>
                        <h2 class="text-2xl font-bold mb-4 border-b pb-3 text-red-700">4. 剪力強度結果</h2>
                        <div id="shear-results-container" class="space-y-2">
                            <div class="result-item"><span class="font-semibold text-gray-700">強度折減係數 ($\phi_v$)</span><span id="result_phi_v" class="font-mono text-lg font-bold text-gray-900">--</span></div>
                            <div class="result-item"><span class="font-semibold text-gray-700">混凝土剪力強度 ($V_c$)</span><span id="result_Vc" class="font-mono text-lg font-bold text-gray-900">-- tf</span></div>
                            <div class="result-item"><span class="font-semibold text-gray-700">鋼筋剪力強度 ($V_s$)</span><span id="result_Vs" class="font-mono text-lg font-bold text-gray-900">-- tf</span></div>
                            <div class="result-item bg-red-50 rounded-md"><span class="font-bold text-red-800">標稱剪力強度 ($V_n$)</span><span id="result_Vn" class="font-mono text-xl font-extrabold text-red-800">-- tf</span></div>
                            <div class="result-item bg-purple-50 rounded-md"><span class="font-bold text-purple-800">設計剪力強度 ($\phi_v V_n$)</span><span id="result_phiVn" class="font-mono text-xl font-extrabold text-purple-800">-- tf</span></div>
                        </div>
                    </div>
                </div>
                <div id="error-container" class="mt-4 p-4 text-red-700 bg-red-100 border border-red-400 rounded-md hidden"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            renderMathInElement(document.body, { delimiters: [{left: "$$", right: "$$", display: true}, {left: "$", right: "$", display: false}] });
            runCalculation();
        });

        document.getElementById('beam-form').addEventListener('submit', function(event) {
            event.preventDefault();
            runCalculation();
        });
        
        // --- 主計算函數 ---
        function runCalculation() {
            document.getElementById('error-container').classList.add('hidden');
            document.getElementById('error-container').textContent = '';

            const si_inputs = getAndConvertInputs();
            const raw_inputs = getRawInputs();
            if (!si_inputs || !raw_inputs) return;
            
            updateDiagram(raw_inputs);

            // --- 斷面性質計算 ---
            const geometryResults = calculateSectionProperties(raw_inputs);
            displayGeometryResults(geometryResults);

            // --- 彎矩強度計算 ---
            const flexureResults = calculateFlexureStrength(si_inputs);
            if(flexureResults) {
                displayFlexureResults(flexureResults);
            }

            // --- 剪力強度計算 ---
            const shearResults = calculateShearStrength(si_inputs);
            if(shearResults) {
                displayShearResults(shearResults);
            }
        }
        
        function calculateSectionProperties(inputs) {
            // 使用原始輸入(cm)進行幾何計算
            const { b_f_top, h_f_top, b_w, h, h_f_bot, b_f_bot } = inputs;
            const h_w = h - h_f_top - h_f_bot; // 腹版高度

            if (h_w < 0) return { Ig_cm4: 0, Ag_cm2: 0, r_cm: 0 }; // 避免幾何錯誤

            // 將斷面分為三塊：上翼版、腹版、下翼版
            const parts = [
                { name: 'top_flange', A: b_f_top * h_f_top, y_bar: h_f_top / 2 },
                { name: 'web',        A: b_w * h_w,         y_bar: h_f_top + h_w / 2 },
                { name: 'bot_flange', A: b_f_bot * h_f_bot, y_bar: h_f_top + h_w + h_f_bot / 2 }
            ];

            // 計算總面積與 A*y 的總和
            let totalArea = 0;
            let sumAy = 0;
            parts.forEach(p => {
                totalArea += p.A;
                sumAy += p.A * p.y_bar;
            });

            // 計算整個 I 形梁的形心 (從頂部邊緣算起)
            const y_c = totalArea > 0 ? sumAy / totalArea : 0;

            // 使用平行軸定理計算各部分的慣性矩： I = I_c + A*d^2
            let Ig = 0;
            // 上翼版
            const Ic_top = (b_f_top * Math.pow(h_f_top, 3)) / 12;
            const d_top = y_c - parts[0].y_bar;
            Ig += Ic_top + parts[0].A * Math.pow(d_top, 2);

            // 腹版
            const Ic_web = (b_w * Math.pow(h_w, 3)) / 12;
            const d_web = y_c - parts[1].y_bar;
            Ig += Ic_web + parts[1].A * Math.pow(d_web, 2);

            // 下翼版
            const Ic_bot = (b_f_bot * Math.pow(h_f_bot, 3)) / 12;
            const d_bot = y_c - parts[2].y_bar;
            Ig += Ic_bot + parts[2].A * Math.pow(d_bot, 2);

            // 計算迴轉半徑
            const r = totalArea > 0 ? Math.sqrt(Ig / totalArea) : 0;
            
            return { Ag_cm2: totalArea, Ig_cm4: Ig, r_cm: r };
        }

        function calculateFlexureStrength(inputs) {
            const constants = { Es: 2.04e6, Eps: 1.97e6, epsilon_c_ultimate: 0.003 }; // Es, Eps in kgf/cm^2
            const beta1 = calculateBeta1(inputs.fc_prime); // 使用MPa單位計算
            
            // 將單位從 MPa, mm 轉回 kgf, cm 進行計算
            const inputs_kgfcm = convertSiToKgfCm(inputs);

            const c_cm = findNeutralAxis(inputs_kgfcm, constants, beta1);
            if (isNaN(c_cm)) {
                displayError("彎矩計算無法收斂，請檢查輸入參數是否合理。");
                return null;
            }
            const forces = calculateAllForces(c_cm, inputs_kgfcm, constants, beta1);
            const Mn_tfm = calculateMomentStrength(c_cm, forces, inputs_kgfcm);
            const { phi, epsilon_t } = calculatePhi(c_cm, inputs_kgfcm, constants);
            return {
                c_cm: c_cm,
                epsilon_t: epsilon_t,
                phi: phi,
                Mn_tfm: Mn_tfm,
                phiMn_tfm: Mn_tfm * phi
            };
        }

        function calculateShearStrength(inputs) {
             // 使用轉換回 kgf/cm2, cm 的單位
            const inputs_kgfcm = convertSiToKgfCm(inputs);
            const { fc_prime, b_w, d, Av, fyt, s } = inputs_kgfcm;

            const lambda = 1.0; // 普通重量混凝土
            const phi_v = 0.75;

            // Vc: 混凝土剪力強度貢獻 (ACI 表 22.5.5.1 簡化公式)
            // Vc = 0.53 * lambda * sqrt(f'c) * bw * d
            const Vc_kgf = 0.53 * lambda * Math.sqrt(fc_prime) * b_w * d;

            // Vs: 鋼筋剪力強度貢獻
            // Vs = Av * fyt * d / s
            let Vs_kgf = 0;
            if (s > 0) {
                 Vs_kgf = (Av * fyt * d) / s;
            }
            
            // Vs 上限檢核 (ACI 22.5.1.2)
            // Vs_max = 2.1 * sqrt(f'c) * bw * d
            const Vs_max_kgf = 2.1 * Math.sqrt(fc_prime) * b_w * d;
            Vs_kgf = Math.min(Vs_kgf, Vs_max_kgf);
            
            const Vn_kgf = Vc_kgf + Vs_kgf;
            const phiVn_kgf = phi_v * Vn_kgf;

            // 從 kgf 轉換為 tf 顯示
            return {
                phi_v: phi_v,
                Vc_tf: Vc_kgf / 1000,
                Vs_tf: Vs_kgf / 1000,
                Vn_tf: Vn_kgf / 1000,
                phiVn_tf: phiVn_kgf / 1000
            };
        }


        // --- 單位轉換與輸入驗證 ---
        const CONVERSIONS = { kgfcm2_to_MPa: 0.0980665, cm_to_mm: 10, cm2_to_mm2: 100 };

        function getRawInputs() {
             const ids = ['b_f_top', 'h_f_top', 'b_w', 'h', 'h_f_bot', 'b_f_bot', 'fc_prime', 'fy', 'fpu', 'fyt', 'As_prime', 'd_prime', 'As', 'd', 'Aps', 'dp', 'fse', 'Av', 's'];
             const rawInputs = {};
             for (const id of ids) {
                 const value = parseFloat(document.getElementById(id).value);
                 if (isNaN(value)) {
                    displayError(`輸入無效：${id} 不是數字`);
                    return null;
                 }
                 rawInputs[id] = value;
             }
             return rawInputs;
        }

        function getAndConvertInputs() {
            const ids = ['b_f_top', 'h_f_top', 'b_w', 'h', 'h_f_bot', 'b_f_bot', 'fc_prime', 'fy', 'fpu', 'fyt', 'As_prime', 'd_prime', 'As', 'd', 'Aps', 'dp', 'fse', 'Av', 's'];
            const si_inputs = {}, raw_inputs = {};

            for (const id of ids) {
                const value = parseFloat(document.getElementById(id).value);
                const labelElement = document.querySelector(`label[for=${id}]`);
                const label = labelElement ? labelElement.innerHTML : id;
                if (isNaN(value) || value < 0) { displayError(`輸入錯誤: '${label}' 必須為正數。`); return null; }
                raw_inputs[id] = value;
            }

            // Convert geometry to mm
            si_inputs.b_f_top = raw_inputs.b_f_top * CONVERSIONS.cm_to_mm; si_inputs.h_f_top = raw_inputs.h_f_top * CONVERSIONS.cm_to_mm;
            si_inputs.b_w = raw_inputs.b_w * CONVERSIONS.cm_to_mm; si_inputs.h = raw_inputs.h * CONVERSIONS.cm_to_mm;
            si_inputs.h_f_bot = raw_inputs.h_f_bot * CONVERSIONS.cm_to_mm; si_inputs.b_f_bot = raw_inputs.b_f_bot * CONVERSIONS.cm_to_mm;
            si_inputs.d_prime = raw_inputs.d_prime * CONVERSIONS.cm_to_mm; si_inputs.d = raw_inputs.d * CONVERSIONS.cm_to_mm;
            si_inputs.dp = raw_inputs.dp * CONVERSIONS.cm_to_mm; si_inputs.s = raw_inputs.s * CONVERSIONS.cm_to_mm;
            
            // Convert stresses to MPa
            si_inputs.fc_prime = raw_inputs.fc_prime * CONVERSIONS.kgfcm2_to_MPa; si_inputs.fy = raw_inputs.fy * CONVERSIONS.kgfcm2_to_MPa;
            si_inputs.fpu = raw_inputs.fpu * CONVERSIONS.kgfcm2_to_MPa; si_inputs.fse = raw_inputs.fse * CONVERSIONS.kgfcm2_to_MPa;
            si_inputs.fyt = raw_inputs.fyt * CONVERSIONS.kgfcm2_to_MPa;

            // Convert areas to mm²
            si_inputs.As_prime = raw_inputs.As_prime * CONVERSIONS.cm2_to_mm2; si_inputs.As = raw_inputs.As * CONVERSIONS.cm2_to_mm2;
            si_inputs.Aps = raw_inputs.Aps * CONVERSIONS.cm2_to_mm2; si_inputs.Av = raw_inputs.Av * CONVERSIONS.cm2_to_mm2;

            if (raw_inputs.h_f_top + raw_inputs.h_f_bot >= raw_inputs.h || raw_inputs.b_w > raw_inputs.b_f_top || raw_inputs.b_w > raw_inputs.b_f_bot) { displayError('幾何尺寸錯誤：翼版厚度總和不能大於總高，或腹版寬度不能大於翼版寬度。'); return null; }
            if (raw_inputs.d >= raw_inputs.h || raw_inputs.dp >= raw_inputs.h || raw_inputs.d_prime >= raw_inputs.h) { displayError('鋼筋位置錯誤：d, dp, d\' 應在梁斷面內。'); return null; }
            return si_inputs;
        }
        
        function convertSiToKgfCm(si_inputs) {
            const kgfcm_inputs = {};
            const MPa_to_kgfcm2 = 1 / CONVERSIONS.kgfcm2_to_MPa;
            const mm_to_cm = 1 / CONVERSIONS.cm_to_mm;
            const mm2_to_cm2 = 1 / CONVERSIONS.cm2_to_mm2;

            for(const key in si_inputs) {
                if (['fc_prime', 'fy', 'fpu', 'fse', 'fyt'].includes(key)) {
                    kgfcm_inputs[key] = si_inputs[key] * MPa_to_kgfcm2;
                } else if (['As_prime', 'As', 'Aps', 'Av'].includes(key)) {
                    kgfcm_inputs[key] = si_inputs[key] * mm2_to_cm2;
                } else { // geometry
                    kgfcm_inputs[key] = si_inputs[key] * mm_to_cm;
                }
            }
            return kgfcm_inputs;
        }
        
        // --- 核心計算函數 (彎矩使用 kgf-cm 單位) ---
        function calculateBeta1(fc_prime_MPa) {
            if (fc_prime_MPa <= 28) return 0.85;
            if (fc_prime_MPa >= 55) return 0.65;
            return 0.85 - 0.05 * (fc_prime_MPa - 28) / 7;
        }

        function findNeutralAxis(inputs, constants, beta1) {
            let c_low = 0.001, c_high = inputs.h, c_mid;
            const max_iter = 100, tolerance = 1; // 1 kgf 容許誤差
            for (let i = 0; i < max_iter; i++) {
                c_mid = (c_low + c_high) / 2;
                if (c_mid <= 0) c_mid = 0.001;
                const forces = calculateAllForces(c_mid, inputs, constants, beta1);
                const p_total_kgf = forces.Cc + forces.Fs_prime - forces.Ts - forces.Tps;
                if (Math.abs(p_total_kgf) < tolerance) return c_mid;
                if (p_total_kgf > 0) c_high = c_mid; else c_low = c_mid;
            }
            return NaN;
        }
        
        function calculateAllForces(c, inputs, constants, beta1) {
            const a = beta1 * c;
            const concreteResult = getConcreteCompressiveForce(a, inputs.b_f_top, inputs.h_f_top, inputs.b_w, inputs.fc_prime);
            const Cc = concreteResult.force;
            const epsilon_s_prime = constants.epsilon_c_ultimate * (c - inputs.d_prime) / c;
            const f_s_prime = Math.max(-inputs.fy, Math.min(epsilon_s_prime * constants.Es, inputs.fy));
            const Fs_prime = inputs.As_prime > 0 ? inputs.As_prime * (f_s_prime - 0.85 * inputs.fc_prime) : 0;
            const epsilon_s = constants.epsilon_c_ultimate * (inputs.d - c) / c;
            const f_s = Math.min(epsilon_s * constants.Es, inputs.fy);
            const Ts = inputs.As * f_s;
            const epsilon_se = inputs.fse / constants.Eps;
            const delta_epsilon_p = constants.epsilon_c_ultimate * (inputs.dp - c) / c;
            const epsilon_ps = epsilon_se + delta_epsilon_p;
            const f_ps = Math.min(epsilon_ps * constants.Eps, inputs.fpu);
            const Tps = inputs.Aps * f_ps;
            return { Cc, Fs_prime, Ts, Tps, concreteCentroid: concreteResult.centroid };
        }
        
        function getConcreteCompressiveForce(a, b_f_top, h_f_top, b_w, fc_prime) {
            let Ac, centroid;
            if (a <= h_f_top) { Ac = b_f_top * a; centroid = a / 2; }
            else { const Ac_flange = (b_f_top - b_w) * h_f_top; const Ac_web = b_w * a; Ac = Ac_flange + Ac_web; centroid = (Ac_flange * (h_f_top / 2) + Ac_web * (a / 2)) / Ac; }
            return { force: 0.85 * fc_prime * Ac, centroid };
        }
        
        function calculateMomentStrength(c, forces, inputs) {
            const { Cc, Fs_prime, Ts, Tps, concreteCentroid } = forces;
            let Mn_total_kgf_cm = 0;
            Mn_total_kgf_cm += Cc * (c - concreteCentroid);
            Mn_total_kgf_cm += Fs_prime * (c - inputs.d_prime);
            Mn_total_kgf_cm += Ts * (inputs.d - c);
            Mn_total_kgf_cm += Tps * (inputs.dp - c);
            return Mn_total_kgf_cm / 1000 / 100; // Convert kgf-cm to tf-m
        }

        function calculatePhi(c, inputs, constants) {
            const d_t = Math.max(inputs.d, inputs.dp);
            const epsilon_t = constants.epsilon_c_ultimate * (d_t - c) / c;
            const epsilon_y = inputs.fy / constants.Es;
            let phi;
            if (epsilon_t <= epsilon_y) phi = 0.65;
            else if (epsilon_t >= 0.005) phi = 0.90;
            else phi = 0.65 + 0.25 * (epsilon_t - epsilon_y) / (0.005 - epsilon_y);
            return { phi, epsilon_t };
        }

        // --- 顯示與繪圖 ---
        function displayGeometryResults(results) {
             document.getElementById('result_Ag').textContent = `${results.Ag_cm2.toLocaleString('en-US', { maximumFractionDigits: 2 })} cm²`;
             document.getElementById('result_Ig').textContent = `${results.Ig_cm4.toLocaleString('en-US', { maximumFractionDigits: 0 })} cm⁴`;
             document.getElementById('result_r').textContent = `${results.r_cm.toFixed(2)} cm`;
        }

        function displayFlexureResults(results) {
            document.getElementById('result_c').textContent = `${results.c_cm.toFixed(2)} cm`;
            document.getElementById('result_epsilon_t').textContent = `${results.epsilon_t.toFixed(5)}`;
            document.getElementById('result_phi').textContent = `${results.phi.toFixed(3)}`;
            document.getElementById('result_Mn').textContent = `${results.Mn_tfm.toFixed(2)} tf-m`;
            document.getElementById('result_phiMn').textContent = `${results.phiMn_tfm.toFixed(2)} tf-m`;
        }

        function displayShearResults(results) {
            document.getElementById('result_phi_v').textContent = `${results.phi_v.toFixed(2)}`;
            document.getElementById('result_Vc').textContent = `${results.Vc_tf.toFixed(2)} tf`;
            document.getElementById('result_Vs').textContent = `${results.Vs_tf.toFixed(2)} tf`;
            document.getElementById('result_Vn').textContent = `${results.Vn_tf.toFixed(2)} tf`;
            document.getElementById('result_phiVn').textContent = `${results.phiVn_tf.toFixed(2)} tf`;
        }

        function displayError(message) {
            const errorContainer = document.getElementById('error-container');
            errorContainer.textContent = message;
            errorContainer.classList.remove('hidden');
        }

        function updateDiagram(raw_inputs) {
            if (!raw_inputs) return;
            const svg = document.getElementById('beam-diagram');
            svg.innerHTML = ''; // 清空舊圖
            const svgWidth = 450, svgHeight = 400;
            const margin = { top: 40, right: 80, bottom: 40, left: 80 };
            const h = raw_inputs.h, b_max = Math.max(raw_inputs.b_f_top, raw_inputs.b_f_bot, 1);
            const scaleY = (svgHeight - margin.top - margin.bottom) / h;
            const scaleX = (svgWidth - margin.left - margin.right) / b_max;
            const beamDrawHeight = h * scaleY, beamDrawWidthTop = raw_inputs.b_f_top * scaleX, beamDrawWidthBot = raw_inputs.b_f_bot * scaleX;
            const webDrawWidth = raw_inputs.b_w * scaleX, topFlangeDrawHeight = raw_inputs.h_f_top * scaleY, botFlangeDrawHeight = raw_inputs.h_f_bot * scaleY;
            const x_center = svgWidth / 2, y_top = margin.top;
            const points = [[x_center-beamDrawWidthTop/2,y_top],[x_center+beamDrawWidthTop/2,y_top],[x_center+beamDrawWidthTop/2,y_top+topFlangeDrawHeight],[x_center+webDrawWidth/2,y_top+topFlangeDrawHeight],[x_center+webDrawWidth/2,y_top+beamDrawHeight-botFlangeDrawHeight],[x_center+beamDrawWidthBot/2,y_top+beamDrawHeight-botFlangeDrawHeight],[x_center+beamDrawWidthBot/2,y_top+beamDrawHeight],[x_center-beamDrawWidthBot/2,y_top+beamDrawHeight],[x_center-beamDrawWidthBot/2,y_top+beamDrawHeight-botFlangeDrawHeight],[x_center-webDrawWidth/2,y_top+beamDrawHeight-botFlangeDrawHeight],[x_center-webDrawWidth/2,y_top+topFlangeDrawHeight],[x_center-beamDrawWidthTop/2,y_top+topFlangeDrawHeight]];
            const beamPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
            beamPath.setAttribute("d", "M" + points.map(p => p.join(',')).join(' L') + " Z");
            beamPath.setAttribute("fill", "#e5e7eb"); beamPath.setAttribute("stroke", "#4b5563"); beamPath.setAttribute("stroke-width", "1.5");
            svg.appendChild(beamPath);

            const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
            const marker = document.createElementNS("http://www.w3.org/2000/svg", "marker");
            marker.setAttribute("id", "arrow"); marker.setAttribute("viewBox", "0 0 10 10"); marker.setAttribute("refX", "5"); marker.setAttribute("refY", "5");
            marker.setAttribute("markerWidth", "5"); marker.setAttribute("markerHeight", "5"); marker.setAttribute("orient", "auto-start-reverse");
            const arrowPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
            arrowPath.setAttribute("d", "M 0 0 L 10 5 L 0 10 z"); marker.appendChild(arrowPath); defs.appendChild(marker); svg.appendChild(defs);

            function drawReinforcement(y_cm, area_cm2, label, color) {
                if (area_cm2 > 0 && y_cm > 0) {
                    const y = y_top + y_cm * scaleY;
                    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    line.setAttribute("x1", x_center - webDrawWidth / 2 + 10); line.setAttribute("y1", y); line.setAttribute("x2", x_center + webDrawWidth / 2 - 10); line.setAttribute("y2", y);
                    line.setAttribute("stroke", color); line.setAttribute("stroke-width", "2.5"); line.setAttribute("stroke-dasharray", "5 3"); svg.appendChild(line);
                    const dimLine = document.createElementNS("http://www.w3.org/2000/svg", "line"); const dimX = x_center + beamDrawWidthTop / 2 + 15;
                    dimLine.setAttribute("x1", dimX); dimLine.setAttribute("y1", y_top); dimLine.setAttribute("x2", dimX); dimLine.setAttribute("y2", y);
                    dimLine.setAttribute("stroke", color); dimLine.setAttribute("stroke-width", "1"); dimLine.setAttribute("marker-end", "url(#arrow)");
                    marker.querySelector('path').setAttribute("fill", color); svg.appendChild(dimLine);
                    const text = document.createElementNS("http://www.w3.org/2000/svg", "text"); text.textContent = `${label} = ${y_cm}`;
                    text.setAttribute("x", dimX + 8); text.setAttribute("y", y_top + (y - y_top) / 2); text.setAttribute("font-size", "14px");
                    text.setAttribute("fill", color); text.setAttribute("dominant-baseline", "middle"); svg.appendChild(text);
                }
            }
            drawReinforcement(raw_inputs.d_prime, raw_inputs.As_prime, "d'", "#3b82f6");
            drawReinforcement(raw_inputs.d, raw_inputs.As, "d", "#16a34a");
            drawReinforcement(raw_inputs.dp, raw_inputs.Aps, "d_p", "#f97316");
            const h_dimX = x_center - beamDrawWidthTop / 2 - 15;
            const h_dimLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
            marker.querySelector('path').setAttribute("fill", "#4b5563");
            h_dimLine.setAttribute("x1", h_dimX); h_dimLine.setAttribute("y1", y_top); h_dimLine.setAttribute("x2", h_dimX); h_dimLine.setAttribute("y2", y_top + beamDrawHeight);
            h_dimLine.setAttribute("stroke", "#4b5563"); h_dimLine.setAttribute("stroke-width", "1");
            h_dimLine.setAttribute("marker-start", "url(#arrow)"); h_dimLine.setAttribute("marker-end", "url(#arrow)"); svg.appendChild(h_dimLine);
            const h_text = document.createElementNS("http://www.w3.org/2000/svg", "text"); h_text.textContent = `h = ${raw_inputs.h}`;
            h_text.setAttribute("x", h_dimX - 8); h_text.setAttribute("y", y_top + beamDrawHeight / 2);
            h_text.setAttribute("font-size", "14px"); h_text.setAttribute("fill", "#374151");
            h_text.setAttribute("text-anchor", "end"); h_text.setAttribute("dominant-baseline", "middle"); svg.appendChild(h_text);
        }

        const inputElements = document.querySelectorAll('#beam-form input[type="number"]');
        inputElements.forEach(input => {
            input.addEventListener('input', runCalculation);
        });
        
    </script>
</body>
</html>
