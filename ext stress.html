<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P30-P31 ç®±æ¢é åŠ›åˆ†æ (åˆ†é ç‰ˆ)</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f1f5f9;
            color: #334155;
        }

        .chart-container {
            position: relative;
            width: 100%;
            height: 350px;
        }

        .canvas-drawing {
            background-color: #ffffff;
            border-radius: 0.5rem;
            border: 1px solid #cbd5e1;
        }

        /* Table Styling */
        .data-table th {
            background-color: #e2e8f0;
            color: #475569;
            font-size: 0.75rem;
            padding: 8px;
            border-bottom: 2px solid #ffffff;
            white-space: nowrap;
            vertical-align: middle;
        }

        .data-table td {
            padding: 6px 8px;
            font-size: 0.8rem;
            border-bottom: 1px solid #ffffff;
            text-align: center;
            font-family: 'ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', monospace;
        }

        .data-table tr:nth-child(even) {
            background-color: #f8fafc;
        }

        .data-table tr:hover {
            background-color: #e0f2fe;
        }

        /* Override border colors to white */
        .data-table td[class*="border-r"] {
            border-right-color: #ffffff !important;
        }

        .data-table th[class*="border-b"] {
            border-bottom-color: #ffffff !important;
        }

        .highlight-row {
            background-color: #fff7ed !important;
            border-left: 4px solid #f59e0b;
        }

        /* Tab Styling */
        .tab-container {
            display: flex;
            gap: 0;
            margin-bottom: 0;
            padding: 0 8px;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border-radius: 8px 8px 0 0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .tab-btn {
            position: relative;
            padding: 12px 20px;
            font-size: 0.95rem;
            font-weight: 500;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 4px;
            margin-bottom: -1px;
            border-radius: 8px 8px 0 0;
            color: #64748b;
            overflow: hidden;
        }

        .tab-btn::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #2563eb);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab-btn:hover {
            background-color: rgba(255, 255, 255, 0.5);
            color: #475569;
        }

        .tab-active {
            background: white;
            color: #1e40af;
            font-weight: 600;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.08);
        }

        .tab-active::before {
            transform: scaleX(1);
        }

        .tab-inactive {
            color: #64748b;
        }

        .tab-content-wrapper {
            background: white;
            border-radius: 0 8px 8px 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            animation: slideDown 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tab-content {
            padding: 20px;
            animation: fadeIn 0.4s ease 0.1s both;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Custom Amber Slider for Tab 5 */
        input[type=range].slider-amber {
            -webkit-appearance: none;
            /* Override default CSS styles */
            appearance: none;
            width: 100%;
            height: 6px;
            background: #fcd34d;
            /* amber-300 */
            border-radius: 9999px;
            cursor: pointer;
            margin-top: 5px;
            margin-bottom: 5px;
        }

        input[type=range].slider-amber:focus {
            outline: none;
        }

        /* Webkit Thumb */
        input[type=range].slider-amber::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: #d97706;
            /* amber-600 */
            border: 2px solid #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            margin-top: -6px;
            /* center thumb */
            transition: transform 0.1s ease, background-color 0.1s;
        }

        input[type=range].slider-amber:active::-webkit-slider-thumb {
            transform: scale(1.1);
            background: #b45309;
            /* amber-700 */
        }

        /* Mozilla Thumb */
        input[type=range].slider-amber::-moz-range-thumb {
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: #d97706;
            border: 2px solid #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: transform 0.1s ease, background-color 0.1s;
        }

        input[type=range].slider-amber::-moz-range-progress {
            background-color: #d97706;
            height: 6px;
            border-radius: 9999px;
        }
    </style>
</head>

<body class="bg-slate-100">

    <!-- Header -->
    <nav class="bg-slate-800 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <span class="text-amber-400 text-2xl mr-3">ğŸ“‘</span>
                    <div>
                        <h1 class="font-bold text-lg tracking-wide">P30-P31 ç®±æ¢é åŠ›åˆ†æ</h1>
                        <p class="text-xs text-slate-400">é›™åˆ†é æ¨¡å¼ï¼šæ•¸æ“šè©³è¡¨ vs åŠ å›ºåˆ†æ</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2" id="unit-controls">
                    <span class="text-xs text-slate-300">é¡¯ç¤ºå–®ä½: tf</span>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-12 gap-6">

        <!-- Tabs Content -->
        <div class="lg:col-span-12">

            <!-- Tab Navigation -->
            <div class="tab-container">
                <button onclick="switchTab(1)" id="tab-btn-1" class="tab-btn tab-active">
                    <span class="flex items-center">
                        <span>é é‘„ç®±å‹æ¢åŸºæœ¬è³‡è¨Š</span>
                    </span>
                </button>
                <button onclick="switchTab(2)" id="tab-btn-2" class="tab-btn tab-inactive">
                    <span class="flex items-center">
                        <span>è¨­è¨ˆè¼‰é‡</span>
                    </span>
                </button>
                <button onclick="switchTab(3)" id="tab-btn-3" class="tab-btn tab-inactive">
                    <span class="flex items-center">
                        <span>é åŠ›é…ç½®è©³è¡¨ (åŸºç¤åœ–)</span>
                    </span>
                </button>
                <button onclick="switchTab(4)" id="tab-btn-4" class="tab-btn tab-inactive">
                    <span class="flex items-center">
                        <span>æ‡‰åŠ›æª¢æ ¸ (å®Œå·¥éšæ®µ)</span>
                    </span>
                </button>
                <button onclick="switchTab(5)" id="tab-btn-5" class="tab-btn tab-inactive">
                    <span class="flex items-center">
                        <span>å¤–ç½®é åŠ›é…ç½®è©³è¡¨ (åŠ å›ºåœ–)</span>
                    </span>
                </button>
                <button onclick="switchTab(6)" id="tab-btn-6" class="tab-btn tab-inactive">
                    <span class="flex items-center">
                        <span>æ‡‰åŠ›æª¢æ ¸ (åŠ å›ºéšæ®µ)</span>
                    </span>
                </button>
            </div>

            <!-- Tab 1 Content (Section Info) -->
            <div id="tab-content-1" class="tab-content-wrapper">
                <div id="tab-content-1-inner" class="tab-content space-y-6">

                    <!-- æ¢æˆªé¢ç¤ºæ„åœ– -->
                    <div>
                        <h3 class="text-sm font-bold text-slate-700 mb-2 border-l-4 border-purple-500 pl-2">é é‘„ç®±å‹æ¢æˆªé¢åœ–
                        </h3>
                        <div class="bg-slate-50 p-4 rounded border border-slate-200 flex justify-center">
                            <img id="sectionImage"
                                src="https://raw.githubusercontent.com/ttchang1127/dashboard/main/images/precasr%20boxgirder.png"
                                alt="é é‘„ç®±å‹æ¢æˆªé¢åœ–" class="max-w-full h-auto rounded border border-slate-300"
                                style="max-height: 400px;">
                        </div>
                    </div>

                    <!-- ç¯€é»è³‡è¨Šè¡¨ -->
                    <div>
                        <h3 class="text-sm font-bold text-slate-700 mb-2 border-l-4 border-blue-500 pl-2">ç¯€é»1~5 æˆªé¢ç‰¹æ€§
                        </h3>
                        <div class="overflow-x-auto border border-slate-200 rounded">
                            <table class="w-full data-table text-xs">
                                <thead class="sticky top-0 z-10 shadow-sm">
                                    <tr>
                                        <th class="bg-slate-100">ç¯€é» (Node)</th>
                                        <th class="bg-slate-100">åƒæ•¸ (A/C/D) (cm)</th>
                                        <th class="bg-purple-50 text-purple-700">æ–·é¢ç©<br />(cmÂ²)</th>
                                        <th class="bg-blue-50 text-blue-700">ä¸­æ€§è»¸ä½ç½®<br />(å¾é ‚éƒ¨ Y_top cm)</th>
                                        <th class="bg-blue-50 text-blue-700">ä¸­æ€§è»¸ä½ç½®<br />(å¾åº•éƒ¨ Y_bot cm)</th>
                                        <th class="bg-green-50 text-green-700">æ…£æ€§çŸ© I_zz<br />(cmâ´)</th>
                                    </tr>
                                </thead>
                                <tbody id="sectionInfoBody">
                                    <!-- Generated -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Tab 2 Content (Design Loads) -->
            <div id="tab-content-2" class="tab-content-wrapper hidden">
                <div id="tab-content-2-inner" class="tab-content space-y-6">

                    <!-- Profile Canvas (Design Loads) -->
                    <div>
                        <h3 class="text-sm font-bold text-slate-700 mb-2 border-l-4 border-green-500 pl-2">ç¸±å‘ç¯€æ®µä½ˆç½®åœ–
                            (åŸæ©‹åŸºç¤)</h3>
                        <div class="chart-container" style="height: 200px;">
                            <canvas id="profileCanvas3"></canvas>
                        </div>
                        <p class="text-xs text-slate-400 mt-1 text-center">åƒ…é¡¯ç¤ºç¯€æ®µ(#)èˆ‡ç¯€é»(N)</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Dead Load Block -->
                        <div class="bg-white rounded-lg border border-slate-200 shadow-sm p-4">
                            <h3 class="text-sm font-bold text-slate-700 mb-3 border-l-4 border-gray-500 pl-2">éœè¼‰é‡ç‰ˆå¡Š
                                (Dead Load)</h3>

                            <div class="space-y-4 text-sm">
                                <div class="flex justify-between items-center py-2 border-b border-slate-100">
                                    <span class="text-slate-500">æ©‹æ¢å…¨é•·è‡ªé‡</span>
                                    <span class="font-mono font-bold text-slate-700">2030.82 tf</span>
                                </div>
                                <div class="flex justify-between items-center py-2 border-b border-slate-100">
                                    <span class="text-slate-500">æ©‹æ¢è‡ªé‡ (w_self)</span>
                                    <span class="font-mono font-bold text-slate-700">35.94 tf/m</span>
                                </div>

                                <!-- Input -->
                                <div class="bg-slate-50 p-3 rounded mt-2">
                                    <label class="block text-xs font-bold text-slate-600 mb-2">é™„åŠ è¼‰é‡ (AC+ç®¡ç·š+è­·æ¬„)
                                        (tf/m)</label>
                                    <div class="flex items-center space-x-2">
                                        <input type="number" id="dl-additional" value="3.5" step="0.1"
                                            class="w-full px-3 py-2 border border-slate-300 rounded text-sm focus:outline-none focus:border-blue-500 text-right font-mono"
                                            oninput="updateDeadLoad()">
                                        <span class="text-xs text-slate-400 flex-shrink-0">tf/m</span>
                                    </div>
                                </div>

                                <!-- Result -->
                                <div class="bg-gray-100 p-4 rounded text-center mt-2">
                                    <div class="text-xs text-slate-500 mb-1">éœè¼‰é‡å½çŸ© M_DL</div>
                                    <div class="text-2xl font-bold text-gray-800 font-mono" id="val-m-dl">--</div>
                                    <div class="text-xs text-slate-400 mt-1">(w_self + w_add) * LÂ² / 8</div>
                                </div>
                            </div>
                        </div>

                        <!-- Live Load Block -->
                        <div class="bg-white rounded-lg border border-slate-200 shadow-sm p-4">
                            <h3 class="text-sm font-bold text-slate-700 mb-3 border-l-4 border-blue-500 pl-2">è»Šè¼›è¼‰é‡ç‰ˆå¡Š
                                (Live Load)</h3>

                            <div class="space-y-3 text-sm">
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-slate-50 p-2 rounded">
                                        <div class="text-xs text-slate-500">æ©‹æ¢è¼‰é‡å½çŸ©</div>
                                        <div class="font-mono font-bold text-slate-700 text-lg">499 <span
                                                class="text-xs font-normal">tfÂ·m</span></div>
                                    </div>
                                    <div class="bg-slate-50 p-2 rounded">
                                        <div class="text-xs text-slate-500">ç«¯é»å‰ªåŠ›</div>
                                        <div class="font-mono font-bold text-slate-700 text-lg">49 <span
                                                class="text-xs font-normal">tf</span></div>
                                    </div>
                                </div>

                                <div class="space-y-2 mt-2">
                                    <div class="flex items-center justify-between">
                                        <label class="text-xs text-slate-600">è¡æ“Šä¿‚æ•¸ (IM)</label>
                                        <div class="flex items-center w-1/2 space-x-2">
                                            <input type="range" id="ll-impact-slider" min="0" max="0.3" step="0.01"
                                                value="0.3"
                                                class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                                            <span class="font-mono text-xs w-8 text-right font-bold text-blue-600"
                                                id="val-ll-impact">0.3</span>
                                        </div>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <label class="text-xs text-slate-600">è¶…è¼‰ä¿‚æ•¸ (OL)</label>
                                        <div class="flex items-center w-1/2 space-x-2">
                                            <input type="range" id="ll-overload-slider" min="0" max="0.3" step="0.01"
                                                value="0.3"
                                                class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                                            <span class="font-mono text-xs w-8 text-right font-bold text-blue-600"
                                                id="val-ll-overload">0.3</span>
                                        </div>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <label class="text-xs text-slate-600">è»Šé“æ•¸ (Lanes)</label>
                                        <div class="flex items-center w-1/2 space-x-2">
                                            <input type="range" id="ll-lanes-slider" min="1" max="4" step="1" value="4"
                                                class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                                            <span class="font-mono text-xs w-8 text-right font-bold text-blue-600"
                                                id="val-ll-lanes">4</span>
                                        </div>
                                    </div>
                                    <div class="flex items-center justify-between pt-1">
                                        <label class="text-xs text-slate-600">å¤šè»Šé“æŠ˜æ¸›ä¿‚æ•¸</label>
                                        <select id="ll-reduction-select"
                                            class="text-xs px-2 py-1 border border-slate-300 rounded bg-white focus:outline-none focus:border-blue-500"
                                            onchange="updateLiveLoadVariables(); updateLiveLoad();">
                                            <option value="1.0" selected>100% (1-2è»Šé“)</option>
                                            <option value="0.9">90% (3è»Šé“)</option>
                                            <option value="0.75">75% (4+è»Šé“)</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Result -->
                                <div class="bg-blue-50 p-4 rounded text-center mt-3 border border-blue-100">
                                    <div class="text-xs text-blue-500 mb-1">è»Šè¼›è¼‰é‡å½çŸ© M_LL</div>
                                    <div class="text-2xl font-bold text-blue-800 font-mono" id="val-m-ll">--</div>
                                    <div class="text-xs text-blue-400 mt-1">M Ã— (1+IM) Ã— (1+OL) Ã— Red Ã— N</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Segment Moment Table -->
                    <div class="overflow-hidden mt-8">
                        <div class="flex justify-between items-end mb-2">
                            <h3 class="text-sm font-bold text-slate-700 border-l-4 border-green-500 pl-2">æ©‹æ¢å„ç¯€æ®µå½çŸ©å€¼</h3>
                            <span class="text-xs text-slate-400">å–®ä½: m, tfÂ·m</span>
                        </div>
                        <div class="overflow-x-auto max-h-[600px] overflow-y-auto border border-slate-200 rounded">
                            <table class="w-full data-table">
                                <thead class="sticky top-0 z-10 shadow-sm">
                                    <tr>
                                        <th class="bg-slate-100">ç¯€æ®µ #</th>
                                        <th class="bg-slate-100">é•·åº¦ (m)</th>
                                        <th class="bg-green-50 text-green-700">éœè¼‰é‡å½çŸ© (tfÂ·m)</th>
                                        <th class="bg-blue-50 text-blue-700">è»Šè¼›è¼‰é‡å½çŸ© (tfÂ·m)</th>
                                    </tr>
                                </thead>
                                <tbody id="segmentMomentBody">
                                    <!-- Generated -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Tab 3 Content (é åŠ›é…ç½®è©³è¡¨) -->
            <div id="tab-content-3" class="tab-content-wrapper hidden">
                <div id="tab-content-3-inner" class="tab-content space-y-6">

                    <!-- Profile Canvas 1 (No Ext) - Full Width -->
                    <div>
                        <h3 class="text-sm font-bold text-slate-700 mb-2 border-l-4 border-slate-400 pl-2">ç¸±å‘ç¯€æ®µä½ˆç½®åœ–
                            (åŸæ©‹åŸºç¤)</h3>
                        <div class="chart-container" style="height: 200px;">
                            <canvas id="profileCanvas1"></canvas>
                        </div>
                        <p class="text-xs text-slate-400 mt-1 text-center">åƒ…é¡¯ç¤ºç¯€æ®µ(#)èˆ‡ç¯€é»(N)ï¼Œæœªç¹ªè£½é«”å¤–ç´¢</p>
                        <div
                            class="bg-blue-50 border border-blue-200 rounded p-3 mt-3 text-xs text-slate-700 space-y-1">
                            <p><span class="font-semibold">æ··å‡åœŸæŠ—å£“å¼·åº¦ï¼š</span>350 kgf/cmÂ²</p>
                            <p><span class="font-semibold">é åŠ›é‹¼è…±ä½ç½®ï¼š</span>æ¢åº•éƒ¨èµ·ç®— 12.5 cm è™•</p>
                        </div>

                        <!-- Bending Moment Capacity Chart -->
                        <div class="mt-6">
                            <h3 class="text-sm font-bold text-slate-700 mb-2 border-l-4 border-blue-500 pl-2">
                                å„ç¯€æ®µé åŠ›é€ æˆçš„å½çŸ©æ‰¿è¼‰åŠ› (tfÂ·m)</h3>
                            <div class="bg-white border border-slate-200 rounded p-4">
                                <canvas id="bendingMomentChart" style="max-height: 300px;"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Data Table -->
                    <div class="overflow-hidden">
                        <div class="flex justify-between items-end mb-2">
                            <h3 class="text-sm font-bold text-slate-700 border-l-4 border-blue-500 pl-2">å„ç¯€æ®µé åŠ›æ•¸æ“šè¡¨</h3>
                            <span class="text-xs text-slate-400" id="tableUnitLabel1">å–®ä½: tf, cm, cm, tfÂ·m</span>
                        </div>
                        <div class="overflow-x-auto max-h-[500px] overflow-y-auto border border-slate-200 rounded">
                            <table class="w-full data-table">
                                <thead class="sticky top-0 z-10 shadow-sm">
                                    <tr>
                                        <th rowspan="2" class="bg-slate-100">ç¯€æ®µ #</th>
                                        <th rowspan="2" class="bg-slate-100">ç¯€é»</th>
                                        <th rowspan="2" class="bg-slate-100">é•·åº¦ (m)</th>
                                        <th colspan="3" class="bg-slate-200 border-b border-white">åŸæ©‹é«”å…§é åŠ› (Internal)
                                        </th>
                                    </tr>
                                    <tr>
                                        <th class="bg-blue-50 text-blue-700">é åŠ›å€¼ (tf)</th>
                                        <th class="bg-orange-50 text-orange-700">æ‡‰åŠ›å¡Šæ·±åº¦ (cm)</th>
                                        <th class="bg-green-50 text-green-700">å½çŸ©æ‰¿è¼‰åŠ› (tfÂ·m)</th>
                                    </tr>
                                </thead>
                                <tbody id="stressTableBody">
                                    <!-- Generated -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Tab 4 Content (åŠ å›ºåˆ†æåœ–è¡¨) -->
            <div id="tab-content-4" class="tab-content-wrapper hidden">
                <div id="tab-content-4-inner" class="tab-content space-y-6">

                    <!-- Sub-tab Navigation for Tab 4 -->
                    <div class="flex space-x-1 border-b border-slate-300 overflow-x-auto">
                        <button onclick="switchSubTab(4, 1)" id="subtab-btn-4-1"
                            class="px-4 py-2 text-sm font-semibold text-blue-600 border-b-2 border-blue-600 hover:text-blue-800">
                            æ··å‡åœŸå®¹è¨±æ‡‰åŠ›
                        </button>
                        <button onclick="switchSubTab(4, 2)" id="subtab-btn-4-2"
                            class="px-4 py-2 text-sm font-semibold text-slate-600 border-b-2 border-transparent hover:text-slate-800">
                            æ¢ä¸Šä¸‹ç·£æ‡‰åŠ›
                        </button>
                        <button onclick="switchSubTab(4, 3)" id="subtab-btn-4-3"
                            class="px-4 py-2 text-sm font-semibold text-slate-600 border-b-2 border-transparent hover:text-slate-800">
                            å£“å¼µæ‡‰åŠ›æª¢æ ¸
                        </button>
                    </div>

                    <!-- Sub-tab 1: æ··å‡åœŸå®¹è¨±æ‡‰åŠ› -->
                    <div id="subtab-content-4-1" class="subtab-content">
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <h3 class="text-lg font-bold text-slate-800 mb-4">æ··å‡åœŸå®¹è¨±æ‡‰åŠ›</h3>
                            <p class="text-xs text-slate-500 mb-4">ä¾æ“šå…¬è·¯æ©‹æ¢è¨­è¨ˆè¦ç¯„(98å¹´) è¡¨3.3</p>

                            <div class="overflow-x-auto">
                                <table class="w-full border-collapse">
                                    <thead>
                                        <tr class="bg-slate-100">
                                            <th
                                                class="border border-slate-300 px-4 py-2 text-left text-sm font-semibold">
                                                Case No.</th>
                                            <th
                                                class="border border-slate-300 px-4 py-2 text-left text-sm font-semibold">
                                                éšæ®µ</th>
                                            <th
                                                class="border border-slate-300 px-4 py-2 text-left text-sm font-semibold">
                                                å®¹è¨±å£“æ‡‰åŠ›<br>(kgf/cmÂ²)</th>
                                            <th
                                                class="border border-slate-300 px-4 py-2 text-left text-sm font-semibold">
                                                å®¹è¨±å¼µæ‡‰åŠ›<br>(kgf/cmÂ²)</th>
                                            <th
                                                class="border border-slate-300 px-4 py-2 text-left text-sm font-semibold">
                                                ä¾æ“šç« ç¯€</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="border border-slate-300 px-4 py-2 text-center font-semibold">1
                                            </td>
                                            <td class="border border-slate-300 px-4 py-2">å®Œå·¥éšæ®µ</td>
                                            <td class="border border-slate-300 px-4 py-2">
                                                <div class="text-sm">I, IB (100%)</div>
                                                <div class="font-bold text-blue-600">210.00</div>
                                            </td>
                                            <td class="border border-slate-300 px-4 py-2">
                                                <div class="font-bold text-blue-600">14.97</div>
                                            </td>
                                            <td class="border border-slate-300 px-4 py-2">8.15.2 2.é …</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-slate-300 px-4 py-2 text-center font-semibold">2
                                            </td>
                                            <td class="border border-slate-300 px-4 py-2">å®Œå·¥éšæ®µ</td>
                                            <td class="border border-slate-300 px-4 py-2">
                                                <div class="text-sm">II, III, IV (125%)</div>
                                                <div class="font-bold text-blue-600">262.50</div>
                                            </td>
                                            <td class="border border-slate-300 px-4 py-2">
                                                <div class="font-bold text-blue-600">18.71</div>
                                            </td>
                                            <td class="border border-slate-300 px-4 py-2">8.15.2 2.é …</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-slate-300 px-4 py-2 text-center font-semibold">3
                                            </td>
                                            <td class="border border-slate-300 px-4 py-2">å®Œå·¥éšæ®µ</td>
                                            <td class="border border-slate-300 px-4 py-2">
                                                <div class="text-sm">V, VI (140%)</div>
                                                <div class="font-bold text-blue-600">294.00</div>
                                            </td>
                                            <td class="border border-slate-300 px-4 py-2">
                                                <div class="font-bold text-blue-600">20.95</div>
                                            </td>
                                            <td class="border border-slate-300 px-4 py-2">8.15.2 2.é …</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-slate-300 px-4 py-2 text-center font-semibold">4
                                            </td>
                                            <td class="border border-slate-300 px-4 py-2">å®Œå·¥éšæ®µ</td>
                                            <td class="border border-slate-300 px-4 py-2">
                                                <div class="text-sm">VII (133%)</div>
                                                <div class="font-bold text-blue-600">279.30</div>
                                            </td>
                                            <td class="border border-slate-300 px-4 py-2">
                                                <div class="font-bold text-blue-600">19.91</div>
                                            </td>
                                            <td class="border border-slate-300 px-4 py-2">8.15.2 2.é …</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Sub-tab 2: æ¢ä¸Šä¸‹ç·£æ‡‰åŠ› -->
                    <div id="subtab-content-4-2" class="subtab-content hidden">
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <h3 class="text-lg font-bold text-slate-800 mb-4">æ¢ä¸Šä¸‹ç·£æ‡‰åŠ›</h3>
                            <!-- è¼‰é‡è³‡è¨Šå€å¡Š (èˆ‡åˆ†é 2é€£å‹•) -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <!-- éœè¼‰é‡ç‰ˆå¡Š -->
                                <div class="bg-white rounded-lg border border-slate-200 shadow-sm p-4">
                                    <h4 class="text-sm font-bold text-slate-700 mb-3 border-l-4 border-gray-500 pl-2">
                                        éœè¼‰é‡ç‰ˆå¡Š (Dead Load)</h4>

                                    <div class="space-y-4 text-sm">
                                        <div class="flex justify-between items-center py-2 border-b border-slate-100">
                                            <span class="text-slate-500">æ©‹æ¢å…¨é•·è‡ªé‡</span>
                                            <span class="font-mono font-bold text-slate-700">2030.82 tf</span>
                                        </div>
                                        <div class="flex justify-between items-center py-2 border-b border-slate-100">
                                            <span class="text-slate-500">æ©‹æ¢è‡ªé‡ (w_self)</span>
                                            <span class="font-mono font-bold text-slate-700">35.94 tf/m</span>
                                        </div>

                                        <!-- Input -->
                                        <div class="bg-slate-50 p-3 rounded mt-2">
                                            <label class="block text-xs font-bold text-slate-600 mb-2">é™„åŠ è¼‰é‡ (AC+ç®¡ç·š+è­·æ¬„)
                                                (tf/m)</label>
                                            <div class="flex items-center space-x-2">
                                                <input type="number" id="dl-additional-tab4" value="3.5" step="0.1"
                                                    class="w-full px-3 py-2 border border-slate-300 rounded text-sm focus:outline-none focus:border-blue-500 text-right font-mono"
                                                    oninput="syncDeadLoadInput(this.value)">
                                                <span class="text-xs text-slate-400 flex-shrink-0">tf/m</span>
                                            </div>
                                        </div>

                                        <!-- Result -->
                                        <div class="bg-gray-100 p-4 rounded text-center mt-2">
                                            <div class="text-xs text-slate-500 mb-1">éœè¼‰é‡å½çŸ© M_DL</div>
                                            <div class="text-2xl font-bold text-gray-800 font-mono" id="val-m-dl-tab4">
                                                --</div>
                                            <div class="text-xs text-slate-400 mt-1">(w_self + w_add) * LÂ² / 8</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- è»Šè¼›è¼‰é‡ç‰ˆå¡Š -->
                                <div class="bg-white rounded-lg border border-slate-200 shadow-sm p-4">
                                    <h4 class="text-sm font-bold text-slate-700 mb-3 border-l-4 border-blue-500 pl-2">
                                        è»Šè¼›è¼‰é‡ç‰ˆå¡Š (Live Load)</h4>

                                    <div class="space-y-3 text-sm">
                                        <div class="grid grid-cols-2 gap-4">
                                            <div class="bg-slate-50 p-2 rounded">
                                                <div class="text-xs text-slate-500">æ©‹æ¢è¼‰é‡å½çŸ©</div>
                                                <div class="font-mono font-bold text-slate-700 text-lg">499 <span
                                                        class="text-xs font-normal">tfÂ·m</span></div>
                                            </div>
                                            <div class="bg-slate-50 p-2 rounded">
                                                <div class="text-xs text-slate-500">ç«¯é»å‰ªåŠ›</div>
                                                <div class="font-mono font-bold text-slate-700 text-lg">49 <span
                                                        class="text-xs font-normal">tf</span></div>
                                            </div>
                                        </div>

                                        <div class="space-y-2 mt-2">
                                            <div class="flex items-center justify-between">
                                                <label class="text-xs text-slate-600">è¡æ“Šä¿‚æ•¸ (IM)</label>
                                                <div class="flex items-center w-1/2 space-x-2">
                                                    <input type="range" id="ll-impact-slider-tab4" min="0" max="0.3"
                                                        step="0.01" value="0.3"
                                                        class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer"
                                                        oninput="syncLiveLoadSlider('impact', this.value)">
                                                    <span
                                                        class="font-mono text-xs w-8 text-right font-bold text-blue-600"
                                                        id="val-ll-impact-tab4">0.3</span>
                                                </div>
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <label class="text-xs text-slate-600">è¶…è¼‰ä¿‚æ•¸ (OL)</label>
                                                <div class="flex items-center w-1/2 space-x-2">
                                                    <input type="range" id="ll-overload-slider-tab4" min="0" max="0.3"
                                                        step="0.01" value="0.3"
                                                        class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer"
                                                        oninput="syncLiveLoadSlider('overload', this.value)">
                                                    <span
                                                        class="font-mono text-xs w-8 text-right font-bold text-blue-600"
                                                        id="val-ll-overload-tab4">0.3</span>
                                                </div>
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <label class="text-xs text-slate-600">è»Šé“æ•¸ (Lanes)</label>
                                                <div class="flex items-center w-1/2 space-x-2">
                                                    <input type="range" id="ll-lanes-slider-tab4" min="1" max="4"
                                                        step="1" value="4"
                                                        class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer"
                                                        oninput="syncLiveLoadSlider('lanes', this.value)">
                                                    <span
                                                        class="font-mono text-xs w-8 text-right font-bold text-blue-600"
                                                        id="val-ll-lanes-tab4">4</span>
                                                </div>
                                            </div>
                                            <div class="flex items-center justify-between pt-1">
                                                <label class="text-xs text-slate-600">å¤šè»Šé“æŠ˜æ¸›ä¿‚æ•¸</label>
                                                <select id="ll-reduction-select-tab4"
                                                    class="text-xs px-2 py-1 border border-slate-300 rounded bg-white focus:outline-none focus:border-blue-500"
                                                    onchange="syncLiveLoadReduction(this.value)">
                                                    <option value="1.0" selected>100% (1-2è»Šé“)</option>
                                                    <option value="0.9">90% (3è»Šé“)</option>
                                                    <option value="0.75">75% (4+è»Šé“)</option>
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Result -->
                                        <div class="bg-blue-50 p-4 rounded text-center mt-3 border border-blue-100">
                                            <div class="text-xs text-blue-500 mb-1">è»Šè¼›è¼‰é‡å½çŸ© M_LL</div>
                                            <div class="text-2xl font-bold text-blue-800 font-mono" id="val-m-ll-tab4">
                                                --</div>
                                            <div class="text-xs text-blue-400 mt-1">M Ã— (1+IM) Ã— (1+OL) Ã— Red Ã— N</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="overflow-x-auto">
                                <table class="w-full border-collapse text-xs">
                                    <thead>
                                        <tr class="bg-slate-100">
                                            <th class="border border-slate-300 px-2 py-2 text-left font-semibold">ç¯€æ®µ #
                                            </th>
                                            <th class="border border-slate-300 px-2 py-2 text-left font-semibold">ç¯€é»
                                            </th>
                                            <th class="border border-slate-300 px-2 py-2 text-left font-semibold">
                                                é‹¼è…±åå¿ƒçŸ©<br>ep,eff (cm)</th>
                                            <th
                                                class="border border-slate-300 px-2 py-2 text-right font-semibold bg-green-50 text-green-700">
                                                éœè¼‰é‡å½çŸ©<br>M_DL (tfÂ·m)</th>
                                            <th
                                                class="border border-slate-300 px-2 py-2 text-right font-semibold bg-blue-50 text-blue-700">
                                                è»Šè¼›è¼‰é‡å½çŸ©<br>M_LL (tfÂ·m)</th>
                                            <th class="border border-slate-300 px-2 py-2 text-left font-semibold">
                                                æœ‰æ•ˆé åŠ›å½çŸ©<br>Meff (tfÂ·m)</th>
                                            <th class="border border-slate-300 px-2 py-2 text-left font-semibold">
                                                æ–·é¢ä¸€æ¬¡çŸ©<br>é ‚éƒ¨ Stop (cmÂ³)</th>
                                            <th class="border border-slate-300 px-2 py-2 text-left font-semibold">
                                                æ–·é¢ä¸€æ¬¡çŸ©<br>åº•éƒ¨ Sbot (cmÂ³)</th>
                                            <th class="border border-slate-300 px-2 py-2 text-right font-semibold">
                                                è»¸å‘æ‡‰åŠ›<br>faxial (kgf/cmÂ²)</th>
                                            <th class="border border-slate-300 px-2 py-2 text-right font-semibold">
                                                ä¸Šç·£å½çŸ©æ‡‰åŠ›<br>fm,top (kgf/cmÂ²)</th>
                                            <th class="border border-slate-300 px-2 py-2 text-right font-semibold">
                                                ä¸‹ç·£å½çŸ©æ‡‰åŠ›<br>fm,bot (kgf/cmÂ²)</th>
                                            <th class="border border-slate-300 px-2 py-2 text-right font-semibold">
                                                æ¢ä¸Šç·£æœ‰æ•ˆæ‡‰åŠ›<br>feff,top (kgf/cmÂ²)</th>
                                            <th class="border border-slate-300 px-2 py-2 text-right font-semibold">
                                                æ¢ä¸‹ç·£æœ‰æ•ˆæ‡‰åŠ›<br>feff,bot (kgf/cmÂ²)</th>
                                            <th class="border border-slate-300 px-2 py-2 text-right font-semibold">
                                                æ¢è‡ªé‡ä¸Šç·£æ‡‰åŠ›<br>fDL,top (kgf/cmÂ²)</th>
                                            <th class="border border-slate-300 px-2 py-2 text-right font-semibold">
                                                æ¢è‡ªé‡ä¸‹ç·£æ‡‰åŠ›<br>fDL,bot (kgf/cmÂ²)</th>
                                            <th class="border border-slate-300 px-2 py-2 text-right font-semibold">
                                                è»Šè¼›è¼‰é‡ä¸Šç·£æ‡‰åŠ›<br>fLL,top (kgf/cmÂ²)</th>
                                            <th class="border border-slate-300 px-2 py-2 text-right font-semibold">
                                                è»Šè¼›è¼‰é‡ä¸‹ç·£æ‡‰åŠ›<br>fLL,bot (kgf/cmÂ²)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="stressCalcTableBody">
                                        <!-- Generated dynamically -->
                                    </tbody>
                                </table>
                            </div>

                            <div class="mt-6 text-xs text-slate-600 space-y-2">
                                <p><strong>è¨ˆç®—å…¬å¼ï¼š</strong></p>
                                <ul class="list-disc list-inside space-y-1">
                                    <li>é‹¼è…±åå¿ƒçŸ© ep,eff = Y_bot - 12.5 (cm)</li>
                                    <li>æœ‰æ•ˆé åŠ›å½çŸ© Meff = é åŠ›å€¼ Ã— ep,eff (+è¡¨ç¤ºåº•éƒ¨å—å£“ã€é ‚éƒ¨å—æ‹‰; -è¡¨ç¤ºåº•éƒ¨å—æ‹‰ã€é ‚éƒ¨å—å£“)</li>
                                    <li>æ–·é¢ä¸€æ¬¡çŸ© Stop = I_zz / Y_top</li>
                                    <li>æ–·é¢ä¸€æ¬¡çŸ© Sbot = I_zz / Y_bot</li>
                                    <li>è»¸å‘æ‡‰åŠ› faxial = é åŠ›å€¼ / æ–·é¢ç© (+å—å£“, -å—æ‹‰)</li>
                                    <li>ä¸Šç·£å½çŸ©æ‡‰åŠ› fm,top = -Meff / Stop (Meff>0æ™‚*-1è¡¨ç¤ºå—æ‹‰)</li>
                                    <li>ä¸‹ç·£å½çŸ©æ‡‰åŠ› fm,bot = Meff / Sbot (Meff>0è¡¨ç¤ºå—å£“)</li>
                                    <li>æ¢ä¸Šç·£æœ‰æ•ˆæ‡‰åŠ› feff,top = faxial + fm,top (+å—å£“, -å—æ‹‰)</li>
                                    <li>æ¢ä¸‹ç·£æœ‰æ•ˆæ‡‰åŠ› feff,bot = faxial + fm,bot</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Sub-tab 3: å£“å¼µæ‡‰åŠ›æª¢æ ¸ -->
                    <div id="subtab-content-4-3" class="subtab-content hidden">
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <h3 class="text-lg font-bold text-slate-800 mb-4">å£“å¼µæ‡‰åŠ›æª¢æ ¸</h3>

                            <!-- å®¹è¨±æ‡‰åŠ›æ¨™æº– -->
                            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                                <h4 class="text-sm font-bold text-blue-900 mb-2">æª¢æ ¸æ¨™æº–ï¼šCase No.1 å®Œå·¥éšæ®µ I, IB (100%)</h4>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <span class="text-blue-700">å®¹è¨±å£“æ‡‰åŠ›ï¼š</span>
                                        <span class="font-bold text-blue-900">â‰¤ 210.00 kgf/cmÂ²</span>
                                    </div>
                                    <div>
                                        <span class="text-blue-700">å®¹è¨±å¼µæ‡‰åŠ›ï¼š</span>
                                        <span class="font-bold text-blue-900">â‰¥ -14.97 kgf/cmÂ²</span>
                                    </div>
                                </div>
                            </div>

                            <!-- è¼‰é‡è¼¸å…¥å€å¡Š -->
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <!-- éœè¼‰é‡ç‰ˆå¡Š -->
                                <div class="bg-white rounded-lg border border-slate-200 shadow-sm p-4">
                                    <h4 class="text-sm font-bold text-slate-700 mb-3 border-l-4 border-green-500 pl-2">
                                        éœè¼‰é‡ç‰ˆå¡Š (Dead Load)</h4>

                                    <div class="space-y-3">
                                        <!-- Bridge Self-Weight -->
                                        <div class="bg-slate-50 p-3 rounded">
                                            <div class="flex justify-between items-center mb-1">
                                                <span class="text-xs text-slate-600">æ©‹æ¢å…¨é•·è‡ªé‡</span>
                                                <span class="text-sm font-bold text-slate-800">2030.82 tf</span>
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <span class="text-xs text-slate-600">æ©‹æ¢è‡ªé‡ (w)</span>
                                                <span class="text-sm font-bold text-slate-800">35.94 tf/m</span>
                                            </div>
                                        </div>

                                        <!-- Additional Load Input -->
                                        <div class="flex items-center justify-between">
                                            <label class="text-xs text-slate-600">é™„åŠ è¼‰é‡ (AC+ç®¡ç·š+è­·æ¬„)</label>
                                            <div class="flex items-center gap-2">
                                                <input type="number" id="dl-additional-tab4-3"
                                                    class="w-20 px-2 py-1 text-sm border border-slate-300 rounded focus:outline-none focus:border-green-500"
                                                    value="3.5" step="0.1" min="0"
                                                    oninput="syncDeadLoadInput(this.value)">
                                                <span class="text-xs text-slate-500">tf/m</span>
                                            </div>
                                        </div>

                                        <!-- Result -->
                                        <div class="bg-gray-100 p-4 rounded text-center mt-2">
                                            <div class="text-xs text-slate-500 mb-1">éœè¼‰é‡å½çŸ© M_DL</div>
                                            <div class="text-2xl font-bold text-gray-800 font-mono"
                                                id="val-m-dl-tab4-3">
                                                --</div>
                                            <div class="text-xs text-slate-400 mt-1">(w_self + w_add) * LÂ² / 8</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- è»Šè¼›è¼‰é‡ç‰ˆå¡Š -->
                                <div class="bg-white rounded-lg border border-slate-200 shadow-sm p-4">
                                    <h4 class="text-sm font-bold text-slate-700 mb-3 border-l-4 border-blue-500 pl-2">
                                        è»Šè¼›è¼‰é‡ç‰ˆå¡Š (Live Load)</h4>

                                    <div class="space-y-3">
                                        <!-- Base Values -->
                                        <div class="bg-slate-50 p-3 rounded">
                                            <div class="flex justify-between items-center mb-1">
                                                <span class="text-xs text-slate-600">æ©‹æ¢è¼‰é‡å½çŸ©</span>
                                                <span class="text-sm font-bold text-slate-800">499 tfÂ·m</span>
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <span class="text-xs text-slate-600">ç«¯é»å‰ªåŠ›</span>
                                                <span class="text-sm font-bold text-slate-800">49 tf</span>
                                            </div>
                                        </div>

                                        <!-- Sliders -->
                                        <div class="space-y-2">
                                            <div class="flex items-center justify-between">
                                                <label class="text-xs text-slate-600">è¡æ“Šä¿‚æ•¸ (IM)</label>
                                                <div class="flex items-center gap-2 flex-1 ml-3">
                                                    <input type="range" id="ll-impact-slider-tab4-3"
                                                        class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer"
                                                        min="0" max="0.3" step="0.01" value="0.3"
                                                        oninput="syncLiveLoadSlider('impact', this.value)">
                                                    <span
                                                        class="font-mono text-xs w-8 text-right font-bold text-blue-600"
                                                        id="val-ll-impact-tab4-3">0.3</span>
                                                </div>
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <label class="text-xs text-slate-600">è¶…è¼‰ä¿‚æ•¸ (OL)</label>
                                                <div class="flex items-center gap-2 flex-1 ml-3">
                                                    <input type="range" id="ll-overload-slider-tab4-3"
                                                        class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer"
                                                        min="0" max="0.3" step="0.01" value="0.3"
                                                        oninput="syncLiveLoadSlider('overload', this.value)">
                                                    <span
                                                        class="font-mono text-xs w-8 text-right font-bold text-blue-600"
                                                        id="val-ll-overload-tab4-3">0.3</span>
                                                </div>
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <label class="text-xs text-slate-600">è»Šé“æ•¸ (Lanes)</label>
                                                <div class="flex items-center gap-2 flex-1 ml-3">
                                                    <input type="range" id="ll-lanes-slider-tab4-3"
                                                        class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer"
                                                        min="1" max="4" step="1" value="4"
                                                        oninput="syncLiveLoadSlider('lanes', this.value)">
                                                    <span
                                                        class="font-mono text-xs w-8 text-right font-bold text-blue-600"
                                                        id="val-ll-lanes-tab4-3">4</span>
                                                </div>
                                            </div>
                                            <div class="flex items-center justify-between pt-1">
                                                <label class="text-xs text-slate-600">å¤šè»Šé“æŠ˜æ¸›ä¿‚æ•¸</label>
                                                <select id="ll-reduction-select-tab4-3"
                                                    class="text-xs px-2 py-1 border border-slate-300 rounded bg-white focus:outline-none focus:border-blue-500"
                                                    onchange="syncLiveLoadReduction(this.value)">
                                                    <option value="1.0" selected>100% (1-2è»Šé“)</option>
                                                    <option value="0.9">90% (3è»Šé“)</option>
                                                    <option value="0.75">75% (4+è»Šé“)</option>
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Result -->
                                        <div class="bg-blue-50 p-4 rounded text-center mt-3 border border-blue-100">
                                            <div class="text-xs text-blue-500 mb-1">è»Šè¼›è¼‰é‡å½çŸ© M_LL</div>
                                            <div class="text-2xl font-bold text-blue-800 font-mono"
                                                id="val-m-ll-tab4-3">--</div>
                                            <div class="text-xs text-blue-400 mt-1">M Ã— (1+IM) Ã— (1+OL) Ã— Red Ã— N</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="overflow-x-auto">
                                <table class="w-full border-collapse text-xs">
                                    <thead>
                                        <tr class="bg-slate-100">
                                            <th class="border border-slate-300 px-2 py-2 text-center font-semibold"
                                                rowspan="2">ç¯€æ®µ #</th>
                                            <th class="border border-slate-300 px-2 py-2 text-center font-semibold"
                                                colspan="2">æœ‰æ•ˆé åŠ›æ‡‰åŠ›</th>
                                            <th class="border border-slate-300 px-2 py-2 text-center font-semibold"
                                                colspan="2">æ¢è‡ªé‡æ‡‰åŠ›</th>
                                            <th class="border border-slate-300 px-2 py-2 text-center font-semibold"
                                                colspan="2">è»Šè¼›è¼‰é‡æ‡‰åŠ›</th>
                                            <th class="border border-slate-300 px-2 py-2 text-center font-semibold bg-amber-50"
                                                colspan="2">ç¸½æ‡‰åŠ›</th>
                                            <th class="border border-slate-300 px-2 py-2 text-center font-semibold bg-green-50"
                                                colspan="2">æª¢æ ¸çµæœ</th>
                                        </tr>
                                        <tr class="bg-slate-50">
                                            <th class="border border-slate-300 px-2 py-2 text-center text-xs">
                                                ä¸Šç·£<br>feff,top</th>
                                            <th class="border border-slate-300 px-2 py-2 text-center text-xs">
                                                ä¸‹ç·£<br>feff,bot</th>
                                            <th class="border border-slate-300 px-2 py-2 text-center text-xs">
                                                ä¸Šç·£<br>fDL,top</th>
                                            <th class="border border-slate-300 px-2 py-2 text-center text-xs">
                                                ä¸‹ç·£<br>fDL,bot</th>
                                            <th class="border border-slate-300 px-2 py-2 text-center text-xs">
                                                ä¸Šç·£<br>fLL,top</th>
                                            <th class="border border-slate-300 px-2 py-2 text-center text-xs">
                                                ä¸‹ç·£<br>fLL,bot</th>
                                            <th
                                                class="border border-slate-300 px-2 py-2 text-center text-xs bg-amber-50">
                                                ä¸Šç·£<br>ftotal,top</th>
                                            <th
                                                class="border border-slate-300 px-2 py-2 text-center text-xs bg-amber-50">
                                                ä¸‹ç·£<br>ftotal,bot</th>
                                            <th
                                                class="border border-slate-300 px-2 py-2 text-center text-xs bg-green-50">
                                                ä¸Šç·£</th>
                                            <th
                                                class="border border-slate-300 px-2 py-2 text-center text-xs bg-green-50">
                                                ä¸‹ç·£</th>
                                        </tr>
                                    </thead>
                                    <tbody id="stressVerifyTableBody">
                                        <!-- Generated dynamically -->
                                    </tbody>
                                </table>
                            </div>

                            <div class="mt-6 text-xs text-slate-600 space-y-2">
                                <p><strong>è¨ˆç®—å…¬å¼ï¼š</strong></p>
                                <ul class="list-disc list-inside space-y-1">
                                    <li>æ¢ä¸Šç·£ç¸½æ‡‰åŠ› ftotal,top = feff,top + fDL,top + fLL,top (kgf/cmÂ²)</li>
                                    <li>æ¢ä¸‹ç·£ç¸½æ‡‰åŠ› ftotal,bot = feff,bot + fDL,bot + fLL,bot (kgf/cmÂ²)</li>
                                </ul>
                                <p class="mt-3"><strong>æª¢æ ¸æ¢ä»¶ï¼š</strong></p>
                                <ul class="list-disc list-inside space-y-1">
                                    <li class="text-green-700">âœ“ OKï¼š-14.97 â‰¤ æ‡‰åŠ› â‰¤ 210.00 kgf/cmÂ²</li>
                                    <li class="text-red-700">âœ— NGï¼šæ‡‰åŠ› &lt; -14.97 æˆ– æ‡‰åŠ› &gt; 210.00 kgf/cmÂ²</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Tab 5 Content (åŠ å›ºåˆ†æåœ–è¡¨) -->
            <div id="tab-content-5" class="tab-content-wrapper hidden">
                <div id="tab-content-5-inner" class="tab-content space-y-6">

                    <!-- External Prestress Geometry Configuration -->
                    <div class="bg-white rounded-lg shadow-sm p-4 border-l-4 border-amber-500">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-sm font-bold text-amber-800">å¤–ç½®é åŠ›å¹¾ä½•</h3>
                            <span class="text-xs text-amber-500 bg-amber-50 px-2 py-1 rounded">å¹¾ä½•é…ç½®</span>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- éŒ¨ç¢‡å€è¨­å®š -->
                            <div class="border border-slate-200 rounded-lg p-3 bg-slate-50">
                                <h4 class="text-xs font-bold text-slate-700 mb-3">éŒ¨ç¢‡å€è¨­å®š (å¾æ¢æ·±åº¦é ‚éƒ¨èµ·ç®—)</h4>

                                <div class="space-y-3">
                                    <!-- Force Input -->
                                    <div class="border-b border-slate-200 pb-3 mb-3">
                                        <label class="block text-xs font-bold text-slate-700 mb-1">å¤–ç½®é åŠ›åŠ›é‡ (P)</label>
                                        <div class="flex items-center gap-2">
                                            <input type="number" id="ext-force-input"
                                                class="w-full px-2 py-1 text-sm border border-slate-300 rounded focus:outline-none focus:border-amber-500 font-mono text-amber-700 font-bold"
                                                value="2100" step="10" oninput="updateExtForceTf(this.value)">
                                            <span class="text-xs text-slate-500 font-bold">tf</span>
                                        </div>
                                    </div>

                                    <!-- æ»‘å‹•ç«¯ -->
                                    <div>
                                        <label class="block text-xs text-slate-600 mb-1">æ»‘å‹•ç«¯ (X = 0 m, N1)</label>
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="text-xs text-slate-500">æ¢æ·±åº¦ä½ç½® Y:</span>
                                            <input type="number" id="anchorage-sliding-y"
                                                class="w-20 px-2 py-1 text-sm border border-slate-300 rounded focus:outline-none focus:border-amber-500"
                                                value="100" min="0" max="278" step="1"
                                                oninput="updateAnchorageY('sliding', this.value, 'input')">
                                            <span class="text-xs text-slate-500">cm</span>
                                        </div>
                                        <input type="range" id="anchorage-sliding-y-slider" class="slider-amber" min="0"
                                            max="278" step="1" value="100"
                                            oninput="updateAnchorageY('sliding', this.value, 'slider')">
                                    </div>

                                    <!-- é‰¸æ¥ç«¯ -->
                                    <div>
                                        <label class="block text-xs text-slate-600 mb-1">é‰¸æ¥ç«¯ (X = 56.5 m, N30)</label>
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="text-xs text-slate-500">æ¢æ·±åº¦ä½ç½® Y:</span>
                                            <input type="number" id="anchorage-hinged-y"
                                                class="w-20 px-2 py-1 text-sm border border-slate-300 rounded focus:outline-none focus:border-amber-500"
                                                value="100" min="0" max="278" step="1"
                                                oninput="updateAnchorageY('hinged', this.value, 'input')">
                                            <span class="text-xs text-slate-500">cm</span>
                                        </div>
                                        <input type="range" id="anchorage-hinged-y-slider" class="slider-amber" min="0"
                                            max="278" step="1" value="100"
                                            oninput="updateAnchorageY('hinged', this.value, 'slider')">
                                    </div>
                                </div>
                            </div>

                            <!-- è½‰å‘å¡Šè¨­å®š -->
                            <div class="border border-slate-200 rounded-lg p-3 bg-slate-50">
                                <h4 class="text-xs font-bold text-slate-700 mb-3">è½‰å‘å¡Šè¨­å®š (å‚ç›´ä½ç½®è²¼é½Šæ¢åº•)</h4>

                                <div class="space-y-3">
                                    <!-- è½‰å‘å¡Šæ•¸é‡ -->
                                    <div>
                                        <label class="block text-xs text-slate-600 mb-1">è½‰å‘å¡Šæ•¸é‡</label>
                                        <select id="deviation-block-count"
                                            class="text-sm px-3 py-1 border border-slate-300 rounded bg-white focus:outline-none focus:border-amber-500"
                                            onchange="updateDeviationBlockCount(this.value)">
                                            <option value="1">1 å€‹</option>
                                            <option value="2" selected>2 å€‹</option>
                                        </select>
                                    </div>

                                    <!-- è½‰å‘å¡Š1 -->
                                    <div>
                                        <label class="block text-xs text-slate-600 mb-1">è½‰å‘å¡Š 1</label>
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="text-xs text-slate-500">æ°´å¹³ä½ç½® X:</span>
                                            <input type="number" id="deviation-block-1-x"
                                                class="w-24 px-2 py-1 text-sm border border-slate-300 rounded focus:outline-none focus:border-amber-500"
                                                value="14.125" min="0" max="28.25" step="0.001"
                                                oninput="updateDeviationBlockX(1, this.value, 'input')">
                                            <span class="text-xs text-slate-500">m</span>
                                        </div>
                                        <input type="range" id="deviation-block-1-x-slider" class="slider-amber" min="0"
                                            max="28.25" step="0.001" value="14.125"
                                            oninput="updateDeviationBlockX(1, this.value, 'slider')">
                                        <div class="flex gap-2 mt-2">
                                            <button
                                                class="px-2 py-1 text-xs bg-slate-200 text-slate-700 rounded hover:bg-slate-300 transition-colors"
                                                onclick="updateDeviationBlockX(1, 14.125, 'button')">L/4</button>
                                            <button
                                                class="px-2 py-1 text-xs bg-slate-200 text-slate-700 rounded hover:bg-slate-300 transition-colors"
                                                onclick="updateDeviationBlockX(1, 18.833, 'button')">L/3</button>
                                            <button
                                                class="px-2 py-1 text-xs bg-slate-200 text-slate-700 rounded hover:bg-slate-300 transition-colors"
                                                onclick="updateDeviationBlockX(1, 28.25, 'button')">L/2</button>
                                        </div>
                                    </div>

                                    <!-- è½‰å‘å¡Š2 -->
                                    <div id="deviation-block-2-container">
                                        <label class="block text-xs text-slate-600 mb-1">è½‰å‘å¡Š 2</label>
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="text-xs text-slate-500">æ°´å¹³ä½ç½® X:</span>
                                            <input type="number" id="deviation-block-2-x"
                                                class="w-24 px-2 py-1 text-sm border border-slate-300 rounded focus:outline-none focus:border-amber-500"
                                                value="42.375" min="28.25" max="56.5" step="0.001"
                                                oninput="updateDeviationBlockX(2, this.value, 'input')">
                                            <span class="text-xs text-slate-500">m</span>
                                        </div>
                                        <input type="range" id="deviation-block-2-x-slider" class="slider-amber"
                                            min="28.25" max="56.5" step="0.001" value="42.375"
                                            oninput="updateDeviationBlockX(2, this.value, 'slider')">
                                        <div class="flex gap-2 mt-2">
                                            <button
                                                class="px-2 py-1 text-xs bg-slate-200 text-slate-700 rounded hover:bg-slate-300 transition-colors"
                                                onclick="updateDeviationBlockX(2, 37.667, 'button')">2L/3</button>
                                            <button
                                                class="px-2 py-1 text-xs bg-slate-200 text-slate-700 rounded hover:bg-slate-300 transition-colors"
                                                onclick="updateDeviationBlockX(2, 42.375, 'button')">3L/4</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Results Block -->
                    <div class="mt-4 border border-slate-200 rounded-lg p-3 bg-white">
                        <h4 class="text-xs font-bold text-slate-700 mb-2 border-l-4 border-blue-500 pl-2">å¤–ç½®é åŠ›åˆ†åŠ›è¨ˆç®—çµæœ
                            (Components)</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs text-center border-collapse">
                                <thead>
                                    <tr class="bg-slate-100 text-slate-600">
                                        <th class="border border-slate-200 p-2">ä½ç½® (Location)</th>
                                        <th class="border border-slate-200 p-2">è»¸å‘å£“åŠ› (Axial Comp.)</th>
                                        <th class="border border-slate-200 p-2">å‚ç›´åˆ†åŠ› (Vertical Shear/Lift)</th>
                                        <th class="border border-slate-200 p-2 text-left pl-3">èªªæ˜ (Notes)</th>
                                    </tr>
                                </thead>
                                <tbody class="text-slate-700">
                                    <tr class="hover:bg-slate-50">
                                        <td class="border border-slate-200 p-2 font-bold">éŒ¨éŒ å€ N1</td>
                                        <td class="border border-slate-200 p-2 text-blue-600 font-mono font-bold"
                                            id="res-n1-axial">-- tf</td>
                                        <td class="border border-slate-200 p-2 text-red-600 font-mono font-bold"
                                            id="res-n1-shear">-- tf</td>
                                        <td class="border border-slate-200 p-2 text-left pl-3 text-slate-500">å‘ä¸‹å‰ªåŠ› (Down
                                            Shear)</td>
                                    </tr>
                                    <tr class="hover:bg-slate-50">
                                        <td class="border border-slate-200 p-2 font-bold">éŒ¨éŒ å€ N30</td>
                                        <td class="border border-slate-200 p-2 text-blue-600 font-mono font-bold"
                                            id="res-n30-axial">-- tf</td>
                                        <td class="border border-slate-200 p-2 text-red-600 font-mono font-bold"
                                            id="res-n30-shear">-- tf</td>
                                        <td class="border border-slate-200 p-2 text-left pl-3 text-slate-500">å‘ä¸‹å‰ªåŠ› (Down
                                            Shear)</td>
                                    </tr>
                                    <tr class="hover:bg-slate-50">
                                        <td class="border border-slate-200 p-2 font-bold">è½‰å‘å¡Š 1</td>
                                        <td class="border border-slate-200 p-2 text-slate-300">-</td>
                                        <td class="border border-slate-200 p-2 text-green-600 font-mono font-bold"
                                            id="res-b1-lift">-- tf</td>
                                        <td class="border border-slate-200 p-2 text-left pl-3 text-slate-500">å‘ä¸Šä¸ŠæŠ¬
                                            (Upward Lift)</td>
                                    </tr>
                                    <tr id="res-row-between-blocks" class="hover:bg-slate-50 bg-amber-50">
                                        <td class="border border-slate-200 p-2 font-bold text-amber-800">è½‰å‘å¡Šé–“ (B1-B2)
                                        </td>
                                        <td class="border border-slate-200 p-2 text-blue-600 font-mono font-bold"
                                            id="res-between-axial">-- tf</td>
                                        <td class="border border-slate-200 p-2 text-slate-400">0 tf</td>
                                        <td class="border border-slate-200 p-2 text-left pl-3 text-slate-500">ç´”è»¸å‘å£“åŠ›
                                            (Pure Axial)</td>
                                    </tr>
                                    <tr id="res-row-b2" class="hover:bg-slate-50">
                                        <td class="border border-slate-200 p-2 font-bold">è½‰å‘å¡Š 2</td>
                                        <td class="border border-slate-200 p-2 text-slate-300">-</td>
                                        <td class="border border-slate-200 p-2 text-green-600 font-mono font-bold"
                                            id="res-b2-lift">-- tf</td>
                                        <td class="border border-slate-200 p-2 text-left pl-3 text-slate-500">å‘ä¸Šä¸ŠæŠ¬
                                            (Upward Lift)</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Profile Canvas 2 (With Ext) -->
                    <div>
                        <h3 class="text-sm font-bold text-slate-700 mb-2 border-l-4 border-amber-500 pl-2">ç¸±å‘ç¯€æ®µä½ˆç½®åœ–
                            (å«å¤–ç½®é åŠ›)</h3>
                        <div class="overflow-x-auto -mx-5 px-5">
                            <canvas id="profileCanvas2" width="1200" height="200"
                                class="canvas-drawing min-w-full"></canvas>
                        </div>
                        <div class="flex justify-center space-x-4 mt-1 text-xs text-slate-500">
                            <span class="flex items-center"><span class="w-3 h-1 bg-red-500 mr-1"></span> å¤–ç½®é åŠ›</span>
                            <span class="flex items-center"><span class="w-2 h-2 bg-slate-700 mr-1"></span> è½‰å‘å¡Š</span>
                        </div>
                    </div>

                    <!-- Data Table with Ext Force -->
                    <div class="overflow-hidden">
                        <div class="flex justify-between items-end mb-2">
                            <h3 class="text-sm font-bold text-slate-700 border-l-4 border-blue-500 pl-2">å„ç¯€æ®µå¤–ç½®é åŠ›æ•¸æ“šè¡¨
                            </h3>
                            <span class="text-xs text-slate-400" id="tableUnitLabel3">å–®ä½: tf, cm</span>
                        </div>
                        <div class="overflow-x-auto max-h-[500px] overflow-y-auto border border-slate-200 rounded">
                            <table class="w-full data-table">
                                <thead class="sticky top-0 z-10 shadow-sm">
                                    <tr>
                                        <th class="bg-slate-100 p-2 border-r border-white">ç¯€æ®µ #</th>
                                        <th class="bg-slate-100 p-2 border-r border-white">å°æ‡‰ç¯€é» (Node)</th>
                                        <th class="bg-slate-100 p-2 border-r border-white">é•·åº¦ (m)</th>
                                        <th class="bg-amber-50 p-2 border-r border-white text-amber-900 font-bold">å¤–ç½®é åŠ›
                                            (Force) <span class="text-xs block font-normal">(tf)</span></th>
                                        <th class="bg-slate-200 p-2 border-r border-white text-slate-700 font-bold">
                                            å¤–ç½®é åŠ›ä½ç½®(å¾é ‚éƒ¨) <span class="text-xs block font-normal">(cm)</span></th>
                                        <th class="bg-green-50 p-2 border-r border-white text-green-900 font-bold">
                                            å¤–ç½®é åŠ›åå¿ƒçŸ© (ep_ext) <span class="text-xs block font-normal">(cm)</span></th>
                                        <th class="bg-blue-50 p-2 border-r border-white text-blue-900 font-bold">
                                            å¤–ç½®é åŠ›æœ‰æ•ˆå½çŸ© (Meff_ext) <span class="text-xs block font-normal">(tf-m)</span>
                                        </th>
                                        <th class="bg-cyan-50 p-2 border-r border-white text-cyan-900 font-bold">
                                            ä¸Šç·£å¤–ç½®å½çŸ©æ‡‰åŠ› (fm_ext,top)
                                            <span class="text-xs block font-normal">(kgf/cmÂ²)</span>
                                        </th>
                                        <th class="bg-cyan-100 p-2 border-r border-white text-cyan-900 font-bold">
                                            ä¸‹ç·£å¤–ç½®å½çŸ©æ‡‰åŠ› (fm_ext,bot)
                                            <span class="text-xs block font-normal">(kgf/cmÂ²)</span>
                                        </th>
                                        <th class="bg-purple-50 p-2 border-r border-white text-purple-900 font-bold">
                                            å¤–ç½®é åŠ›è»¸å‘æ‡‰åŠ› (faxial_ext)
                                            <span class="text-xs block font-normal">(kgf/cmÂ²)</span>
                                        </th>
                                        <th class="bg-indigo-50 p-2 border-r border-white text-indigo-900 font-bold">
                                            æ¢ä¸Šç·£å¤–ç½®æœ‰æ•ˆæ‡‰åŠ› (feff,top_ext)
                                            <span class="text-xs block font-normal">(kgf/cmÂ²)</span>
                                        </th>
                                        <th class="bg-indigo-100 p-2 text-indigo-900 font-bold">æ¢ä¸‹ç·£å¤–ç½®æœ‰æ•ˆæ‡‰åŠ› (feff,bot_ext)
                                            <span class="text-xs block font-normal">(kgf/cmÂ²)</span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="stressTableBody3">
                                    <!-- Generated -->
                                </tbody>
                            </table>
                            <div class="mt-4 p-4 bg-slate-50 border border-slate-200 rounded text-sm text-slate-600">
                                <h4 class="font-bold text-slate-800 mb-2">æ¬„ä½èªªæ˜ï¼š</h4>
                                <ul class="list-disc pl-5 space-y-1">
                                    <li><strong>å¤–ç½®é åŠ›åå¿ƒçŸ© ep_ext</strong> = å¤–ç½®é åŠ›ä½ç½®(å¾é ‚éƒ¨) - Y_top</li>
                                    <li><strong>å¤–ç½®é åŠ›æœ‰æ•ˆå½çŸ© Meff_ext</strong> = Force * ep_ext / 100</li>
                                    <li><strong>ä¸Šç·£å¤–ç½®å½çŸ©æ‡‰åŠ› fm_ext,top</strong> = -1 * Meff_ext / Stop</li>
                                    <li><strong>ä¸‹ç·£å¤–ç½®å½çŸ©æ‡‰åŠ› fm_ext,bot</strong> = Meff_ext / Sbot</li>
                                    <li><strong>å¤–ç½®é åŠ›è»¸å‘æ‡‰åŠ› faxial_ext</strong> = Force / Area</li>
                                    <li><strong>æ¢ä¸Šç·£å¤–ç½®æœ‰æ•ˆæ‡‰åŠ› feff,top_ext</strong> = fm_ext,top + faxial_ext</li>
                                    <li><strong>æ¢ä¸‹ç·£å¤–ç½®æœ‰æ•ˆæ‡‰åŠ› feff,bot_ext</strong> = fm_ext,bot + faxial_ext</li>
                                </ul>
                            </div>
                        </div>
                    </div>



                </div>
            </div>

            <!-- Tab 6 Content (æ‡‰åŠ›æª¢æ ¸-åŠ å›ºéšæ®µ) -->
            <div id="tab-content-6" class="tab-content-wrapper hidden">
                <div id="tab-content-6-inner" class="tab-content space-y-6">



                    <!-- Section 4: Strengthening Stress Verify Table -->
                    <div class="overflow-hidden">
                        <div class="flex justify-between items-end mb-2">
                            <h3 class="text-sm font-bold text-slate-700 border-l-4 border-purple-500 pl-2">åŠ å›ºæ‡‰åŠ›æª¢æ ¸è¡¨
                            </h3>
                            <span class="text-xs text-slate-400">å–®ä½: kgf/cmÂ²</span>
                        </div>
                        <div class="overflow-x-auto border border-slate-200 rounded shadow-sm">
                            <table class="w-full data-table text-sm">
                                <thead class="bg-slate-800 text-white sticky top-0 z-10">
                                    <tr>
                                        <th rowspan="2" class="p-2 border border-slate-600">ç¯€æ®µ #</th>
                                        <th colspan="2" class="p-2 border border-slate-600 bg-slate-700">ç¸½æ‡‰åŠ› (èˆ‡åˆ†é 4é€£å‹•)
                                        </th>
                                        <th colspan="2" class="p-2 border border-slate-600 bg-amber-700">å¤–ç½®æœ‰æ•ˆæ‡‰åŠ› (èˆ‡åˆ†é 5é€£å‹•)
                                        </th>
                                        <th colspan="2" class="p-2 border border-slate-600 bg-purple-700">åŠ å›ºå¾Œæ‡‰åŠ›
                                            (kgf/cmÂ²)</th>
                                        <th colspan="2" class="p-2 border border-slate-600 bg-slate-700">æª¢æ ¸çµæœ</th>
                                    </tr>
                                    <tr>
                                        <!-- Total (Tab 4) -->
                                        <th class="p-2 border border-slate-600 bg-slate-600 text-xs">ä¸Šç·£<br>ftotal,top
                                        </th>
                                        <th class="p-2 border border-slate-600 bg-slate-600 text-xs">ä¸‹ç·£<br>ftotal,bot
                                        </th>
                                        <!-- Ext (Tab 5) -->
                                        <th class="p-2 border border-slate-600 bg-amber-600 text-xs">ä¸Šç·£<br>feff,ext,top
                                        </th>
                                        <th class="p-2 border border-slate-600 bg-amber-600 text-xs">ä¸‹ç·£<br>feff,ext,bot
                                        </th>
                                        <!-- Strengthened -->
                                        <th class="p-2 border border-slate-600 bg-purple-600 text-xs">ä¸Šç·£<br>(Total+Ext)
                                        </th>
                                        <th class="p-2 border border-slate-600 bg-purple-600 text-xs">ä¸‹ç·£<br>(Total+Ext)
                                        </th>
                                        <!-- Check -->
                                        <th class="p-2 border border-slate-600 bg-slate-600 text-xs">ä¸Šç·£</th>
                                        <th class="p-2 border border-slate-600 bg-slate-600 text-xs">ä¸‹ç·£</th>
                                    </tr>
                                </thead>
                                <tbody id="strengtheningVerifyTableBody">
                                    <!-- Dynamic Content -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-4 p-4 bg-slate-50 border border-slate-200 rounded text-sm text-slate-600">
                            <p class="mb-2"><strong>æª¢æ ¸èªªæ˜ï¼š</strong></p>
                            <ul class="list-disc list-inside space-y-1">
                                <li><strong>åŠ å›ºå¾Œæ‡‰åŠ› (ä¸Šç·£)</strong> = ç¸½æ‡‰åŠ›ä¸Šç·£ (Tab 4) + å¤–ç½®æœ‰æ•ˆæ‡‰åŠ›ä¸Šç·£ (Tab 5)</li>
                                <li><strong>åŠ å›ºå¾Œæ‡‰åŠ› (ä¸‹ç·£)</strong> = ç¸½æ‡‰åŠ›ä¸‹ç·£ (Tab 4) + å¤–ç½®æœ‰æ•ˆæ‡‰åŠ›ä¸‹ç·£ (Tab 5)</li>
                                <li class="mt-2 text-green-700">âœ“ OKï¼š-14.97 â‰¤ æ‡‰åŠ› â‰¤ 210.00 kgf/cmÂ²</li>
                                <li class="text-red-700">âœ— NGï¼šæ‡‰åŠ› < -14.97 æˆ– æ‡‰åŠ›> 210.00 kgf/cmÂ²</li>
                            </ul>
                        </div>
                    </div>

                </div>
            </div>

    </main>

    <script>
        // --- é é‘„ç®±å‹æ¢æˆªé¢åƒæ•¸ (å–®ä½: cm, cmÂ², cmâ´) ---
        const BEAM_SECTIONS = [
            { id: 1, A: 25, C: 35, D: 70, Y_top: 97.13, Y_bot: 181.27, Area: 142399.00, I: 1526183555.35 },
            { id: 2, A: 28.3, C: 40, D: 75.7, Y_top: 101.71, Y_bot: 176.69, Area: 148772.65, I: 1626592843.68 },
            { id: 3, A: 31.5, C: 45, D: 81.5, Y_top: 105.73, Y_bot: 172.67, Area: 154965.75, I: 1716080621.37 },
            { id: 4, A: 31.3, C: 40, D: 75.7, Y_top: 104.82, Y_bot: 173.58, Area: 152342.65, I: 1692242685.97 },
            { id: 5, A: 37.5, C: 45, D: 81.5, Y_top: 111.24, Y_bot: 167.76, Area: 162045.75, I: 1829852831.37 }
        ];

        // ç¯€æ®µå°æ‡‰ç¯€é»å°æ‡‰è¡¨
        const SEGMENT_NODE_MAP = {
            1: 3, 2: 2,
            // 3~27 å°æ‡‰åˆ° 1
            3: 1, 4: 1, 5: 1, 6: 1, 7: 1, 8: 1, 9: 1, 10: 1, 11: 1, 12: 1,
            13: 1, 14: 1, 15: 1, 16: 1, 17: 1, 18: 1, 19: 1, 20: 1, 21: 1, 22: 1,
            23: 1, 24: 1, 25: 1, 26: 1, 27: 1,
            28: 4, 29: 5
        };

        // å–å¾—å°æ‡‰ç¯€é»
        function getSegmentNode(segmentId) {
            return SEGMENT_NODE_MAP[segmentId] || 1;
        }

        // è¨ˆç®—å½çŸ©æ‰¿è¼‰åŠ›
        function calcBendingMoment(segmentId, prestress) {
            const nodeId = getSegmentNode(segmentId);
            const section = BEAM_SECTIONS.find(s => s.id === nodeId);
            if (!section) return 0;

            const prestressPos = 12.5; // é åŠ›ä½œç”¨ä½ç½® (cm from bottom)
            const eccentricity = Math.abs(section.Y_bot - prestressPos); // åå¿ƒå€¼ (cm)
            const moment = prestress * eccentricity; // å½çŸ© (tfÂ·cm)

            return { eccentricity, moment };
        }

        // è¨ˆç®—ç®±å‹æ¢æ…£æ€§çŸ©ï¼ˆç¹xè»¸ï¼‰
        function calcMomentOfInertia(section) {
            // å–®ä½: cm -> m (1cm = 0.01m)
            const B = section.B / 100;      // å¤–å¯¬ (m)
            const D = section.D / 100;      // å¤–é«˜ (m)
            const t_w = section.A / 100;    // è…¹æ¿åšåº¦ (m)
            const t_f = section.C / 100;    // ç¿¼æ¿åšåº¦ (m)

            // å…§å¯¬
            const B_inner = B - 2 * t_w;
            // å…§é«˜
            const D_inner = D - 2 * t_f;

            // è¨ˆç®—æ…£æ€§çŸ©: I = (B*DÂ³)/12 - ((B-2*t_w)*(D-2*t_f)Â³)/12
            const I_outer = (B * Math.pow(D, 3)) / 12;
            const I_inner = (B_inner * Math.pow(D_inner, 3)) / 12;
            const I = I_outer - I_inner;

            return I;
        }

        // --- Geometry Config ---
        const SEGMENT_GEOMETRY = [
            { count: 1, length: 1.96, type: 'start', desc: 'ç«¯éƒ¨' },
            { count: 11, length: 2.00, type: 'standard', desc: 'æ¨™æº–' },
            { count: 1, length: 1.50, type: 'special', desc: 'åˆé¾' },
            { count: 15, length: 2.00, type: 'standard', desc: 'æ¨™æº–' },
            { count: 1, length: 1.04, type: 'end', desc: 'ç«¯éƒ¨' }
        ];

        // User Custom Data (tf)
        const INTERNAL_PRESTRESS_TF = [
            1730, 1765, 1782, 3371, 3406, 4934, 4963, 4984, 6414, 6426, 6430, 6427,
            6296,
            6286, 6380, 6357, 6326, 6288, 6242, 4825, 4779, 4726, 3251, 3206, 1692, 1663, 127, 126, 125
        ];

        // --- State ---
        const state = {
            unit: 'tf', // default
            currentTab: 1,
            extStrands: 6,
            extForcePerStrandKn: 200,
            deviatorPos: 18.5,
            span: 56.5,
            segments: [],
            nodes: [], // x positions for drawing
            M_DL: 0, // éœè¼‰é‡å½çŸ© (tfÂ·m) - from Tab 2
            M_LL: 0,  // è»Šè¼›è¼‰é‡å½çŸ© (tfÂ·m) - from Tab 2
            // External Prestress Geometry State
            extGeometry: {
                forceTf: 2100,
                anchorage: {
                    sliding: { x: 0, y: 100 },      // cm from top (X fixed at 0)
                    hinged: { x: 56.5, y: 100 }     // cm from top (X fixed at 56.5)
                },
                deviationBlocks: {
                    count: 2,
                    blocks: [
                        { x: 14.125, y: 278 }, // Block 1 (Y will be calculated as beam depth)
                        { x: 42.375, y: 278 }  // Block 2
                    ]
                }
            },
            extResults: {
                n1_axial: 0,
                n30_axial: 0
            }
        };


        let bendingMomentChartInst = null;

        // --- Init ---
        function init() {
            generateSegments();
            addListeners();
            updateCalculations();
            renderSectionInfo(); // Load section info on init
            // Initial Draw
            drawProfile(1, false); // Tab 1: No Ext (åŸºæœ¬è³‡è¨Š)
            drawProfile(3, false); // Tab 3: Basic profile (é åŠ›é…ç½®)
            drawProfile2();  // Tab 5: With Ext (å¤–ç½®é åŠ›å¹¾ä½•)
            drawSectionDiagram(); // Tab 3: Section diagram
            // Initialize design loads calculations for Tab 2
            updateDeadLoad();
            updateLiveLoad();
            renderSegmentMomentTable();
        }

        function switchTab(tabId) {
            state.currentTab = tabId;

            // Animate out
            const content1 = document.getElementById('tab-content-1');
            const content2 = document.getElementById('tab-content-2');
            const content3 = document.getElementById('tab-content-3');
            const content4 = document.getElementById('tab-content-4');
            const content5 = document.getElementById('tab-content-5');
            const content6 = document.getElementById('tab-content-6');

            // Ensure target is visible before animation logic might hide it
            const targetContent = document.getElementById(`tab-content-${tabId}`);
            if (targetContent) targetContent.classList.remove('hidden');

            // Setup fade out for others
            const allContent = [content1, content2, content3, content4, content5, content6];
            const otherContent = allContent.filter((_, i) => i !== tabId - 1);

            // Fade out others
            otherContent.forEach(el => {
                el.style.animation = 'none';
                void el.offsetWidth;
                el.style.animation = 'slideDown 0.35s cubic-bezier(0.4, 0, 0.2, 1) reverse';
            });

            setTimeout(() => {
                otherContent.forEach(el => el.classList.add('hidden'));

                // Fade in target
                targetContent.style.animation = 'none';
                void targetContent.offsetWidth;
                targetContent.style.animation = 'slideDown 0.35s cubic-bezier(0.4, 0, 0.2, 1)';
            }, 100);

            // Draw profile and tables if tab 2 (Design Loads)
            if (tabId === 2) {
                setTimeout(() => {
                    drawProfile(3, false); // Canvas 3 (Tab 2)
                    updateDeadLoad();
                    updateLiveLoad();
                    renderSegmentMomentTable();
                }, 400);
            }

            // Draw profile if tab 3 (Internal Prestress)
            if (tabId === 3) {
                setTimeout(() => {
                    drawProfile(1, false); // Canvas 1 (Tab 3)
                }, 400);
            }

            // Draw profile if tab 5 (External Reinforcement)
            if (tabId === 5) {
                setTimeout(() => {
                    drawProfile2();
                }, 400);
            }

            // Draw profile if tab 6
            if (tabId === 6) {
                setTimeout(() => {
                    renderStrengtheningVerifyTable();
                }, 100);
            }

            // Toggle Buttons
            ['tab-btn-1', 'tab-btn-2', 'tab-btn-3', 'tab-btn-4', 'tab-btn-5', 'tab-btn-6'].forEach(btnId => {
                document.getElementById(btnId).classList.remove('tab-active');
                document.getElementById(btnId).classList.add('tab-inactive');
            });

            document.getElementById(`tab-btn-${tabId}`).classList.remove('tab-inactive');
            document.getElementById(`tab-btn-${tabId}`).classList.add('tab-active');



            // Render section info if tab 1
            if (tabId === 1) {
                renderSectionInfo();
            }

            // Unit Control Visibility: Hide on Tab 2
            const unitControls = document.getElementById('unit-controls');
            if (unitControls) {
                if (tabId === 2) {
                    unitControls.style.display = 'none';
                } else {
                    unitControls.style.display = 'flex';
                }
            }
        }

        // å­åˆ†é åˆ‡æ›å‡½æ•¸ (Tab 5 æ‡‰åŠ›æª¢æ ¸)
        function switchSubTab(tabId, subTabNum) {
            // Hide all subtabs
            const subtabs = document.querySelectorAll('.subtab-content');
            subtabs.forEach(subtab => subtab.classList.add('hidden'));

            // Show selected subtab
            const selectedSubTab = document.getElementById(`subtab-content-${tabId}-${subTabNum}`);
            if (selectedSubTab) selectedSubTab.classList.remove('hidden');

            // Update button styles
            for (let i = 1; i <= 3; i++) {
                const btn = document.getElementById(`subtab-btn-${tabId}-${i}`);
                if (btn) {
                    if (i === subTabNum) {
                        btn.classList.remove('text-slate-600', 'border-transparent');
                        btn.classList.add('text-blue-600', 'border-blue-600');
                    } else {
                        btn.classList.remove('text-blue-600', 'border-blue-600');
                        btn.classList.add('text-slate-600', 'border-transparent');
                    }
                }
            }
        }

        function renderSectionInfo() {
            renderSectionInfoTable();
        }

        function renderSectionInfoTable() {
            const tbody = document.getElementById('sectionInfoBody');
            tbody.innerHTML = '';

            BEAM_SECTIONS.forEach(section => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="font-bold text-center text-blue-600">ç¯€é» ${section.id}</td>
                    <td class="text-center text-slate-600">${section.A} / ${section.C} / ${section.D}</td>
                    <td class="text-center text-purple-600 font-bold">${section.Area.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="text-center text-blue-600 font-bold">${section.Y_top.toFixed(2)}</td>
                    <td class="text-center text-blue-600 font-bold">${section.Y_bot.toFixed(2)}</td>
                    <td class="text-center text-green-600 font-bold">${section.I.toLocaleString('en-US', { maximumFractionDigits: 2 })}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function generateSegments() {
            let x = 0;
            let id = 1;
            state.segments = [];
            state.nodes = [];

            state.nodes.push(0); // Node 1 at 0m

            SEGMENT_GEOMETRY.forEach(grp => {
                for (let i = 0; i < grp.count; i++) {
                    const len = grp.length;
                    const endX = x + len;
                    const midX = (x + endX) / 2;

                    const internalTf = INTERNAL_PRESTRESS_TF[id - 1] || 0;

                    state.segments.push({
                        id: id++,
                        type: grp.type,
                        startX: parseFloat(x.toFixed(3)),
                        endX: parseFloat(endX.toFixed(3)),  // æ–°å¢ï¼šç¯€æ®µçµ‚é»ä½ç½®
                        length: len,
                        midX: midX,
                        internalTf: internalTf,
                        extKn: 0,
                        totalTf: 0
                    });
                    x += len;
                    state.nodes.push(parseFloat(x.toFixed(3)));
                }
            });
        }

        function addListeners() {
            // Tab 2 Listeners (Design Loads)
            document.getElementById('dl-additional').addEventListener('input', (e) => {
                syncDeadLoadInput(e.target.value);
            });

            ['ll-impact-slider', 'll-overload-slider', 'll-lanes-slider'].forEach(id => {
                document.getElementById(id).addEventListener('input', (e) => {
                    const type = id.includes('impact') ? 'impact' : id.includes('overload') ? 'overload' : 'lanes';
                    syncLiveLoadSlider(type, e.target.value);
                });
            });

            // Tab 4 Listeners - èˆ‡Tab 2å®Œå…¨åŒæ­¥
            const tab4AdditionalInput = document.getElementById('dl-additional-tab4');
            if (tab4AdditionalInput) {
                tab4AdditionalInput.addEventListener('input', (e) => {
                    syncDeadLoadInput(e.target.value);
                });
            }

            // Window Resize Listener for Responsive Charts
            window.addEventListener('resize', () => {
                // Throttle resize
                if (this.resizeTimeout) clearTimeout(this.resizeTimeout);

                this.resizeTimeout = setTimeout(() => {
                    if (state.currentTab === 2) drawProfile(3, false); // Tab 2 uses Canvas 3
                    if (state.currentTab === 3) drawProfile(1, false); // Tab 3 uses Canvas 1
                    if (state.currentTab === 5) drawProfile2();
                    if (state.currentTab === 6) renderStrengtheningVerifyTable();
                }, 100);
            });
        }

        // --- External Prestress Geometry Handlers ---

        function updateAnchorageY(type, value, source) {
            value = parseFloat(value);
            if (isNaN(value)) return;

            // Limit range check (0-278)
            if (value < 0) value = 0;
            if (value > 278) value = 278;

            if (type === 'sliding') {
                state.extGeometry.anchorage.sliding.y = value;
                // Sync UI
                if (source !== 'input') {
                    const el = document.getElementById('anchorage-sliding-y');
                    if (el) el.value = value;
                }
                if (source !== 'slider') {
                    const slider = document.getElementById('anchorage-sliding-y-slider');
                    if (slider) slider.value = value;
                }
                // Sync Tab 6 Input
                if (source !== 'input') {
                    const el6 = document.getElementById('anchorage-sliding-y-tab6');
                    if (el6) el6.value = value;
                }
            } else if (type === 'hinged') {
                state.extGeometry.anchorage.hinged.y = value;
                // Sync UI
                if (source !== 'input') {
                    const el = document.getElementById('anchorage-hinged-y');
                    if (el) el.value = value;
                }
                if (source !== 'slider') {
                    const slider = document.getElementById('anchorage-hinged-y-slider');
                    if (slider) slider.value = value;
                }
                // Sync Tab 6 Input
                if (source !== 'input') {
                    const el6 = document.getElementById('anchorage-hinged-y-tab6');
                    if (el6) el6.value = value;
                }
            }
            drawProfile2(); // Trigger redraw
        }

        function updateDeviationBlockCount(value) {
            const count = parseInt(value);
            state.extGeometry.deviationBlocks.count = count;

            // Toggle visibility of Block 2 input
            const block2Container = document.getElementById('deviation-block-2-container');
            if (count === 2) {
                block2Container.classList.remove('hidden');
            } else {
                block2Container.classList.add('hidden');
            }
            drawProfile2(); // Trigger redraw
        }

        function updateDeviationBlockX(blockNum, value, source) {
            value = parseFloat(value);
            if (isNaN(value)) return;

            // Block 1: 0 - 28.25
            // Block 2: 28.25 - 56.5

            if (blockNum === 1) {
                if (value < 0) value = 0;
                if (value > 28.25) value = 28.25;
                state.extGeometry.deviationBlocks.blocks[0].x = value;

                if (source !== 'input') {
                    const el = document.getElementById('deviation-block-1-x');
                    if (el) el.value = value;
                }
                if (source !== 'slider') {
                    const slider = document.getElementById('deviation-block-1-x-slider');
                    if (slider) slider.value = value;
                }

            } else if (blockNum === 2) {
                if (value < 28.25) value = 28.25;
                if (value > 56.5) value = 56.5;
                state.extGeometry.deviationBlocks.blocks[1].x = value;

                if (source !== 'input') {
                    const el = document.getElementById('deviation-block-2-x');
                    if (el) el.value = value;
                }
                if (source !== 'slider') {
                    const slider = document.getElementById('deviation-block-2-x-slider');
                    if (slider) slider.value = value;
                }
            }
            drawProfile2(); // Trigger redraw
        }

        // --- Calculation Logic for External Forces ---
        function calculateExtForces() {
            const P = state.extGeometry.forceTf;
            const beamDepthM = 2.78; // Fixed beam depth for bottom reference

            // 1. Sliding End (N1, x=0)
            const n1_x = 0;
            const n1_y = state.extGeometry.anchorage.sliding.y / 100; // cm -> m

            // Block 1
            const b1_x = state.extGeometry.deviationBlocks.blocks[0].x;
            const b1_y = beamDepthM;

            // Segment 1 Vector (N1 -> B1)
            // Cable pulls N1 towards B1 (Down-Right)
            // Force on Structure: Compression (Right), Downward Shear (Down)
            const dx1 = b1_x - n1_x;
            const dy1 = b1_y - n1_y; // Positive means Down
            const L1 = Math.sqrt(dx1 * dx1 + dy1 * dy1);

            // Forces at N1
            const n1_axial = L1 > 0 ? P * (dx1 / L1) : 0;
            const n1_shear = L1 > 0 ? P * (dy1 / L1) : 0;

            // 2. Hinged End (N30, x=56.5)
            const n30_x = 56.5;
            const n30_y = state.extGeometry.anchorage.hinged.y / 100; // cm -> m

            // Last Block
            const count = state.extGeometry.deviationBlocks.count;
            const lastBlock_x = state.extGeometry.deviationBlocks.blocks[count - 1].x;
            const lastBlock_y = beamDepthM;

            // Vector N30 -> LastBlock (Cable pulls N30 towards LastBlock)
            // dx is lastBlock - N30 (Negative)
            const dx_last = lastBlock_x - n30_x;
            const dy_last = lastBlock_y - n30_y; // Positive (Down)
            const L_last = Math.sqrt(dx_last * dx_last + dy_last * dy_last);

            // Forces at N30
            // Axial (Horizontal Comp) -> abs(dx)
            const n30_axial = L_last > 0 ? P * (Math.abs(dx_last) / L_last) : 0;
            const n30_shear = L_last > 0 ? P * (dy_last / L_last) : 0;

            // 3. Deviation Blocks Lift
            // Block 1 Lift
            // Component from Seg 1: P * (dy1 / L1). This is Downward pull by cable on Anchor. 
            // On Block, Cable pulls UP towards Anchor. Vertical Comp = P * (b1_y - n1_y) / L1 ?
            // dy1 = b1_y - n1_y. So P * dy1/L1 is correct magnitude.
            // Wait, dy1 is positive (down). Lift should be Up.
            // Force on Block = P * (Vector_to_N1 + Vector_to_Next).
            // Vector B1->N1: dy = n1_y - b1_y (Negative).
            // Vertical Force = P * (n1_y - b1_y)/L1. (Negative means Up? No, Force Y usually positive for up?)
            // Let's settle on Magnitude "Upward Lift".
            // Lift form Seg 1 = P * (b1_y - n1_y) / L1. (Positive Value).

            let b1_lift = L1 > 0 ? P * (dy1 / L1) : 0;
            let b2_lift = 0;

            if (count === 1) {
                // B1 connects to N30
                // Lift from N30 side: P * (b1_y - n30_y) / L_seg2
                const dx2 = n30_x - b1_x;
                const dy2 = n30_y - b1_y; // Negative (Up)
                const L2 = Math.sqrt(dx2 * dx2 + dy2 * dy2);
                // Magnitude of Upward Lift
                b1_lift += L2 > 0 ? P * ((b1_y - n30_y) / L2) : 0;
            } else {
                // 2 Blocks. B1 connects to B2 (Horizontal). Lift from Right = 0.

                // Block 2: Connects to B1 (Left, 0 lift) and N30 (Right).
                // Lift from N30 side: P * (b2_y - n30_y) / L_last
                // Note dy_last was lastBlock_y - n30_y (Positive).
                // Lift = P * (b2_y - n30_y) / L_last.
                const b2_x = state.extGeometry.deviationBlocks.blocks[1].x;
                const b2_y = beamDepthM;
                // re-calc L for B2->N30 just to be sure (L_last is same)

                b2_lift = L_last > 0 ? P * ((b2_y - n30_y) / L_last) : 0;
            }

            // Store results in state for table rendering
            state.extResults.n1_axial = n1_axial;
            state.extResults.n30_axial = n30_axial;

            // Update DOM
            updateResultDOM('res-n1-axial', n1_axial);
            updateResultDOM('res-n1-shear', n1_shear);
            updateResultDOM('res-n30-axial', n30_axial);
            updateResultDOM('res-n30-shear', n30_shear);
            updateResultDOM('res-b1-lift', b1_lift);

            const b2Row = document.getElementById('res-row-b2');
            const betweenRow = document.getElementById('res-row-between-blocks');

            if (count === 2) {
                if (b2Row) b2Row.classList.remove('hidden');
                if (betweenRow) {
                    betweenRow.classList.remove('hidden');
                    updateResultDOM('res-between-axial', P);
                }
                updateResultDOM('res-b2-lift', b2_lift);
            } else {
                if (b2Row) b2Row.classList.add('hidden');
                if (betweenRow) betweenRow.classList.add('hidden');
            }

            // Sync Table
            renderTable3();
            if (state.currentTab === 6) {
                renderStrengtheningVerifyTable();
            }
        }

        function updateResultDOM(id, val) {
            const el = document.getElementById(id);
            if (el) el.innerText = val.toFixed(2) + ' tf';
        }

        function updateExtForceTf(val) {
            state.extGeometry.forceTf = parseFloat(val) || 0;
            calculateExtForces();
        }

        // ç¹ªè£½ Tab 5 çš„ Profile (å«å¤–ç½®é åŠ›)
        function drawProfile2() {
            calculateExtForces();
            const canvas = document.getElementById('profileCanvas2');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            ctx.clearRect(0, 0, width, height);

            // Scaling
            const paddingX = 50;
            const paddingY = 40;
            const drawWidth = width - 2 * paddingX;
            const drawHeight = height - 2 * paddingY;

            const scaleX = drawWidth / state.span;
            const maxDepth = 2.78; // 2.78m
            const scaleY = 120 / maxDepth; // Scale for depth visualizing

            // Reference Y (Top of beam)
            const beamTopY = 40;
            const beamBotY = beamTopY + (maxDepth * scaleY);

            // 1. Draw Beam Outline (Simplified Box)
            ctx.beginPath();
            ctx.strokeStyle = '#334155';
            ctx.lineWidth = 2;
            ctx.strokeRect(paddingX, beamTopY, state.span * scaleX, maxDepth * scaleY);

            // Draw Segments lines
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            ctx.beginPath();
            let currentX = 0;
            state.segments.forEach(seg => {
                currentX += seg.length;
                if (currentX < state.span) {
                    const xPos = paddingX + currentX * scaleX;
                    ctx.moveTo(xPos, beamTopY);
                    ctx.lineTo(xPos, beamBotY);
                }
            });
            ctx.stroke();

            // 2. Draw Deviation Blocks
            ctx.fillStyle = '#334155'; // Dark Slate
            const blockWidthPixel = 0.8 * scaleX; // Approx 0.8m width visually
            const blockHeightPixel = 20; // Fixed visual height

            const count = state.extGeometry.deviationBlocks.count;
            const blocks = state.extGeometry.deviationBlocks.blocks;

            // Define deviations points for line drawing
            const deviationPoints = [];

            for (let i = 0; i < count; i++) {
                const blockX = blocks[i].x;
                const xPos = paddingX + blockX * scaleX;
                const yPos = beamBotY; // Bottom alignment

                // Draw Triangle/Block shape to represent deviator
                ctx.beginPath();
                ctx.moveTo(xPos, yPos);
                ctx.lineTo(xPos - 5, yPos - blockHeightPixel);
                ctx.lineTo(xPos + 5, yPos - blockHeightPixel);
                ctx.fill();

                // Save point for line connection (at the "hole" location, slightly above bottom)
                deviationPoints.push({ x: xPos, y: yPos - (blockHeightPixel / 2) });
            }

            // 3. Draw External Prestress Line
            ctx.beginPath();
            ctx.strokeStyle = '#ef4444'; // Red-500
            ctx.lineWidth = 3;

            // Sliding End Anchorage
            const slideAnchY_cm = state.extGeometry.anchorage.sliding.y;
            const slideAnchX_m = state.extGeometry.anchorage.sliding.x; // 0

            const startX = paddingX + slideAnchX_m * scaleX; // Should be paddingX
            const startY = beamTopY + (slideAnchY_cm / 100) * scaleY; // Convert cm to m for scaleY

            // Hinged End Anchorage
            const hingedAnchY_cm = state.extGeometry.anchorage.hinged.y;
            const hingedAnchX_m = state.extGeometry.anchorage.hinged.x; // 56.5

            const endX = paddingX + hingedAnchX_m * scaleX;
            const endY = beamTopY + (hingedAnchY_cm / 100) * scaleY;

            // Draw Path: Start -> Deviator 1 -> Deviator 2 (if exists) -> End
            ctx.moveTo(startX, startY);

            deviationPoints.forEach(pt => {
                ctx.lineTo(pt.x, pt.y);
            });

            ctx.lineTo(endX, endY);
            ctx.stroke();

            // Draw Anchorage Points
            ctx.fillStyle = '#ef4444';
            // Start Point Circle
            ctx.beginPath();
            ctx.arc(startX, startY, 4, 0, Math.PI * 2);
            ctx.fill();
            // End Point Circle
            ctx.beginPath();
            ctx.arc(endX, endY, 4, 0, Math.PI * 2);
            ctx.fill();

            // Labels
            ctx.fillStyle = '#1e293b';
            ctx.font = '10px Arial';
            ctx.fillText(`N1 (Y=${slideAnchY_cm}cm)`, startX + 5, startY - 5);
            ctx.fillText(`N30 (Y=${hingedAnchY_cm}cm)`, endX - 70, endY - 5);
        }

        // æ¢ä¸Šä¸‹ç·£æ‡‰åŠ›è¨ˆç®—è¡¨æ ¼ç”Ÿæˆå‡½æ•¸
        function renderStressCalcTable() {
            const tbody = document.getElementById('stressCalcTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            // ç²å–åŸºæœ¬æ•¸æ“š
            const prestress_tf = INTERNAL_PRESTRESS_TF; // é åŠ›å€¼(tf)
            const L = state.span; // 56.5m

            // ä½¿ç”¨ Tab 2 è¨ˆç®—çš„ M_DL å’Œ M_LL (å¾ state å–å¾—)
            const M_DL = state.M_DL; // éœè¼‰é‡å½çŸ© (tfÂ·m)
            const M_LL = state.M_LL; // è»Šè¼›è¼‰é‡å½çŸ© (tfÂ·m)

            // è¨ˆç®—åˆ†ä½ˆè¼‰é‡ (å¾æœ€å¤§å½çŸ©åæ¨)
            // M_max = w * L^2 / 8, so w = 8 * M_max / L^2
            const w_DL = (8 * M_DL) / (L * L); // tf/m
            const w_LL = (8 * M_LL) / (L * L); // tf/m

            // === æ–°å¢ç¯€æ®µ#0 (x=0, ä½¿ç”¨èˆ‡ç¯€æ®µ#1ç›¸åŒçš„æ–·é¢) ===
            const seg0_nodeId = getSegmentNode(1); // ä½¿ç”¨ç¯€æ®µ1çš„ç¯€é»
            const seg0_section = BEAM_SECTIONS.find(s => s.id === seg0_nodeId);

            if (seg0_section) {
                const A = seg0_section.Area;
                const I_zz = seg0_section.I;
                const Y_top = seg0_section.Y_top;
                const Y_bot = seg0_section.Y_bot;

                const ep_eff = Y_bot - 12.5;
                const Meff = (prestress_tf[0] * ep_eff) / 100; // ä½¿ç”¨ç¬¬ä¸€å€‹é åŠ›å€¼
                const Stop = I_zz / Y_top;
                const Sbot = I_zz / Y_bot;
                const faxial = prestress_tf[0] * 1000 / A;
                const fm_top = (Meff > 0) ? -(Meff * 100000 / Stop) : (Meff * 100000 / Stop);
                const fm_bot = (Meff * 100000 / Sbot);
                const feff_top = faxial + fm_top;
                const feff_bot = faxial + fm_bot;

                // x=0 æ™‚ï¼Œè¼‰é‡å½çŸ©ç‚º0
                const x = 0;
                const M_DL_seg = 0; // x=0 æ™‚å½çŸ©ç‚º0
                const M_LL_seg = 0; // x=0 æ™‚å½çŸ©ç‚º0
                const fDL_top = 0;
                const fDL_bot = 0;
                const fLL_top = 0;
                const fLL_bot = 0;

                const tr0 = document.createElement('tr');
                tr0.className = 'bg-amber-50'; // ç‰¹æ®ŠèƒŒæ™¯è‰²æ¨™ç¤ºç¯€æ®µ#0
                tr0.innerHTML = `
                    <td class="border border-slate-300 px-2 py-2 text-center font-semibold text-amber-700">#0</td>
                    <td class="border border-slate-300 px-2 py-2 text-center font-semibold text-purple-600">${seg0_nodeId}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right">${ep_eff.toFixed(2)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono bg-green-50 text-green-700">0.00</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono bg-blue-50 text-blue-700">0.00</td>
                    <td class="border border-slate-300 px-2 py-2 text-right">${Meff.toFixed(2)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right">${Stop.toFixed(1)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right">${Sbot.toFixed(1)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono">${faxial.toFixed(2)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono" style="color: ${fm_top < 0 ? '#dc2626' : '#16a34a'}">${fm_top.toFixed(2)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono" style="color: ${fm_bot > 0 ? '#2563eb' : '#dc2626'}">${fm_bot.toFixed(2)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono" style="color: ${feff_top < 0 ? '#dc2626' : '#16a34a'}">${feff_top.toFixed(2)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono" style="color: ${feff_bot > 0 ? '#2563eb' : '#dc2626'}">${feff_bot.toFixed(2)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono text-slate-400">0.00</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono text-slate-400">0.00</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono text-slate-400">0.00</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono text-slate-400">0.00</td>
                `;
                tbody.appendChild(tr0);
            }

            // é€ç¯€æ®µè¨ˆç®—
            state.segments.forEach(seg => {
                // å–å¾—å°æ‡‰ç¯€é»
                const nodeId = getSegmentNode(seg.id);
                const section = BEAM_SECTIONS.find(s => s.id === nodeId);
                if (!section) return; // å¦‚æœæ‰¾ä¸åˆ°å°æ‡‰ç¯€é»ï¼Œè·³é

                // æˆªé¢åƒæ•¸ (å–®ä½: cm)
                const A = section.Area; // cmÂ²
                const I_zz = section.I; // cmâ´
                const Y_top = section.Y_top; // cm (å¾é ‚éƒ¨)
                const Y_bot = section.Y_bot; // cm (å¾åº•éƒ¨)

                // 1. é‹¼è…±åå¿ƒçŸ© ep,eff (cm)
                const ep_eff = Y_bot - 12.5;

                // 2. æœ‰æ•ˆé åŠ›å½çŸ© Meff (tfÂ·m)
                const Meff = (prestress_tf[seg.id - 1] * ep_eff) / 100; // è½‰æ›cmåˆ°m

                // 3. æ–·é¢ä¸€æ¬¡çŸ©
                const Stop = I_zz / Y_top; // cmÂ³
                const Sbot = I_zz / Y_bot; // cmÂ³

                // 4. è»¸å‘æ‡‰åŠ› faxial (kgf/cmÂ²)
                const faxial = prestress_tf[seg.id - 1] * 1000 / A; // tfè½‰kgf

                // 5. ä¸Šç·£å½çŸ©æ‡‰åŠ› fm,top (kgf/cmÂ²)
                const fm_top = (Meff > 0) ? -(Meff * 100000 / Stop) : (Meff * 100000 / Stop);

                // 6. ä¸‹ç·£å½çŸ©æ‡‰åŠ› fm,bot (kgf/cmÂ²)
                const fm_bot = (Meff * 100000 / Sbot);

                // 7. æ¢ä¸Šç·£æœ‰æ•ˆæ‡‰åŠ› feff,top (kgf/cmÂ²)
                const feff_top = faxial + fm_top;

                // 8. æ¢ä¸‹ç·£æœ‰æ•ˆæ‡‰åŠ› feff,bot (kgf/cmÂ²)
                const feff_bot = faxial + fm_bot;

                // 9. è¨ˆç®—å„è¼‰é‡é€ æˆçš„æ‡‰åŠ›
                // ä½¿ç”¨ç¯€æ®µçµ‚é»ä½ç½® (endX) é€²è¡Œå½çŸ©è¨ˆç®—
                const x = seg.endX; // ç¯€æ®µç´¯ç©çµ‚é»ä½ç½®(m)
                const M_DL_seg = w_DL * (x / 2) * (L - x); // tfÂ·m
                const M_LL_seg = w_LL * (x / 2) * (L - x); // tfÂ·m

                // æ¢è‡ªé‡æ‡‰åŠ›ï¼ˆæ­£å½çŸ©ï¼šä¸Šç·£å—å£“ç‚ºæ­£ï¼Œä¸‹ç·£å—æ‹‰ç‚ºè² ï¼‰
                const fDL_top = (M_DL_seg * 100000 / Stop);   // ä¸Šç·£å£“æ‡‰åŠ›ï¼ˆæ­£å€¼ï¼‰
                const fDL_bot = -(M_DL_seg * 100000 / Sbot);  // ä¸‹ç·£æ‹‰æ‡‰åŠ›ï¼ˆè² å€¼ï¼‰

                // è»Šè¼›è¼‰é‡æ‡‰åŠ›ï¼ˆæ­£å½çŸ©ï¼šä¸Šç·£å—å£“ç‚ºæ­£ï¼Œä¸‹ç·£å—æ‹‰ç‚ºè² ï¼‰
                const fLL_top = (M_LL_seg * 100000 / Stop);   // ä¸Šç·£å£“æ‡‰åŠ›ï¼ˆæ­£å€¼ï¼‰
                const fLL_bot = -(M_LL_seg * 100000 / Sbot);  // ä¸‹ç·£æ‹‰æ‡‰åŠ›ï¼ˆè² å€¼ï¼‰

                // ç”Ÿæˆè¡¨æ ¼è¡Œ
                const tr = document.createElement('tr');
                if (seg.type === 'special') tr.className = 'bg-yellow-50';

                tr.innerHTML = `
                    <td class="border border-slate-300 px-2 py-2 text-center font-semibold">#${seg.id}</td>
                    <td class="border border-slate-300 px-2 py-2 text-center font-semibold text-purple-600">${nodeId}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right">${ep_eff.toFixed(2)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono bg-green-50 text-green-700">${M_DL_seg.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono bg-blue-50 text-blue-700">${M_LL_seg.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right">${Meff.toFixed(2)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right">${Stop.toFixed(1)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right">${Sbot.toFixed(1)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono">${faxial.toFixed(2)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono" style="color: ${fm_top < 0 ? '#dc2626' : '#16a34a'}">${fm_top.toFixed(2)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono" style="color: ${fm_bot > 0 ? '#2563eb' : '#dc2626'}">${fm_bot.toFixed(2)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono" style="color: ${feff_top < 0 ? '#dc2626' : '#16a34a'}">${feff_top.toFixed(2)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono" style="color: ${feff_bot > 0 ? '#2563eb' : '#dc2626'}">${feff_bot.toFixed(2)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono" style="color: ${fDL_top > 0 ? '#2563eb' : '#dc2626'}">${fDL_top.toFixed(2)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono" style="color: ${fDL_bot < 0 ? '#dc2626' : '#16a34a'}">${fDL_bot.toFixed(2)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono" style="color: ${fLL_top > 0 ? '#2563eb' : '#dc2626'}">${fLL_top.toFixed(2)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono" style="color: ${fLL_bot < 0 ? '#dc2626' : '#16a34a'}">${fLL_bot.toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // å£“å¼µæ‡‰åŠ›æª¢æ ¸è¡¨æ ¼ç”Ÿæˆå‡½æ•¸
        function renderStressVerifyTable() {
            const tbody = document.getElementById('stressVerifyTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            // å®¹è¨±æ‡‰åŠ›é™å€¼ (Case No.1)
            const allowable_compression = 210.00; // kgf/cmÂ²
            const allowable_tension = -14.97;     // kgf/cmÂ²

            // ç²å–åŸºæœ¬æ•¸æ“š
            const prestress_tf = INTERNAL_PRESTRESS_TF;
            const L = state.span;
            const M_DL = state.M_DL;
            const M_LL = state.M_LL;
            const w_DL = (8 * M_DL) / (L * L);
            const w_LL = (8 * M_LL) / (L * L);

            // === ç¯€æ®µ#0 ===
            const seg0_nodeId = getSegmentNode(1);
            const seg0_section = BEAM_SECTIONS.find(s => s.id === seg0_nodeId);

            if (seg0_section) {
                const A = seg0_section.Area;
                const I_zz = seg0_section.I;
                const Y_top = seg0_section.Y_top;
                const Y_bot = seg0_section.Y_bot;
                const ep_eff = Y_bot - 12.5;
                const Meff = (prestress_tf[0] * ep_eff) / 100;
                const Stop = I_zz / Y_top;
                const Sbot = I_zz / Y_bot;
                const faxial = prestress_tf[0] * 1000 / A;
                const fm_top = (Meff > 0) ? -(Meff * 100000 / Stop) : (Meff * 100000 / Stop);
                const fm_bot = (Meff * 100000 / Sbot);
                const feff_top = faxial + fm_top;
                const feff_bot = faxial + fm_bot;
                const fDL_top = 0;
                const fDL_bot = 0;
                const fLL_top = 0;
                const fLL_bot = 0;

                const ftotal_top = feff_top + fDL_top + fLL_top;
                const ftotal_bot = feff_bot + fDL_bot + fLL_bot;

                const check_top = (ftotal_top >= allowable_tension && ftotal_top <= allowable_compression) ? 'OK' : 'NG';
                const check_bot = (ftotal_bot >= allowable_tension && ftotal_bot <= allowable_compression) ? 'OK' : 'NG';

                const tr0 = document.createElement('tr');
                tr0.className = 'bg-amber-50';
                tr0.innerHTML = `
                    <td class="border border-slate-300 px-2 py-2 text-center font-semibold text-amber-700">#0</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono">${feff_top.toFixed(2)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono">${feff_bot.toFixed(2)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono text-slate-400">0.00</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono text-slate-400">0.00</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono text-slate-400">0.00</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono text-slate-400">0.00</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-bold font-mono bg-amber-100">${ftotal_top.toFixed(2)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-bold font-mono bg-amber-100">${ftotal_bot.toFixed(2)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-center font-bold ${check_top === 'OK' ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50'}">${check_top}</td>
                    <td class="border border-slate-300 px-2 py-2 text-center font-bold ${check_bot === 'OK' ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50'}">${check_bot}</td>
                `;
                tbody.appendChild(tr0);
            }

            // === å„ç¯€æ®µ ===
            state.segments.forEach(seg => {
                const nodeId = getSegmentNode(seg.id);
                const section = BEAM_SECTIONS.find(s => s.id === nodeId);
                if (!section) return;

                const A = section.Area;
                const I_zz = section.I;
                const Y_top = section.Y_top;
                const Y_bot = section.Y_bot;
                const ep_eff = Y_bot - 12.5;
                const Meff = (prestress_tf[seg.id - 1] * ep_eff) / 100;
                const Stop = I_zz / Y_top;
                const Sbot = I_zz / Y_bot;
                const faxial = prestress_tf[seg.id - 1] * 1000 / A;
                const fm_top = (Meff > 0) ? -(Meff * 100000 / Stop) : (Meff * 100000 / Stop);
                const fm_bot = (Meff * 100000 / Sbot);
                const feff_top = faxial + fm_top;
                const feff_bot = faxial + fm_bot;

                const x = seg.endX;
                const M_DL_seg = w_DL * (x / 2) * (L - x);
                const M_LL_seg = w_LL * (x / 2) * (L - x);
                const fDL_top = (M_DL_seg * 100000 / Stop);
                const fDL_bot = -(M_DL_seg * 100000 / Sbot);
                const fLL_top = (M_LL_seg * 100000 / Stop);
                const fLL_bot = -(M_LL_seg * 100000 / Sbot);

                const ftotal_top = feff_top + fDL_top + fLL_top;
                const ftotal_bot = feff_bot + fDL_bot + fLL_bot;

                const check_top = (ftotal_top >= allowable_tension && ftotal_top <= allowable_compression) ? 'OK' : 'NG';
                const check_bot = (ftotal_bot >= allowable_tension && ftotal_bot <= allowable_compression) ? 'OK' : 'NG';

                const tr = document.createElement('tr');
                if (seg.type === 'special') tr.className = 'bg-yellow-50';

                tr.innerHTML = `
                    <td class="border border-slate-300 px-2 py-2 text-center font-semibold">#${seg.id}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono">${feff_top.toFixed(2)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono">${feff_bot.toFixed(2)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono">${fDL_top.toFixed(2)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono">${fDL_bot.toFixed(2)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono">${fLL_top.toFixed(2)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-mono">${fLL_bot.toFixed(2)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-bold font-mono bg-amber-100">${ftotal_top.toFixed(2)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-right font-bold font-mono bg-amber-100">${ftotal_bot.toFixed(2)}</td>
                    <td class="border border-slate-300 px-2 py-2 text-center font-bold ${check_top === 'OK' ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50'}">${check_top}</td>
                    <td class="border border-slate-300 px-2 py-2 text-center font-bold ${check_bot === 'OK' ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50'}">${check_bot}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // === åˆ†é 2èˆ‡åˆ†é 4é›™å‘åŒæ­¥å‡½æ•¸ ===

        // åŒæ­¥éœè¼‰é‡é™„åŠ è¼‰é‡è¼¸å…¥
        function syncDeadLoadInput(value) {
            // æ›´æ–°ä¸‰å€‹åˆ†é çš„è¼¸å…¥æ¡†
            document.getElementById('dl-additional').value = value;
            document.getElementById('dl-additional-tab4').value = value;
            document.getElementById('dl-additional-tab4-3').value = value;
            const tab6Input = document.getElementById('dl-additional-tab6');
            if (tab6Input) tab6Input.value = value;

            // è§¸ç™¼è¨ˆç®—æ›´æ–°
            updateDeadLoad();
        }

        // åŒæ­¥è»Šè¼›è¼‰é‡æ»‘æ¡¿
        function syncLiveLoadSlider(type, value) {
            const numValue = parseFloat(value);

            if (type === 'impact') {
                document.getElementById('ll-impact-slider').value = numValue;
                document.getElementById('ll-impact-slider-tab4').value = numValue;
                document.getElementById('ll-impact-slider-tab4-3').value = numValue;
                document.getElementById('val-ll-impact').innerText = numValue;
                document.getElementById('val-ll-impact-tab4').innerText = numValue;
                document.getElementById('val-ll-impact-tab4-3').innerText = numValue;
            } else if (type === 'overload') {
                document.getElementById('ll-overload-slider').value = numValue;
                document.getElementById('ll-overload-slider-tab4').value = numValue;
                document.getElementById('ll-overload-slider-tab4-3').value = numValue;
                document.getElementById('val-ll-overload').innerText = numValue;
                document.getElementById('val-ll-overload-tab4').innerText = numValue;
                document.getElementById('val-ll-overload-tab4-3').innerText = numValue;
            } else if (type === 'lanes') {
                const intValue = parseInt(value);
                document.getElementById('ll-lanes-slider').value = intValue;
                document.getElementById('ll-lanes-slider-tab4').value = intValue;
                document.getElementById('ll-lanes-slider-tab4-3').value = intValue;
                document.getElementById('val-ll-lanes').innerText = intValue;
                document.getElementById('val-ll-lanes-tab4').innerText = intValue;
                document.getElementById('val-ll-lanes-tab4-3').innerText = intValue;

                const slider6 = document.getElementById('ll-lanes-slider-tab6');
                if (slider6) slider6.value = intValue;
                const val6 = document.getElementById('val-ll-lanes-tab6');
                if (val6) val6.innerText = intValue;
            }

            // Sync Tab 6 specific sliders if not covered above (impact/overload)
            if (type === 'impact') {
                const slider6 = document.getElementById('ll-impact-slider-tab6');
                if (slider6) slider6.value = numValue;
                const val6 = document.getElementById('val-ll-impact-tab6');
                if (val6) val6.innerText = numValue;
            } else if (type === 'overload') {
                const slider6 = document.getElementById('ll-overload-slider-tab6');
                if (slider6) slider6.value = numValue;
                const val6 = document.getElementById('val-ll-overload-tab6');
                if (val6) val6.innerText = numValue;
            }

            // è§¸ç™¼è¨ˆç®—æ›´æ–°
            updateLiveLoad();
        }

        // åŒæ­¥è»Šé“æŠ˜æ¸›ä¿‚æ•¸é¸æ“‡
        function syncLiveLoadReduction(value) {
            document.getElementById('ll-reduction-select').value = value;
            document.getElementById('ll-reduction-select-tab4').value = value;
            document.getElementById('ll-reduction-select-tab4-3').value = value;
            // è§¸ç™¼è¨ˆç®—æ›´æ–°
            updateLiveLoad();
        }

        function updateLiveLoadVariables() {
            const im = parseFloat(document.getElementById('ll-impact-slider').value);
            const ol = parseFloat(document.getElementById('ll-overload-slider').value);
            const lanes = parseInt(document.getElementById('ll-lanes-slider').value);
            const reduction = parseFloat(document.getElementById('ll-reduction-select').value);

            document.getElementById('val-ll-impact').innerText = im;
            document.getElementById('val-ll-overload').innerText = ol;
            document.getElementById('val-ll-lanes').innerText = lanes;
        }

        function updateDeadLoad() {
            // Formula: M_DL = (w_self + w_add) * L^2 / 8
            const w_self = 35.94;
            const w_add = parseFloat(document.getElementById('dl-additional').value) || 0;
            const L = state.span; // 56.5

            const M_DL = (w_self + w_add) * Math.pow(L, 2) / 8;

            // Store in state for use by stress calculation table
            state.M_DL = M_DL;

            const formattedValue = M_DL.toLocaleString('en-US', { minimumFractionDigits: 1, maximumFractionDigits: 1 });

            // Update Tab 2 display
            document.getElementById('val-m-dl').innerText = formattedValue + ' tfÂ·m';

            // Update Tab 4 Sub-tab 2 synchronized display
            const tab4Element = document.getElementById('val-m-dl-tab4');
            if (tab4Element) {
                tab4Element.innerText = formattedValue;
            }

            // Update Tab 4 Sub-tab 3 synchronized display
            const tab4_3Element = document.getElementById('val-m-dl-tab4-3');
            if (tab4_3Element) {
                tab4_3Element.innerText = formattedValue;
            }

            // Update Tab 6
            const tab6Element = document.getElementById('val-m-dl-tab6');
            if (tab6Element) {
                tab6Element.innerText = formattedValue;
            }

            // Update segment moment table if tab 2
            if (state.currentTab === 2) {
                renderSegmentMomentTable();
            }

            // Update stress calculation table if tab 4
            if (state.currentTab === 4) {
                renderStressCalcTable();
                renderStressVerifyTable();
            }

            // Update Tab 6 if active
            if (state.currentTab === 6) {
                renderStrengtheningVerifyTable();
            }
        }

        function updateLiveLoad() {
            // M_LL = 499 * (1+IM) * (1+OL) * Red * Lanes
            const M_lane = 499; // tf*m
            const im = parseFloat(document.getElementById('ll-impact-slider').value);
            const ol = parseFloat(document.getElementById('ll-overload-slider').value);
            const lanes = parseInt(document.getElementById('ll-lanes-slider').value);
            const reduction = parseFloat(document.getElementById('ll-reduction-select').value);

            const M_LL = M_lane * (1 + im) * (1 + ol) * reduction * lanes;

            // Store in state for use by stress calculation table
            state.M_LL = M_LL;

            const formattedValue = M_LL.toLocaleString('en-US', { minimumFractionDigits: 1, maximumFractionDigits: 1 });

            // Update Tab 2 display
            document.getElementById('val-m-ll').innerText = formattedValue + ' tfÂ·m';

            // Update Tab 4 Sub-tab 2 synchronized display
            const tab4Element = document.getElementById('val-m-ll-tab4');
            if (tab4Element) {
                tab4Element.innerText = formattedValue;
            }

            // Update Tab 4 Sub-tab 3 synchronized display
            const tab4_3Element = document.getElementById('val-m-ll-tab4-3');
            if (tab4_3Element) {
                tab4_3Element.innerText = formattedValue;
            }

            // Update Tab 6
            const tab6Element = document.getElementById('val-m-ll-tab6');
            if (tab6Element) {
                tab6Element.innerText = formattedValue;
            }

            // Update segment moment table if tab 2
            if (state.currentTab === 2) {
                renderSegmentMomentTable();
            }

            // Update stress calculation table if tab 4
            if (state.currentTab === 4) {
                renderStressCalcTable();
                renderStressVerifyTable();
            }

            // Update Tab 6 if active
            if (state.currentTab === 6) {
                renderStrengtheningVerifyTable();
            }
        }

        function renderSegmentMomentTable() {
            const tbody = document.getElementById('segmentMomentBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            // Get current values
            const w_self = 35.94;
            const w_add = parseFloat(document.getElementById('dl-additional').value) || 0;
            const w_static = w_self + w_add;

            const M_lane = 499;
            const im = parseFloat(document.getElementById('ll-impact-slider').value);
            const ol = parseFloat(document.getElementById('ll-overload-slider').value);
            const lanes = parseInt(document.getElementById('ll-lanes-slider').value);
            const reduction = parseFloat(document.getElementById('ll-reduction-select').value);
            const M_LL = M_lane * (1 + im) * (1 + ol) * reduction * lanes;

            const L = state.span; // 56.5m
            const w_vehicle = (8 * M_LL) / (L * L); // è»Šè¼›åˆ†ä½ˆè·è¼‰ (tf/m)

            // Render each segment
            state.segments.forEach(seg => {
                const tr = document.createElement('tr');
                if (seg.type === 'special') tr.className = 'highlight-row';

                // Calculate moment at segment endpoint (cumulative position)
                const x = seg.endX; // ç¯€æ®µç´¯ç©çµ‚é»ä½ç½® (m)

                // M(x) = w * x/2 * (L - x)
                const M_static = w_static * (x / 2) * (L - x);
                const M_vehicle = w_vehicle * (x / 2) * (L - x);

                tr.innerHTML = `
                    <td class="font-bold text-slate-600 border-r border-slate-200">#${seg.id}</td>
                    <td class="text-center text-slate-600 border-r border-slate-200">${seg.length.toFixed(2)}</td>
                    <td class="text-center text-green-600 font-bold border-r border-slate-200">${M_static.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="text-center text-blue-600 font-bold">${M_vehicle.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function toggleUnit(u) {
            state.unit = u;
            document.getElementById('btn-kN').className = u === 'kN' ? "px-2 py-1 bg-blue-600 text-white text-xs rounded" : "px-2 py-1 bg-slate-600 text-slate-300 text-xs rounded hover:bg-slate-500";
            document.getElementById('btn-tf').className = u === 'tf' ? "px-2 py-1 bg-blue-600 text-white text-xs rounded" : "px-2 py-1 bg-slate-600 text-slate-300 text-xs rounded hover:bg-slate-500";
            updateCalculations();
        }

        function updateCalculations() {
            // Update Tab 2 and Tab 4
            updateDeadLoad();
            updateLiveLoadVariables();
            updateLiveLoad();

            // Tab 5 Redraw
            if (state.currentTab === 5) {
                drawProfile2();
            }

            renderTable();

            renderBendingMomentChart();

            renderStressCalcTable(); // æ¢ä¸Šä¸‹ç·£æ‡‰åŠ›è¨ˆç®—è¡¨æ ¼
            renderStressVerifyTable(); // å£“å¼µæ‡‰åŠ›æª¢æ ¸è¡¨æ ¼
            renderStrengtheningVerifyTable(); // åŠ å›ºæ‡‰åŠ›æª¢æ ¸è¡¨æ ¼
        }

        function renderStrengtheningVerifyTable() {
            const tbody = document.getElementById('strengtheningVerifyTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            // å®¹è¨±æ‡‰åŠ› (ç›¸åŒæ¨™æº–)
            const allowable_compression = 210.00;
            const allowable_tension = -14.97;

            // 1. Get Tab 4 Data Points (Total Stress)
            // Need to recalculate or access pre-calculated data?
            // Since we don't store per-segment total stress in state, we re-calc.

            const prestress_tf = INTERNAL_PRESTRESS_TF;
            const L = state.span;

            // Loads
            const w_self = 35.94;
            const w_add = parseFloat(document.getElementById('dl-additional').value) || 0;
            const w_DL = (w_self + w_add) * 8 / (L * L) * state.M_DL / (w_self + w_add); // Just use M_DL from state
            // Better: M_DL in state is Total Moment.
            // Segment Moment M(x) calc:
            // M_DL(x) = M_DL_total * 4 * (x/L) * (1 - x/L) ? Parabolic
            // Or just re-use formula: w * x/2 * (L-x)

            const w_total_dl = (state.M_DL * 8) / (L * L); // deduce w from M_DL
            const w_total_ll = (state.M_LL * 8) / (L * L); // deduce w from M_LL

            // 2. Get Tab 5 Data Points (Ext Effective Stress)
            // Use same logic as renderTable3

            // External Force Prep
            const blocks = state.extGeometry.deviationBlocks.blocks;
            const count = state.extGeometry.deviationBlocks.count;
            const b1_x = blocks[0].x;
            const b1_seg = state.segments.find(s => b1_x >= s.startX && b1_x < s.endX);
            const b1_id = b1_seg ? b1_seg.id : -1;
            let b2_id = -1;
            if (count === 2) {
                const b2_x = blocks[1].x;
                const b2_seg = state.segments.find(s => b2_x >= s.startX && b2_x < s.endX);
                b2_id = b2_seg ? b2_seg.id : -1;
            }

            const getUExtY = (x) => {
                const ancSlideY = state.extGeometry.anchorage.sliding.y;
                const ancHingeY = state.extGeometry.anchorage.hinged.y;
                const b_y = 278;
                if (x <= b1_x) return b1_x === 0 ? ancSlideY : ancSlideY + (b_y - ancSlideY) * (x / b1_x);
                if (count === 2) {
                    const b2_x = blocks[1].x;
                    if (x <= b2_x) return 278;
                    if (x >= 56.5) return ancHingeY;
                    return b_y + (ancHingeY - b_y) * ((x - b2_x) / (56.5 - b2_x));
                } else {
                    if (x >= 56.5) return ancHingeY;
                    return b_y + (ancHingeY - b_y) * ((x - b1_x) / (56.5 - b1_x));
                }
            };

            const getUExtForce = (segId) => {
                const P = state.extGeometry.forceTf;
                const n1_ax = state.extResults.n1_axial || 0;
                const n30_ax = state.extResults.n30_axial || 0;
                if (segId === 0) return n1_ax;
                if (segId <= b1_id) return n1_ax;
                if (count === 2) {
                    return (segId < b2_id) ? P : n30_ax;
                }
                return n30_ax;
            }

            // Include Seg #0 logic
            const allSegs = [...state.segments];
            // Add pseudo-segment 0 for looping if needed, or just handle #0 separate

            // Defined Nodes Iteration? No, match table 3 / 4 rows
            // Table should range #0 to #29

            // --- Row #0 ---
            {
                // Tab 4 (#0)
                const nodeId = 3; // Node 3 for Seg 0? Table 4 says Node 3
                // Actually Tab 4 renderStressVerifyTable Seg 0 uses getSegmentNode(1) -> Node 3
                const sec = BEAM_SECTIONS.find(s => s.id === 3);

                let int_ftotal_top = 0, int_ftotal_bot = 0;
                let ext_feff_top = 0, ext_feff_bot = 0;

                // Recalculate #0 Internal
                if (sec) {
                    const A = sec.Area; const I = sec.I; const Yt = sec.Y_top; const Yb = sec.Y_bot;
                    const ep = Yb - 12.5;
                    const M = (prestress_tf[0] * ep) / 100;
                    const Stop = I / Yt; const Sbot = I / Yb;
                    const fa = prestress_tf[0] * 1000 / A;
                    const fmt = (M > 0 ? -1 : 1) * (Math.abs(M) * 100000 / Stop);
                    const fmb = (M * 100000 / Sbot);
                    const feff_t = fa + fmt;
                    const feff_b = fa + fmb;
                    // Loads at x=0 are 0
                    int_ftotal_top = feff_t;
                    int_ftotal_bot = feff_b;
                }

                // Recalculate #0 External
                {
                    const f0 = getUExtForce(0);
                    const pos0 = state.extGeometry.anchorage.sliding.y;
                    const ep_ext = pos0 - sec.Y_top;
                    const meff = (f0 * ep_ext) / 100;
                    const fa_ext = (f0 * 1000) / sec.Area;

                    const Stop = sec.I / sec.Y_top;
                    const Sbot = sec.I / sec.Y_bot;

                    // fm_top: Meff/Stop * (-1 if Meff>0? No, definition: -M/S)
                    // If Meff (Force*ep) is (+), Moment is (+). Top Comp is (+).
                    // Formula: sigma = -My/I. 
                    // My convention: Comp (+).
                    // Positive Moment => Top Comp (+).
                    // Wait, in previous code: fm_top = (Meff > 0) ? -(...) : (...) -> This implies Meff>0 gives Tension(-).
                    // Let's check Tab 4 Logic:
                    // const fm_top = (Meff > 0) ? -(Meff * 100000 / Stop) : (Meff * 100000 / Stop);
                    // If Meff (+) (Sagging), Top should be Comp (+).
                    // Current code says Meff>0 -> Negative result. Negative is Tension?
                    // Verify Limit: Tension -14.97. 
                    // So Code treats (-) as Tension.
                    // Meff (+) -> Sagging -> Top Compression (+).
                    // Why does code use -(...)?
                    // PRESTRESS Moment is Hogging (usually).
                    // Prestress force at bottom -> Hogging Moment (M < 0).
                    // Meff calc: Force * ep. ep = Ybot - 12.5 (positive). So Meff is Positive?
                    // If Meff is positive representing Prestress Moment, it should be Hogging?
                    // Let's stick to Validated Code Logic in renderTable3:
                    // const fm_top0 = (Stop !== 0) ? -(meff0 * 100000 / Stop) : 0;

                    const fm_t = -(meff * 100000 / Stop);
                    const fm_b = (meff * 100000 / Sbot);

                    ext_feff_top = fa_ext + fm_t;
                    ext_feff_bot = fa_ext + fm_b;
                }

                createVerifyRow(0, int_ftotal_top, int_ftotal_bot, ext_feff_top, ext_feff_bot);
            }

            // --- Rows #1~#29 ---
            state.segments.forEach(seg => {
                const x = seg.endX;
                const nodeId = getSegmentNode(seg.id);
                const sec = BEAM_SECTIONS.find(s => s.id === nodeId);
                if (!sec) return;

                // Internal Total
                let int_tot_t = 0, int_tot_b = 0;
                {
                    const A = sec.Area; const I = sec.I; const Yt = sec.Y_top; const Yb = sec.Y_bot;
                    const ep = Yb - 12.5;
                    const M_p = (prestress_tf[seg.id - 1] * ep) / 100;
                    const Stop = I / Yt; const Sbot = I / Yb;
                    const fa = prestress_tf[seg.id - 1] * 1000 / A;
                    const fmt = (M_p > 0 ? -1 : 1) * (Math.abs(M_p) * 100000 / Stop);
                    const fmb = (M_p * 100000 / Sbot);
                    const feff_t = fa + fmt;
                    const feff_b = fa + fmb;

                    const M_dl = w_total_dl * (x / 2) * (L - x);
                    const M_ll = w_total_ll * (x / 2) * (L - x);

                    // Loads Moment is Sagging (+). Top Comp (+), Bot Tens (-).
                    // Code Tab 4: 
                    // fDL_top = (M * / Stop). Positive. Correct.
                    // fDL_bot = -(M * / Sbot). Negative. Correct.

                    const fload_t = ((M_dl + M_ll) * 100000 / Stop);
                    const fload_b = -((M_dl + M_ll) * 100000 / Sbot);

                    int_tot_t = feff_t + fload_t;
                    int_tot_b = feff_b + fload_b;
                }

                // External
                let ext_eff_t = 0, ext_eff_b = 0;
                {
                    const midX = seg.startX + seg.length / 2;
                    const pos = (seg.id === 29) ? state.extGeometry.anchorage.hinged.y : getUExtY(midX); // use midX for avg depth? or endX?
                    // renderTable3 uses getCableY(midX). 
                    // Let's match renderTable3 exactly.

                    const force = getUExtForce(seg.id);
                    const ep_ext = pos - sec.Y_top;
                    const meff = (force * ep_ext) / 100;
                    const fa_ext = (force * 1000) / sec.Area;
                    const Stop = sec.I / sec.Y_top;
                    const Sbot = sec.I / sec.Y_bot;

                    const fm_t = -(meff * 100000 / Stop);
                    const fm_b = (meff * 100000 / Sbot);

                    ext_eff_t = fa_ext + fm_t;
                    ext_eff_b = fa_ext + fm_b;
                }

                createVerifyRow(seg.id, int_tot_t, int_tot_b, ext_eff_t, ext_eff_b, seg.type);
            });
        }

        function createVerifyRow(id, t4_top, t4_bot, t5_top, t5_bot, type = 'standard') {
            const tbody = document.getElementById('strengtheningVerifyTableBody');
            const tr = document.createElement('tr');
            if (type === 'special') tr.className = 'bg-yellow-50';
            if (id === 0) tr.className = 'bg-amber-50';

            const str_top = t4_top + t5_top;
            const str_bot = t4_bot + t5_bot;

            const check_top = (str_top >= -14.97 && str_top <= 210.00) ? 'OK' : 'NG';
            const check_bot = (str_bot >= -14.97 && str_bot <= 210.00) ? 'OK' : 'NG';

            tr.innerHTML = `
                <td class="p-2 border border-slate-200 text-center font-bold text-slate-700">#${id}</td>
                <td class="p-2 border border-slate-200 text-right font-mono text-slate-600">${t4_top.toFixed(2)}</td>
                <td class="p-2 border border-slate-200 text-right font-mono text-slate-600">${t4_bot.toFixed(2)}</td>
                <td class="p-2 border border-amber-100 text-right font-mono text-amber-700 bg-amber-50">${t5_top.toFixed(2)}</td>
                <td class="p-2 border border-amber-100 text-right font-mono text-amber-700 bg-amber-50">${t5_bot.toFixed(2)}</td>
                <td class="p-2 border border-purple-100 text-right font-bold font-mono text-purple-700 bg-purple-50">${str_top.toFixed(2)}</td>
                <td class="p-2 border border-purple-100 text-right font-bold font-mono text-purple-700 bg-purple-50">${str_bot.toFixed(2)}</td>
                <td class="p-2 border border-slate-200 text-center font-bold ${check_top === 'OK' ? 'text-green-600' : 'text-red-600'}">${check_top}</td>
                <td class="p-2 border border-slate-200 text-center font-bold ${check_bot === 'OK' ? 'text-green-600' : 'text-red-600'}">${check_bot}</td>
             `;
            tbody.appendChild(tr);
        }

        function drawProfile(canvasNum, showExternal) {
            const canvas = document.getElementById(`profileCanvas${canvasNum}`);
            if (!canvas) return;

            // Resize canvas to match display size (High DPI / Full Width)
            const parent = canvas.parentElement;
            canvas.width = parent.clientWidth;
            canvas.height = parent.clientHeight;

            const ctx = canvas.getContext('2d');
            const w = canvas.width;
            const h = canvas.height;
            const L = state.span;

            ctx.clearRect(0, 0, w, h);

            const marginX = 30;
            const drawW = w - 2 * marginX;
            const scaleX = drawW / L;

            const beamTop = h * 0.35;
            const beamBot = h * 0.65;
            const beamH = beamBot - beamTop;

            // 1. Draw Segments
            state.segments.forEach(seg => {
                const xScreen = marginX + seg.startX * scaleX;
                const wScreen = seg.length * scaleX;

                // Box
                ctx.fillStyle = seg.type === 'special' ? '#e0e7ff' : '#f1f5f9';
                ctx.fillRect(xScreen, beamTop, wScreen, beamH);
                ctx.strokeStyle = '#cbd5e1';
                ctx.lineWidth = 1;
                ctx.strokeRect(xScreen, beamTop, wScreen, beamH);

                // Seg ID (Circle)
                const cx = xScreen + wScreen / 2;
                const cy = beamTop - 12;
                ctx.beginPath();
                ctx.arc(cx, cy, 7, 0, Math.PI * 2);
                ctx.fillStyle = seg.type === 'special' ? '#6366f1' : '#e2e8f0';
                ctx.fill();
                ctx.fillStyle = seg.type === 'special' ? '#fff' : '#475569';
                ctx.font = 'bold 9px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(seg.id, cx, cy);
            });

            // 2. Node Labels (Bottom)
            ctx.fillStyle = '#94a3b8';
            ctx.font = '9px sans-serif';
            ctx.textAlign = 'center';
            state.nodes.forEach((nodeX, i) => {
                const screenX = marginX + nodeX * scaleX;
                // Tick
                ctx.beginPath();
                ctx.moveTo(screenX, beamBot);
                ctx.lineTo(screenX, beamBot + 4);
                ctx.strokeStyle = '#94a3b8';
                ctx.stroke();
                // Text
                ctx.fillText('N' + (i + 1), screenX, beamBot + 12);
            });

            // 3. External Tendons (Only if showExternal)
            if (showExternal) {
                const dev1X = marginX + state.deviatorPos * scaleX;
                const dev2X = marginX + (L - state.deviatorPos) * scaleX;
                const anchorY = beamTop + 10;
                const midY = beamBot - 8;

                ctx.strokeStyle = '#ef4444';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(marginX, anchorY);
                ctx.lineTo(dev1X, midY);
                ctx.lineTo(dev2X, midY);
                ctx.lineTo(marginX + drawW, anchorY);
                ctx.stroke();

                // Deviators
                ctx.fillStyle = '#334155';
                ctx.fillRect(dev1X - 3, midY - 5, 6, 10);
                ctx.fillRect(dev2X - 3, midY - 5, 6, 10);
            }

            // Support Labels
            ctx.fillStyle = '#475569';
            ctx.font = 'bold 11px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            ctx.fillText('æ»‘å‹•ç«¯', marginX, beamBot + 18);
            ctx.fillText('é‰¸æ¥ç«¯', marginX + drawW, beamBot + 18);
        }

        // æ‡‰åŠ›å¡Šæ·±åº¦å’Œå½çŸ©æ‰¿è¼‰åŠ›è¡¨
        const STRESS_BLOCK_DATA = {
            1: { a: 2.57, Mn: 4577.81 },
            2: { a: 2.63, Mn: 4669.97 },
            3: { a: 2.65, Mn: 4714.72 },
            4: { a: 5.01, Mn: 8878.98 },
            5: { a: 5.07, Mn: 8970.28 },
            6: { a: 7.34, Mn: 12938.47 },
            7: { a: 7.38, Mn: 13013.44 },
            8: { a: 7.41, Mn: 13067.73 },
            9: { a: 9.54, Mn: 16748.89 },
            10: { a: 9.56, Mn: 16779.65 },
            11: { a: 9.56, Mn: 16789.90 },
            12: { a: 9.56, Mn: 16782.21 },
            13: { a: 9.36, Mn: 16446.28 },
            14: { a: 9.35, Mn: 16420.63 },
            15: { a: 9.49, Mn: 16661.72 },
            16: { a: 9.45, Mn: 16602.74 },
            17: { a: 9.41, Mn: 16523.23 },
            18: { a: 9.35, Mn: 16425.76 },
            19: { a: 9.28, Mn: 16307.73 },
            20: { a: 7.18, Mn: 12656.55 },
            21: { a: 7.11, Mn: 12537.52 },
            22: { a: 7.03, Mn: 12400.34 },
            23: { a: 4.84, Mn: 8565.81 },
            24: { a: 4.77, Mn: 8448.32 },
            25: { a: 2.52, Mn: 4477.74 },
            26: { a: 2.47, Mn: 4401.35 },
            27: { a: 0.19, Mn: 337.57 },
            28: { a: 0.19, Mn: 334.92 },
            29: { a: 0.19, Mn: 332.26 }
        };

        // æ©‹æ¢è‡ªé‡æ•¸æ“šè¡¨
        const DEAD_LOAD_DATA = [
            { id: 1, node: 3, area: 154965.75, length: 1.96, deadLoad: 38.74 },
            { id: 2, node: 2, area: 148772.65, length: 2.00, deadLoad: 37.19 },
            { id: 3, node: 1, area: 142399.00, length: 2.00, deadLoad: 35.60 },
            { id: 4, node: 1, area: 142399.00, length: 2.00, deadLoad: 35.60 },
            { id: 5, node: 1, area: 142399.00, length: 2.00, deadLoad: 35.60 },
            { id: 6, node: 1, area: 142399.00, length: 2.00, deadLoad: 35.60 },
            { id: 7, node: 1, area: 142399.00, length: 2.00, deadLoad: 35.60 },
            { id: 8, node: 1, area: 142399.00, length: 2.00, deadLoad: 35.60 },
            { id: 9, node: 1, area: 142399.00, length: 2.00, deadLoad: 35.60 },
            { id: 10, node: 1, area: 142399.00, length: 2.00, deadLoad: 35.60 },
            { id: 11, node: 1, area: 142399.00, length: 2.00, deadLoad: 35.60 },
            { id: 12, node: 1, area: 142399.00, length: 2.00, deadLoad: 35.60 },
            { id: 13, node: 1, area: 142399.00, length: 1.50, deadLoad: 35.60 },
            { id: 14, node: 1, area: 142399.00, length: 2.00, deadLoad: 35.60 },
            { id: 15, node: 1, area: 142399.00, length: 2.00, deadLoad: 35.60 },
            { id: 16, node: 1, area: 142399.00, length: 2.00, deadLoad: 35.60 },
            { id: 17, node: 1, area: 142399.00, length: 2.00, deadLoad: 35.60 },
            { id: 18, node: 1, area: 142399.00, length: 2.00, deadLoad: 35.60 },
            { id: 19, node: 1, area: 142399.00, length: 2.00, deadLoad: 35.60 },
            { id: 20, node: 1, area: 142399.00, length: 2.00, deadLoad: 35.60 },
            { id: 21, node: 1, area: 142399.00, length: 2.00, deadLoad: 35.60 },
            { id: 22, node: 1, area: 142399.00, length: 2.00, deadLoad: 35.60 },
            { id: 23, node: 1, area: 142399.00, length: 2.00, deadLoad: 35.60 },
            { id: 24, node: 1, area: 142399.00, length: 2.00, deadLoad: 35.60 },
            { id: 25, node: 1, area: 142399.00, length: 2.00, deadLoad: 35.60 },
            { id: 26, node: 1, area: 142399.00, length: 2.00, deadLoad: 35.60 },
            { id: 27, node: 1, area: 142399.00, length: 2.00, deadLoad: 35.60 },
            { id: 28, node: 4, area: 152342.65, length: 2.00, deadLoad: 38.09 },
            { id: 29, node: 5, area: 162045.75, length: 1.04, deadLoad: 40.51 }
        ];

        function renderTable() {
            const tbody = document.getElementById('stressTableBody');
            tbody.innerHTML = '';

            const tf_to_kn = 9.80665;
            const factor = state.unit === 'tf' ? 1 : tf_to_kn;

            state.segments.forEach(seg => {
                const tr = document.createElement('tr');
                if (seg.type === 'special') tr.className = 'highlight-row';

                const intVal = seg.internalTf * factor;
                const nodeId = getSegmentNode(seg.id);
                const stressData = STRESS_BLOCK_DATA[seg.id] || { a: 0, Mn: 0 };

                tr.innerHTML = `
                    <td class="font-bold text-slate-600 border-r border-slate-200">#${seg.id}</td>
                    <td class="text-center text-purple-600 font-bold border-r border-slate-200">${nodeId}</td>
                    <td class="text-xs text-slate-500 border-r border-slate-200">${seg.length.toFixed(2)}</td>
                    <td class="col-main border-r border-blue-200">${Math.round(intVal).toLocaleString()}</td>
                    <td class="col-main border-r border-orange-200">${stressData.a.toFixed(2)}</td>
                    <td class="col-tot text-green-600 font-bold">${stressData.Mn.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                `;
                tbody.appendChild(tr);
            });

            // Also render Tab 3 table
            renderTable3();
        }

        function renderTable3() {
            const tbody = document.getElementById('stressTableBody3');
            if (!tbody) return;
            tbody.innerHTML = '';

            // 1. Identify Blocks' Segments
            const blocks = state.extGeometry.deviationBlocks.blocks;
            const count = state.extGeometry.deviationBlocks.count;
            const b1_x = blocks[0].x;

            // Find segment containing b1_x (strictly: startX <= b1_x < endX)
            const b1_seg = state.segments.find(s => b1_x >= s.startX && b1_x < s.endX);
            const b1_id = b1_seg ? b1_seg.id : -1;

            let b2_id = -1;
            if (count === 2) {
                const b2_x = blocks[1].x;
                const b2_seg = state.segments.find(s => b2_x >= s.startX && b2_x < s.endX);
                b2_id = b2_seg ? b2_seg.id : -1;
            }

            // Helper: Y position (cm from top)
            const getCableY = (x) => {
                const ancSlideY = state.extGeometry.anchorage.sliding.y;
                const ancHingeY = state.extGeometry.anchorage.hinged.y;
                const b1_y = 278; // cm

                if (x <= b1_x) {
                    if (b1_x === 0) return ancSlideY;
                    return ancSlideY + (b1_y - ancSlideY) * (x / b1_x);
                }

                if (count === 2) {
                    const b2_x = blocks[1].x;
                    const b2_y = 278;
                    if (x <= b2_x) return 278; // Horizontal between blocks
                    if (x >= 56.5) return ancHingeY;
                    return b2_y + (ancHingeY - b2_y) * ((x - b2_x) / (56.5 - b2_x));
                } else {
                    if (x >= 56.5) return ancHingeY;
                    return b1_y + (ancHingeY - b1_y) * ((x - b1_x) / (56.5 - b1_x));
                }
            };

            // Helper: Cable Force (tf) based on Segment ID
            const getCableForce = (segId) => {
                const P = state.extGeometry.forceTf;
                const n1_ax = state.extResults.n1_axial || 0;
                const n30_ax = state.extResults.n30_axial || 0;

                // Seg #0 is treated as part of Range 1
                if (segId === 0) return n1_ax;

                // Range 1: N1 ~ Block 1 (Inclusive of Block 1 segment)
                if (segId <= b1_id) return n1_ax;

                if (count === 2) {
                    // Range 2: Between B1 and B2
                    if (segId < b2_id) return P;
                    return n30_ax;
                } else {
                    return n30_ax;
                }
            };

            // 1. Row #0 (x=0) used for Node 1 Baseline
            {
                const tr = document.createElement('tr');
                tr.className = 'bg-amber-100 font-bold';

                const f0 = getCableForce(0);
                const pos0 = state.extGeometry.anchorage.sliding.y; // Position from top

                // Node 3 Props (User Request)
                const nodeId = 3;
                const sec = BEAM_SECTIONS.find(s => s.id === nodeId);

                const y_top = sec ? sec.Y_top : 0;
                // const y_bot = sec ? sec.Y_bot : 0;
                const area = sec ? sec.Area : 0;
                const I_val = sec ? sec.I : 0;

                const ep_ext0 = pos0 - y_top;
                const meff0 = (f0 * ep_ext0) / 100;

                const faxial0 = area > 0 ? (f0 * 1000) / area : 0;

                // Effective Stress Calc
                // S_top = I/y_top (+), S_bot = I/y_bot (+)
                // Sign Convention: Compression is Positive (+), Tension is Negative (-)
                // User requirement: If Meff < 0 (High Cable): Top Comp (*-1 -> +), Bot Tens (No *-1 -> - if Meff/Sbot negative)

                const Stop = (y_top > 0) ? I_val / y_top : 0;
                const Sbot = (sec && sec.Y_bot) ? I_val / sec.Y_bot : 0; // Sbot Positive

                const faxial_calc = faxial0; // Comp is Positive

                // fm_top: Meff/Stop. If Meff < 0 -> (-). We want Comp (+). So * -1. 
                const fm_top0 = (Stop !== 0) ? -(meff0 * 100000 / Stop) : 0;
                // fm_bot: Meff/Sbot. If Meff < 0 -> (-). We want Tens (-). So keep sign.
                const fm_bot0 = (Sbot !== 0) ? (meff0 * 100000 / Sbot) : 0;

                const feff_top0 = fm_top0 + faxial_calc;
                const feff_bot0 = fm_bot0 + faxial_calc;

                tr.innerHTML = `
                    <td class="p-2 border-r border-slate-200 text-slate-700 text-center">#0</td>
                    <td class="p-2 border-r border-slate-200 text-slate-700 font-mono text-center">N${nodeId}</td>
                    <td class="p-2 border-r border-slate-200 text-slate-500 font-normal text-center">-</td>
                    <td class="p-2 border-r border-amber-200 text-amber-700 text-center">${f0.toFixed(2)}</td>
                    <td class="p-2 border-r border-slate-200 text-slate-700 text-center">${pos0.toFixed(2)}</td>
                    <td class="p-2 border-r border-green-50 text-green-700 text-center font-bold">${ep_ext0.toFixed(2)}</td>
                    <td class="p-2 border-r border-blue-100 text-blue-700 text-center font-bold" style="color: ${meff0 >= 0 ? '#2563eb' : '#dc2626'}">${meff0.toFixed(2)}</td>
                    <td class="p-2 border-r border-cyan-50 text-cyan-700 font-bold text-center" style="color: ${fm_top0 >= 0 ? '#2563eb' : '#dc2626'}">${fm_top0.toFixed(2)}</td>
                    <td class="p-2 border-r border-cyan-100 text-cyan-900 font-bold text-center" style="color: ${fm_bot0 >= 0 ? '#2563eb' : '#dc2626'}">${fm_bot0.toFixed(2)}</td>
                    <td class="p-2 border-r border-purple-50 text-purple-700 font-bold text-center">${faxial0.toFixed(2)}</td>
                    <td class="p-2 border-r border-indigo-50 text-indigo-700 font-bold text-center" style="color: ${feff_top0 >= 0 ? '#2563eb' : '#dc2626'}">${feff_top0.toFixed(2)}</td>
                    <td class="p-2 text-indigo-900 font-bold text-center" style="color: ${feff_bot0 >= 0 ? '#2563eb' : '#dc2626'}">${feff_bot0.toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            }

            // 2. Rows #1 ~ #29
            // 2. Rows #1 ~ #29
            state.segments.forEach(seg => {
                const tr = document.createElement('tr');

                // Determine Row Style & Label
                let rowClass = seg.type === 'special' ? 'bg-blue-50' : '';
                let idLabel = `#${seg.id}`;

                if (seg.id === b1_id) {
                    rowClass = 'bg-orange-100 border-l-4 border-orange-500';
                    idLabel += ' <span class="text-xs text-orange-700 block font-normal">(è½‰å‘å¡Š1)</span>';
                } else if (seg.id === b2_id) {
                    rowClass = 'bg-orange-100 border-l-4 border-orange-500';
                    idLabel += ' <span class="text-xs text-orange-700 block font-normal">(è½‰å‘å¡Š2)</span>';
                }

                tr.className = rowClass;

                const midX = seg.startX + seg.length / 2;

                const force = getCableForce(seg.id);
                // Seg #29 Position override (Hinged End Y)
                const pos = (seg.id === 29)
                    ? state.extGeometry.anchorage.hinged.y
                    : getCableY(midX);

                // Props
                const nodeId = getSegmentNode(seg.id);
                const sec = BEAM_SECTIONS.find(s => s.id === nodeId);

                const y_top = sec ? sec.Y_top : 0;
                // const y_bot = sec ? sec.Y_bot : 0;
                const area = sec ? sec.Area : 0;
                const I_val = sec ? sec.I : 0;

                const ep_ext = pos - y_top;
                const meff = (force * ep_ext) / 100;

                const faxial = area > 0 ? (force * 1000) / area : 0;

                // Effective Stress Calc
                const Stop = (y_top > 0) ? I_val / y_top : 0;
                const Sbot = (sec && sec.Y_bot) ? I_val / sec.Y_bot : 0; // Sbot Positive

                const faxial_calc = faxial; // Comp is Positive

                const fm_top = (Stop !== 0) ? -(meff * 100000 / Stop) : 0;
                const fm_bot = (Sbot !== 0) ? (meff * 100000 / Sbot) : 0;

                const feff_top = fm_top + faxial_calc;
                const feff_bot = fm_bot + faxial_calc;

                tr.innerHTML = `
                    <td class="p-2 border-r border-slate-200 text-slate-700 font-bold text-center align-middle">${idLabel}</td>
                    <td class="p-2 border-r border-slate-200 text-slate-700 text-center font-mono align-middle">N${nodeId}</td>
                    <td class="p-2 border-r border-slate-200 text-slate-500 text-xs text-center align-middle">${seg.length.toFixed(2)}</td>
                    <td class="p-2 border-r border-amber-200 text-amber-700 font-bold text-center align-middle">${force.toFixed(2)}</td>
                    <td class="p-2 border-r border-slate-200 text-slate-700 font-mono text-center align-middle">${pos.toFixed(2)}</td>
                    <td class="p-2 border-r border-green-50 text-green-700 font-bold text-center align-middle">${ep_ext.toFixed(2)}</td>
                    <td class="p-2 border-r border-blue-100 text-blue-700 font-bold text-center align-middle" style="color: ${meff >= 0 ? '#2563eb' : '#dc2626'}">${meff.toFixed(2)}</td>
                    <td class="p-2 border-r border-cyan-50 text-cyan-700 font-bold text-center align-middle" style="color: ${fm_top >= 0 ? '#2563eb' : '#dc2626'}">${fm_top.toFixed(2)}</td>
                    <td class="p-2 border-r border-cyan-100 text-cyan-900 font-bold text-center align-middle" style="color: ${fm_bot >= 0 ? '#2563eb' : '#dc2626'}">${fm_bot.toFixed(2)}</td>
                    <td class="p-2 border-r border-purple-50 text-purple-700 font-bold text-center align-middle">${faxial.toFixed(2)}</td>
                    <td class="p-2 border-r border-indigo-50 text-indigo-700 font-bold text-center align-middle" style="color: ${feff_top >= 0 ? '#2563eb' : '#dc2626'}">${feff_top.toFixed(2)}</td>
                    <td class="p-2 text-indigo-900 font-bold text-center align-middle" style="color: ${feff_bot >= 0 ? '#2563eb' : '#dc2626'}">${feff_bot.toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            });
        }



        function renderDeadLoadTable() {
            const tbody = document.getElementById('deadLoadTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            DEAD_LOAD_DATA.forEach(data => {
                const tr = document.createElement('tr');

                // Check if this is a special segment (åˆé¾æ®µ - segment 13)
                const segment = state.segments.find(s => s.id === data.id);
                if (segment && segment.type === 'special') {
                    tr.className = 'highlight-row';
                }

                tr.innerHTML = `
                    <td class="font-bold text-slate-600 border-r border-white">#${data.id}</td>
                    <td class="text-center text-purple-600 font-bold border-r border-white">${data.node}</td>
                    <td class="text-center text-green-600 font-bold border-r border-white">${data.area.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="text-center text-green-600 font-bold border-r border-white">${data.length.toFixed(2)}</td>
                    <td class="text-center text-green-600 font-bold">${data.deadLoad.toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderBendingMomentChart() {
            const ctx = document.getElementById('bendingMomentChart');
            if (!ctx) return;

            const labels = state.segments.map(s => `#${s.id}`);
            const data = state.segments.map(s => {
                const stressData = STRESS_BLOCK_DATA[s.id] || { Mn: 0 };
                return stressData.Mn;
            });

            const chartData = {
                labels: labels,
                datasets: [{
                    type: 'line',
                    label: 'å½çŸ©æ‰¿è¼‰åŠ› (tfÂ·m)',
                    data: data,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    pointRadius: 2,
                    pointBackgroundColor: '#3b82f6',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 1,
                    tension: 0.4,
                    fill: true
                }]
            };

            if (bendingMomentChartInst) {
                bendingMomentChartInst.data = chartData;
                bendingMomentChartInst.update();
            } else {
                bendingMomentChartInst = new Chart(ctx, {
                    type: 'line',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        interaction: { mode: 'index', intersect: false },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'æ©‹æ¢ç¸±å‘ç¯€æ®µ (Segment)',
                                    font: { size: 12, weight: 'bold' }
                                },
                                grid: { display: true, color: 'rgba(203, 213, 225, 0.2)' }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'å½çŸ©æ‰¿è¼‰åŠ› (tfÂ·m)',
                                    font: { size: 12, weight: 'bold' }
                                },
                                beginAtZero: true,
                                grid: { color: 'rgba(203, 213, 225, 0.3)' }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.8)',
                                padding: 12,
                                titleFont: { size: 12, weight: 'bold' },
                                bodyFont: { size: 11 },
                                callbacks: {
                                    label: (context) => {
                                        return `å½çŸ©: ${context.raw.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} tfÂ·m`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        } init();
    </script>
</body>

</html>
