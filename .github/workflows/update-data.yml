const https = require('https');
const fs = require('fs');

// --- çµ„æ…‹è¨­å®š ---
const SPREADSHEET_ID = '1GjhgGAUuI5g6rtOGiUceMLgeGy12sp93fNQlWKM-UGc';
const API_KEY = process.env.GOOGLE_API_KEY;

// äººå“¡è³‡æ–™å·¥ä½œè¡¨è¨­å®š (æ¬„ä½: å§“å, çµ„åˆ¥, è·ç¨±, å­¸æ­·, è­‰ç…§)
const PERSONNEL_SHEET = { name: 'å·¥ä½œè¡¨3', range: 'E1:I100', file: 'personnelData.json' };
// ç¸¾æ•ˆè³‡æ–™å·¥ä½œè¡¨è¨­å®š (ç¬¬ä¸€åˆ—ç‚ºçµ„åï¼Œç¬¬äºŒåˆ—ç‚ºé‡‘é¡)
const PERFORMANCE_SHEET = { name: 'å·¥ä½œè¡¨2', range: 'B1:F2', file: 'performanceData.json' };

// æª¢æŸ¥ API é‡‘é‘°æ˜¯å¦å­˜åœ¨
if (!API_KEY) {
  console.error('éŒ¯èª¤: æ‰¾ä¸åˆ° GOOGLE_API_KEY secretï¼è«‹åœ¨ GitHub å„²å­˜åº«çš„ Settings > Secrets and variables > Actions ä¸­è¨­å®šã€‚');
  process.exit(1);
}

// --- æ ¸å¿ƒå‡½å¼ ---

// å¾ Google Sheet API æŠ“å–è³‡æ–™çš„é€šç”¨å‡½å¼
function fetchSheetData(sheetName, range) {
  return new Promise((resolve, reject) => {
    // [ä¿®æ­£] å°æ¨£æ¿å­—é¢å€¼ä¸­çš„ '$' é€²è¡Œè·³è„«ï¼Œé¿å… shell è§£æéŒ¯èª¤
    const url = `https://sheets.googleapis.com/v4/spreadsheets/\${SPREADSHEET_ID}/values/\${encodeURIComponent(sheetName)}!\${range}?key=\${API_KEY}`;
    https.get(url, (res) => {
      let rawData = '';
      res.on('data', (chunk) => { rawData += chunk; });
      res.on('end', () => {
        try {
          const parsed = JSON.parse(rawData);
          if (parsed.values) {
            resolve(parsed.values);
          } else {
            // [ä¿®æ­£] å°æ¨£æ¿å­—é¢å€¼ä¸­çš„ '$' é€²è¡Œè·³è„«
            const errorMsg = parsed.error ? `Google API éŒ¯èª¤: \${JSON.stringify(parsed.error.message)}` : 'åœ¨å·¥ä½œè¡¨å›æ‡‰ä¸­æ‰¾ä¸åˆ° "values" æ¬„ä½ã€‚';
            reject(new Error(errorMsg));
          }
        } catch (e) { reject(e); }
      });
    }).on('error', (e) => reject(e));
  });
}

// [å„ªåŒ–] è™•ç†äººå“¡è³‡æ–™ï¼šå¢åŠ å°ç©ºè³‡æ–™çš„æª¢æŸ¥
function processPersonnelData(values) {
  if (!values || values.length < 1) {
    console.warn('âš ï¸ äººå“¡è³‡æ–™å·¥ä½œè¡¨ç‚ºç©ºæˆ–è®€å–å¤±æ•—ï¼Œç•¥éè™•ç†ã€‚');
    fs.writeFileSync(PERSONNEL_SHEET.file, JSON.stringify([], null, 2));
    return;
  }
  const headerMapping = { 'å§“å': 'name', 'çµ„åˆ¥': 'group', 'è·ç¨±': 'role', 'å­¸æ­·': 'education', 'è­‰ç…§': 'certificates' };
  const headers = values[0];
  const dataRows = values.slice(1);

  const personnel = dataRows.map(row => {
    const person = {};
    headers.forEach((header, index) => {
      const englishKey = headerMapping[header];
      if (englishKey) {
        const value = row[index] || '';
        if (englishKey === 'certificates') {
          person[englishKey] = value.split(/[,ã€ï¼Œ\\s]+/).map(cert => cert.trim()).filter(cert => cert);
        } else {
          person[englishKey] = value.trim();
        }
      }
    });
    return person;
  }).filter(p => p.name); 

  // [ä¿®æ­£] å°æ¨£æ¿å­—é¢å€¼ä¸­çš„ '$' é€²è¡Œè·³è„«
  fs.writeFileSync(PERSONNEL_SHEET.file, JSON.stringify(personnel, null, 2));
  console.log(`âœ… æˆåŠŸæ“·å–è³‡æ–™ä¸¦å¯«å…¥ \${PERSONNEL_SHEET.file}`);
}

// [å„ªåŒ–] è™•ç†ç¸¾æ•ˆè³‡æ–™ï¼šä½¿å…¶æ›´å…·å½ˆæ€§ï¼Œè™•ç†é•·åº¦ä¸åŒ¹é…çš„æƒ…æ³
function processPerformanceData(values) {
  if (!values || values.length < 2) {
    console.warn('âš ï¸ ç¸¾æ•ˆè³‡æ–™æ ¼å¼ä¸æ­£ç¢ºæˆ–ç‚ºç©ºï¼Œæ‡‰è‡³å°‘æœ‰å…©åˆ—ï¼ˆçµ„åˆ¥ã€é‡‘é¡ï¼‰ã€‚ç•¥éè™•ç†ã€‚');
    fs.writeFileSync(PERFORMANCE_SHEET.file, JSON.stringify([], null, 2));
    return;
  }

  const groups = values[0];
  const amounts = values[1];

  if (groups.length !== amounts.length) {
    // [ä¿®æ­£] å°æ¨£æ¿å­—é¢å€¼ä¸­çš„ '$' é€²è¡Œè·³è„«
    console.warn(`âš ï¸ è­¦å‘Š: çµ„åˆ¥æ•¸é‡ (\${groups.length}) èˆ‡é‡‘é¡æ•¸é‡ (\${amounts.length}) ä¸åŒ¹é…ã€‚å°‡ä»¥è¼ƒçŸ­çš„æ•¸é‡ç‚ºæº–é€²è¡Œè™•ç†ã€‚`);
  }

  const minLength = Math.min(groups.length, amounts.length);
  const transformedData = [];
  for (let i = 0; i < minLength; i++) {
    transformedData.push([groups[i], amounts[i]]);
  }

  fs.writeFileSync(PERFORMANCE_SHEET.file, JSON.stringify(transformedData, null, 2));
  // [ä¿®æ­£] å°æ¨£æ¿å­—é¢å€¼ä¸­çš„ '$' é€²è¡Œè·³è„«
  console.log(`âœ… æˆåŠŸæ“·å–ä¸¦è½‰æ›è³‡æ–™ï¼Œå¯«å…¥ \${PERFORMANCE_SHEET.file}`);
}

// --- ä¸»åŸ·è¡Œå‡½å¼ ---
async function main() {
  console.log('ğŸš€ é–‹å§‹å¾ Google Sheets æ›´æ–°è³‡æ–™...');
  try {
    const [personnelValues, performanceValues] = await Promise.all([
      fetchSheetData(PERSONNEL_SHEET.name, PERSONNEL_SHEET.range),
      fetchSheetData(PERFORMANCE_SHEET.name, PERFORMANCE_SHEET.range)
    ]);
    
    processPersonnelData(personnelValues);
    processPerformanceData(performanceValues);

    console.log('âœ¨ æ‰€æœ‰è³‡æ–™æ›´æ–°å®Œæˆï¼');
  } catch (error) {
    console.error('âŒ æ›´æ–°éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:', error.message);
    process.exit(1);
  }
}

main();
