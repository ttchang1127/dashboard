name: Update Dashboard Data

# æ¬Šé™è¨­å®šï¼šå…è¨± workflow å¯«å…¥å„²å­˜åº«å…§å®¹
permissions:
  contents: write

# è§¸ç™¼æ¢ä»¶ï¼š
on:
  # 1. æ¯å¤©çš„æ¯å€‹å°æ™‚çš„ç¬¬ 5 åˆ†é˜è‡ªå‹•åŸ·è¡Œä¸€æ¬¡
  schedule:
    - cron: '5 * * * *'
  # 2. å…è¨±æ‚¨åœ¨ Actions åˆ†é æ‰‹å‹•è§¸ç™¼æ­¤å·¥ä½œæµç¨‹
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      # æ­¥é©Ÿ 1: å°‡æ‚¨çš„å„²å­˜åº«ç¨‹å¼ç¢¼ checkout åˆ°è™›æ“¬ç’°å¢ƒä¸­
      - name: Checkout repository
        uses: actions/checkout@v4

      # æ­¥é©Ÿ 2: è¨­å®š Node.js ç’°å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # æ­¥é©Ÿ 3: åŸ·è¡Œ Node.js è…³æœ¬ä¾†æŠ“å–ä¸¦è™•ç†è³‡æ–™
      - name: Fetch and Process Data from Google Sheets
        run: |
          node -e "
            const https = require('https');
            const fs = require('fs');

            // --- çµ„æ…‹è¨­å®š ---
            const SPREADSHEET_ID = '1GjhgGAUuI5g6rtOGiUceMLgeGy12sp93fNQlWKM-UGc';
            const API_KEY = process.env.GOOGLE_API_KEY;

            // äººå“¡è³‡æ–™å·¥ä½œè¡¨è¨­å®š (æ¬„ä½: å§“å, çµ„åˆ¥, è·ç¨±, å­¸æ­·, è­‰ç…§)
            const PERSONNEL_SHEET = { name: 'å·¥ä½œè¡¨3', range: 'E1:I100', file: 'personnelData.json' };
            // ç¸¾æ•ˆè³‡æ–™å·¥ä½œè¡¨è¨­å®š (ç¬¬ä¸€åˆ—ç‚ºçµ„åï¼Œç¬¬äºŒåˆ—ç‚ºé‡‘é¡)
            const PERFORMANCE_SHEET = { name: 'å·¥ä½œè¡¨2', range: 'B1:F2', file: 'performanceData.json' };

            // æª¢æŸ¥ API é‡‘é‘°æ˜¯å¦å­˜åœ¨
            if (!API_KEY) {
              console.error('éŒ¯èª¤: æ‰¾ä¸åˆ° GOOGLE_API_KEY secretï¼è«‹åœ¨ GitHub å„²å­˜åº«çš„ Settings > Secrets and variables > Actions ä¸­è¨­å®šã€‚');
              process.exit(1);
            }

            // --- æ ¸å¿ƒå‡½å¼ ---

            // å¾ Google Sheet API æŠ“å–è³‡æ–™çš„é€šç”¨å‡½å¼
            function fetchSheetData(sheetName, range) {
              return new Promise((resolve, reject) => {
                const url = \`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(sheetName)}!${range}?key=${API_KEY}\`;
                https.get(url, (res) => {
                  let rawData = '';
                  res.on('data', (chunk) => { rawData += chunk; });
                  res.on('end', () => {
                    try {
                      const parsed = JSON.parse(rawData);
                      if (parsed.values) {
                        resolve(parsed.values);
                      } else {
                        const errorMsg = parsed.error ? \`Google API éŒ¯èª¤: ${JSON.stringify(parsed.error.message)}\` : 'åœ¨å·¥ä½œè¡¨å›æ‡‰ä¸­æ‰¾ä¸åˆ° \"values\" æ¬„ä½ã€‚';
                        reject(new Error(errorMsg));
                      }
                    } catch (e) { reject(e); }
                  });
                }).on('error', (e) => reject(e));
              });
            }

            // [ä¿®æ­£] è™•ç†äººå“¡è³‡æ–™ï¼šå°‡é™£åˆ—è½‰æ›ç‚ºç‰©ä»¶é™£åˆ—ï¼Œä¸¦å°‡è­‰ç…§è™•ç†æˆå­—ä¸²é™£åˆ—
            function processPersonnelData(values) {
              const headerMapping = { 'å§“å': 'name', 'çµ„åˆ¥': 'group', 'è·ç¨±': 'role', 'å­¸æ­·': 'education', 'è­‰ç…§': 'certificates' };
              const headers = values[0];
              const dataRows = values.slice(1);

              const personnel = dataRows.map(row => {
                const person = {};
                headers.forEach((header, index) => {
                  const englishKey = headerMapping[header];
                  if (englishKey) {
                    const value = row[index] || '';
                    if (englishKey === 'certificates') {
                      // å°‡è­‰ç…§å­—ä¸²åˆ†å‰²æˆé™£åˆ—ï¼Œä¸¦éæ¿¾ç©ºå€¼
                      person[englishKey] = value.split(/[,ã€ï¼Œ\\s]+/).map(cert => cert.trim()).filter(cert => cert);
                    } else {
                      person[englishKey] = value.trim();
                    }
                  }
                });
                return person;
              }).filter(p => p.name); // éæ¿¾æ‰å§“åç‚ºç©ºçš„ç„¡æ•ˆè³‡æ–™åˆ—

              fs.writeFileSync(PERSONNEL_SHEET.file, JSON.stringify(personnel, null, 2));
              console.log(\`âœ… æˆåŠŸæ“·å–è³‡æ–™ä¸¦å¯«å…¥ \${PERSONNEL_SHEET.file}\`);
            }

            // [ä¿®æ­£] è™•ç†ç¸¾æ•ˆè³‡æ–™ï¼šå°‡å…©åˆ—è³‡æ–™è½‰æ›ç‚ºå‰ç«¯éœ€è¦çš„ [çµ„åˆ¥, é‡‘é¡] é…å°æ ¼å¼
            function processPerformanceData(values) {
              // é æœŸè³‡æ–™æ ¼å¼:
              // values[0] = ["å³å­æ™º çµ„", "é™³å›¿ä»» çµ„", ...] (çµ„åˆ¥åç¨±)
              // values[1] = ["695756", "500000", ...] (å°æ‡‰é‡‘é¡)
              if (!values || values.length < 2 || values[0].length !== values[1].length) {
                const errorMsg = 'âŒ ç¸¾æ•ˆè³‡æ–™æ ¼å¼ä¸æ­£ç¢ºã€‚é æœŸæ‡‰æœ‰å…©åˆ—ï¼ˆçµ„åˆ¥ã€é‡‘é¡ï¼‰ï¼Œä¸”é•·åº¦ç›¸åŒã€‚';
                console.error(errorMsg);
                // å¯«å…¥ç©ºé™£åˆ—ä»¥é¿å…å‰ç«¯å‡ºéŒ¯ï¼Œä¸¦æ‹‹å‡ºéŒ¯èª¤è®“ workflow å¤±æ•—
                fs.writeFileSync(PERFORMANCE_SHEET.file, JSON.stringify([], null, 2));
                throw new Error(errorMsg);
              }

              const groups = values[0];
              const amounts = values[1];

              // ä½¿ç”¨ map å°‡å…©åˆ—è³‡æ–™ \"zip\" åœ¨ä¸€èµ·
              const transformedData = groups.map((group, index) => {
                return [group, amounts[index]];
              });

              fs.writeFileSync(PERFORMANCE_SHEET.file, JSON.stringify(transformedData, null, 2));
              console.log(\`âœ… æˆåŠŸæ“·å–ä¸¦è½‰æ›è³‡æ–™ï¼Œå¯«å…¥ \${PERFORMANCE_SHEET.file}\`);
            }

            // --- ä¸»åŸ·è¡Œå‡½å¼ ---
            async function main() {
              console.log('ğŸš€ é–‹å§‹å¾ Google Sheets æ›´æ–°è³‡æ–™...');
              try {
                const [personnelValues, performanceValues] = await Promise.all([
                  fetchSheetData(PERSONNEL_SHEET.name, PERSONNEL_SHEET.range),
                  fetchSheetData(PERFORMANCE_SHEET.name, PERFORMANCE_SHEET.range)
                ]);
                
                processPersonnelData(personnelValues);
                processPerformanceData(performanceValues);

                console.log('âœ¨ æ‰€æœ‰è³‡æ–™æ›´æ–°å®Œæˆï¼');
              } catch (error) {
                console.error('âŒ æ›´æ–°éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:', error.message);
                process.exit(1);
              }
            }

            main();
          "
        env:
          # å°‡æˆ‘å€‘è¨­å®šçš„ secret æ³¨å…¥åˆ°åŸ·è¡Œç’°å¢ƒä¸­
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}

      # æ­¥é©Ÿ 4: å¦‚æœæª”æ¡ˆæœ‰è®Šå‹•ï¼Œå°±è‡ªå‹• commit ä¸¦ push å›å„²å­˜åº«
      - name: Commit and push if there are changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          # å°‡å…©å€‹ JSON æª”æ¡ˆéƒ½åŠ å…¥åˆ°æš«å­˜å€
          git add personnelData.json performanceData.json
          # æª¢æŸ¥æ˜¯å¦æœ‰æª”æ¡ˆè®Šå‹•
          if ! git diff --staged --quiet; then
            git commit -m 'chore(data): è‡ªå‹•æ›´æ–°å„€è¡¨æ¿è³‡æ–™'
            git push
            echo "è³‡æ–™å·²æ›´æ–°ä¸¦æ¨é€è‡³å„²å­˜åº«ã€‚"
          else
            echo "è³‡æ–™ç„¡è®Šå‹•ï¼Œç„¡éœ€æ¨é€ã€‚"
          fi
