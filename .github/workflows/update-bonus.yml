# .github/workflows/update-bonus.yml
name: Update Bonus Limit Data

permissions:
  contents: write

on:
  schedule:
    - cron: '5 * * * *' # æ¯å°æ™‚åŸ·è¡Œä¸€æ¬¡
  workflow_dispatch:      # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  update-bonus:
    runs-on: self-hosted # æˆ– ubuntu-latestï¼Œè¦–æ‚¨çš„ç’°å¢ƒè€Œå®š
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Fetch Bonus Data and save to JSON
        run: |
          node -e "
            const https = require('https');
            const fs = require('fs');

            // --- è¨­å®š ---
            const SPREADSHEET_ID = '1GjhgGAUuI5g6rtOGiUceMLgeGy12sp93fNQlWKM-UGc';
            const API_KEY = process.env.GOOGLE_API_KEY;
            
            // è¨­å®šè®€å–ç¯„åœï¼šå·¥ä½œè¡¨5ï¼ŒA2åˆ°B20 (å‡è¨­çµ„åˆ¥åœ¨Aæ¬„ï¼Œé‡‘é¡åœ¨Bæ¬„ï¼Œä¸”æœ‰æ¨™é¡Œåˆ—)
            const BONUS_SHEET = { name: 'å·¥ä½œè¡¨5', range: 'A2:B20', file: 'bonus.json' };

            if (!API_KEY) {
              console.error('éŒ¯èª¤: æ‰¾ä¸åˆ° GOOGLE_API_KEY secretï¼');
              process.exit(1);
            }

            function fetchSheetData(sheetName, range) {
              return new Promise((resolve, reject) => {
                const url = \`https://sheets.googleapis.com/v4/spreadsheets/\${SPREADSHEET_ID}/values/\${encodeURIComponent(sheetName)}!\${range}?key=\${API_KEY}\`;
                https.get(url, (res) => {
                  let rawData = '';
                  res.on('data', (chunk) => { rawData += chunk; });
                  res.on('end', () => {
                    try {
                      const parsed = JSON.parse(rawData);
                      if (parsed.values) resolve(parsed.values);
                      else reject(new Error(parsed.error ? JSON.stringify(parsed.error) : 'No values found'));
                    } catch (e) { reject(e); }
                  });
                }).on('error', (e) => reject(e));
              });
            }

            async function main() {
              console.log('ğŸš€ é–‹å§‹è®€å–åˆ†é…é‡‘é¡è³‡æ–™...');
              try {
                const values = await fetchSheetData(BONUS_SHEET.name, BONUS_SHEET.range);
                
                // --- è³‡æ–™è½‰æ›é‚è¼¯ ---
                // å°‡äºŒç¶­é™£åˆ—è½‰æ›ç‚ºç‰©ä»¶: { 'å­æ™ºçµ„': 600000, 'å›¿ä»»çµ„': 700000 }
                const bonusMap = {};
                values.forEach(row => {
                  const groupName = row[0] ? row[0].trim() : null;
                  const amountStr = row[1];
                  
                  if (groupName && amountStr) {
                    // ç§»é™¤é‡‘é¡ä¸­çš„é€—è™Ÿä¸¦è½‰ç‚ºæ•¸å­—
                    const amount = parseInt(String(amountStr).replace(/,/g, ''), 10);
                    if (!isNaN(amount)) {
                      bonusMap[groupName] = amount;
                    }
                  }
                });

                fs.writeFileSync(BONUS_SHEET.file, JSON.stringify(bonusMap, null, 2), 'utf8');
                console.log(\`âœ… æˆåŠŸå»ºç«‹ \${BONUS_SHEET.file}\`);
                console.log('é è¦½è³‡æ–™:', JSON.stringify(bonusMap));

              } catch (error) {
                console.error('âŒ éŒ¯èª¤:', error);
                process.exit(1);
              }
            }

            main();
          "
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}

      - name: Commit and push if changed
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          if [ -z "$(git status --porcelain)" ]; then
            echo "è³‡æ–™ç„¡è®Šå‹•ã€‚"
            exit 0
          fi

          echo "åµæ¸¬åˆ°è®Šå‹•ï¼Œæº–å‚™æ¨é€..."
          git add bonus.json
          git commit -m "chore: æ›´æ–°å¹´çµ‚åˆ†é…é‡‘é¡è³‡æ–™"
          git push