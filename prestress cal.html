<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é åŠ›æå¤±è¨ˆç®—å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
            /* bg-slate-50 */
        }

        .input-group {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            /* mb-2 */
        }

        .input-label {
            width: 200px;
            /* Fixed width for label */
            flex-shrink: 0;
            font-size: 0.875rem;
            /* text-sm */
            color: #334155;
            /* text-slate-700 */
        }

        .input-container {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .input-field {
            width: 100%;
            padding: 0.5rem 0.75rem;
            /* py-2 px-3 */
            border: 1px solid #cbd5e1;
            /* border-slate-300 */
            border-radius: 0.375rem;
            /* rounded-md */
            text-align: right;
            -moz-appearance: textfield;
        }

        .input-field::-webkit-outer-spin-button,
        .input-field::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .unit-display {
            width: 50px;
            /* Fixed width for unit */
            flex-shrink: 0;
            text-align: left;
            margin-left: 0.5rem;
            /* ml-2 */
            font-size: 0.875rem;
            /* text-sm */
            color: #475569;
            /* text-slate-600 */
        }

        .stepper-btn {
            width: 2.5rem;
            /* w-10 */
            height: 2.5rem;
            /* h-10 */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: #f1f5f9;
            /* bg-slate-100 */
            color: #475569;
            /* text-slate-600 */
            border: 1px solid #cbd5e1;
            /* border-slate-300 */
            border-radius: 0.375rem;
            /* rounded-md */
            margin-left: 0.25rem;
            /* ml-1 */
            font-size: 1.25rem;
            /* text-xl */
            font-weight: 600;
            /* font-semibold */
            cursor: pointer;
            user-select: none;
        }

        .stepper-btn:hover {
            background-color: #e2e8f0;
            /* hover:bg-slate-200 */
        }

        .suggestion-text {
            font-size: 0.75rem;
            /* text-xs */
            color: #64748b;
            /* text-slate-500 */
            margin-top: -0.25rem;
            /* -mt-1 */
            margin-bottom: 0.5rem;
            /* mb-2 */
            padding-left: 200px;
            /* Align with input start */
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
        }

        .result-table th,
        .result-table td {
            border: 1px solid #e2e8f0;
            /* border-slate-200 */
            padding: 0.75rem;
            /* p-3 */
            text-align: right;
        }

        .result-table th {
            background-color: #f8fafc;
            /* bg-slate-50 */
            text-align: left;
            font-weight: 600;
            /* font-semibold */
            color: #334155;
            /* text-slate-700 */
        }

        .result-table td:first-child {
            text-align: left;
            color: #475569;
            /* text-slate-600 */
        }

        .result-table .total-row td {
            font-weight: 700;
            /* font-bold */
            background-color: #f1f5f9;
            /* bg-slate-100 */
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            /* py-3 px-6 */
            font-size: 1rem;
            /* text-base */
            font-weight: 600;
            /* font-semibold */
            border-radius: 0.375rem 0.375rem 0 0;
            /* rounded-t-md */
            cursor: pointer;
            border: 1px solid #e2e8f0;
            /* border-slate-200 */
            border-bottom: 0;
            background-color: #ffffff;
            /* bg-white */
            color: #334155;
            /* text-slate-700 */
        }

        .tab-btn.active {
            background-color: #0f172a;
            /* bg-slate-900 */
            color: #ffffff;
            /* text-white */
            border-color: #0f172a;
            /* border-slate-900 */
        }

        .tab-btn:not(.active):hover {
            background-color: #f8fafc;
            /* hover:bg-slate-50 */
        }

        .tab-panel {
            border-top: 2px solid #0f172a;
            /* border-t-2 border-slate-900 */
        }

        /* Styles for calculation detail blocks */
        .formula-display {
            background-color: #f1f5f9;
            /* bg-slate-100 */
            padding: 0.75rem;
            /* p-3 */
            border-radius: 0.375rem;
            /* rounded-md */
            font-family: 'Menlo', 'Courier New', monospace;
            font-size: 0.875rem;
            /* text-sm */
            color: #334155;
            /* text-slate-700 */
            margin: 1rem 0;
            /* my-4 */
            text-align: left;
            /* Changed from center */
            overflow-x: auto;
            white-space: pre;
        }

        .variable-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.35rem 0;
            /* py-1.5 */
            border-bottom: 1px solid #e2e8f0;
            /* border-slate-200 */
        }

        .variable-list li span:first-child {
            font-weight: 600;
            /* font-semibold */
            color: #1e293b;
            /* text-slate-800 */
        }

        .variable-list li span:nth-child(2) {
            font-family: 'Menlo', 'Courier New', monospace;
            color: #475569;
            /* text-slate-600 */
        }

        .variable-list li span:last-child {
            color: #64748b;
            /* text-slate-500 */
            min-width: 60px;
            text-align: left;
        }

        .calculation-step {
            font-family: 'Menlo', 'Courier New', monospace;
            font-size: 0.875rem;
            /* text-sm */
            color: #1e293b;
            /* text-slate-800 */
            margin-top: 1rem;
            /* mt-4 */
            overflow-x: auto;
            white-space: pre;
            padding: 0.5rem;
            background: #f8fafc;
            border-radius: 0.25rem;
            text-align: left;
            /* Ensure left alignment */
        }

        .final-loss-result {
            font-weight: 700;
            /* font-bold */
            font-size: 1.125rem;
            /* text-lg */
            color: #1e3a8a;
            /* text-blue-900 */
            margin-top: 1rem;
            /* mt-4 */
            padding-top: 1rem;
            /* pt-4 */
            border-top: 1px solid #cbd5e1;
            /* border-slate-300 */
            text-align: left;
            /* Changed from right */
        }

        .final-loss-result span {
            font-size: 0.875rem;
            color: #334155;
            font-weight: 500;
        }

        /* =========================================
           PRINT LAYOUT STYLES (Strict A4)
           ========================================= */
        :root {
            --a4-width: 210mm;
            --a4-height: 297mm;
            --print-padding: 12mm;
            /* Reduced from 20mm */
        }

        @media print {
            body {
                background-color: white !important;
                -webkit-print-color-adjust: exact;
                margin: 0;
                padding: 0;
            }

            .screen-ui {
                display: none !important;
            }

            .print-ui {
                display: block !important;
            }

            @page {
                size: A4;
                margin: 0;
            }
        }

        .print-ui {
            display: none;
            /* Hidden on screen */
            width: var(--a4-width);
            background: white;
            font-family: "Times New Roman", "PMingLiU", serif;
            color: #000;
        }

        .print-page {
            width: var(--a4-width);
            /* min-height: var(--a4-height); REMOVED to prevent blank pages */
            padding: 10mm;
            /* Reduced from 12mm */
            box-sizing: border-box;
            position: relative;
        }

        /* Force page break only before the 2nd page, never after the last */
        .print-page+.print-page {
            page-break-before: always;
        }

        .print-header {
            text-align: center;
            border-bottom: 2px solid #000;
            margin-bottom: 0.5rem;
            /* Reduced from 1.5rem */
            padding-bottom: 5px;
            /* Reduced from 10px */
        }

        .print-header h1 {
            font-size: 16pt;
            /* Reduced from 20pt */
            font-weight: bold;
            margin: 0;
            letter-spacing: 1px;
        }

        .print-header h2 {
            font-size: 12pt;
            font-weight: normal;
            margin: 5px 0 0 0;
        }

        .print-section {
            margin-bottom: 1rem;
            /* Reduced from 2rem */
            page-break-inside: avoid;
        }

        .print-section-title {
            font-size: 14pt;
            font-weight: bold;
            border-bottom: 1px solid #000;
            margin-bottom: 1rem;
            padding-bottom: 4px;
        }

        .print-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9pt;
            /* Reduced from 11pt */
            margin-bottom: 0.5rem;
        }

        .print-table th,
        .print-table td {
            border: 1px solid #000;
            padding: 6px 8px;
            text-align: left;
        }

        .print-table th {
            background-color: #f0f0f0 !important;
            font-weight: bold;
            text-align: center;
        }

        .print-table td.num {
            text-align: right;
            font-family: "Courier New", monospace;
        }

        .print-kv-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px 10px;
            /* Tighter gap */
            font-size: 9pt;
            /* Reduced from 10pt */
            margin-bottom: 0.5rem;
        }

        .print-kv-item {
            display: flex;
            border-bottom: 1px dashed #ccc;
            padding-bottom: 2px;
        }

        .print-kv-label {
            font-weight: bold;
            margin-right: auto;
        }

        .print-kv-value {
            font-family: "Courier New", monospace;
        }

        .print-calc-block {
            border: 1px solid #ddd;
            padding: 5px;
            /* Reduced from 8px */
            margin-bottom: 5px;
            /* Reduced from 8px */
            font-size: 9pt;
            /* Reduced from 10pt */
            background-color: #fafafa !important;
        }

        .print-formula {
            font-family: "Courier New", monospace;
            margin-bottom: 2px;
            font-weight: bold;
            font-size: 10pt;
            /* Reduced from 11pt */
        }

        .print-sub {
            padding-left: 10px;
            color: #444;
            line-height: 1.2;
            /* Tighter line height */
        }

        .print-footer {
            margin-top: 3rem;
            border-top: 1px solid #000;
            padding-top: 5px;
            font-size: 9pt;
            display: flex;
            justify-content: space-between;
        }

        .print-variable-list {
            list-style: none;
            padding: 0;
            margin: 5px 0 10px 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 9pt;
            color: #555;
        }

        .print-variable-list li {
            display: flex;
            gap: 4px;
        }

        .print-variable-list li span:first-child {
            font-weight: bold;
        }
    </style>
</head>

<body>
    <!-- Chosen Palette: Slate -->
    <!-- Application Structure Plan: 
        å°‡æ‡‰ç”¨ç¨‹å¼è¨­è¨ˆç‚ºä¸€å€‹é›™æ¬„ä½ˆå±€çš„äº’å‹•å¼å„€è¡¨æ¿ã€‚
        å·¦æ¬„ï¼ˆè¼¸å…¥å€ï¼‰ï¼šåŒ…å«æ‰€æœ‰ä½¿ç”¨è€…å¯èª¿åƒæ•¸ã€‚åƒæ•¸åˆ†ç‚ºã€ŒåŸºç¤åƒæ•¸ã€å’Œã€Œé¡å¤–å·¥ç¨‹åƒæ•¸ã€å…©çµ„ï¼Œæ¯çµ„éƒ½æœ‰æ¸…æ™°çš„æ¨™é¡Œã€‚é€™ç¨®åˆ†çµ„ä½¿ç”¨æˆ¶å¯ä»¥å°ˆæ³¨æ–¼ä»–å€‘æœ€å¸¸èª¿æ•´çš„è®Šæ•¸ã€‚
        å³æ¬„ï¼ˆçµæœå€ï¼‰ï¼šå³æ™‚é¡¯ç¤ºè¨ˆç®—çµæœã€‚çµæœåˆ†ç‚ºã€Œæ–½å·¥éšæ®µé åŠ›æå¤±ã€å’Œã€Œé•·æœŸé åŠ›æå¤±ã€å…©å€‹ä¸»è¦éƒ¨åˆ†ï¼Œä¸¦ä»¥è¡¨æ ¼å½¢å¼æ¸…æ™°å‘ˆç¾ï¼ŒåŒ…å«çµ•å°å€¼å’Œç™¾åˆ†æ¯”ã€‚
        ä¸‹æ–¹ï¼ˆè¦–è¦ºåŒ–å€ï¼‰ï¼šä¸€å€‹ç”œç”œåœˆåœ–è¡¨ï¼Œæä¾›æå¤±åˆ†ä½ˆçš„å¿«é€Ÿè¦–è¦ºæ¦‚è¦½ã€‚
        (æ–°å¢) åˆ†é ç³»çµ±ï¼š
        - æ¨™ç±¤1 "è¨ˆç®—çµæœ": é¡¯ç¤ºä¸Šè¿°çš„ "å³æ¬„" å’Œ "ä¸‹æ–¹" å€åŸŸã€‚
        - æ¨™ç±¤2 "é åŠ›æå¤±è¨ˆç®—": é¡¯ç¤ºä¸€å€‹æ–°çš„ "å–®æ¬„" ä½ˆå±€ï¼Œè©³ç´°èªªæ˜æ¯ç¨®æå¤±çš„è¨ˆç®—å…¬å¼ã€è®Šæ•¸å’Œéç¨‹ã€‚
        ç†ç”±ï¼šå°‡ "æ‘˜è¦" (è¨ˆç®—çµæœ) å’Œ "è©³ç´°" (è¨ˆç®—éç¨‹) åˆ†é–‹ï¼Œä½¿ç”¨æˆ¶å¯ä»¥é¸æ“‡ä»–å€‘éœ€è¦çš„è³‡è¨Šæ·±åº¦ï¼ŒåŒæ™‚ä¿æŒä¸»å„€è¡¨æ¿çš„ç°¡æ½”æ€§ã€‚å–®æ¬„ä½ˆå±€å¯ç¡®ä¿è¨ˆç®—éç¨‹çš„é–±è®€é€£è²«æ€§ã€‚
    -->
    <!-- Visualization & Content Choices: 
        1. å ±å‘Šè³‡è¨Š: æ–½å·¥éšæ®µæå¤± (æ‘©æ“¦, æ»‘å‹•, å½ˆæ€§ç¸®çŸ­)
           - ç›®æ¨™: é¡¯ç¤ºç²¾ç¢ºçš„è¨ˆç®—å€¼åŠå…¶ç›¸å°é‡è¦æ€§ã€‚
           - å‘ˆç¾æ–¹å¼: è¡¨æ ¼ (HTML)ã€‚
           - äº’å‹•: æ ¹æ“šå·¦å´è¼¸å…¥å‹•æ…‹æ›´æ–°ã€‚
           - ç†ç”±: è¡¨æ ¼æ˜¯å‘ˆç¾åˆ†é¡æ•¸å€¼æ•¸æ“šåŠå…¶ç¸½å’Œçš„æœ€æ¸…æ™°æ–¹å¼ã€‚
           - åº«/æ–¹æ³•: Vanilla JSã€‚
        2. å ±å‘Šè³‡è¨Š: é•·æœŸæå¤± (ä¹¾ç¸®, æ½›è®Š, é¬†å¼›)
           - ç›®æ¨™: é¡¯ç¤ºç²¾ç¢ºçš„è¨ˆç®—å€¼åŠå…¶ç›¸å°é‡è¦æ€§ã€‚
           - å‘ˆç¾æ–¹å¼: è¡¨æ ¼ (HTML)ã€‚
           - äº’å‹•: æ ¹æ“šå·¦å´è¼¸å…¥å‹•æ…‹æ›´æ–°ã€‚
           - ç†ç”±: åŒä¸Šï¼Œè¡¨æ ¼çµæ§‹ä¿æŒä¸€è‡´æ€§ã€‚
           - åº«/æ–¹æ³•: Vanilla JSã€‚
        3. å ±å‘Šè³‡è¨Š: å„é …æå¤±ä½”ç¸½æå¤±çš„ç™¾åˆ†æ¯”
           - ç›®æ¨™: å¿«é€Ÿè¦–è¦ºåŒ–æ¯”è¼ƒå„æå¤±ä¾†æºçš„è²¢ç»åº¦ã€‚
           - å‘ˆç¾æ–¹å¼: ç”œç”œåœˆåœ– (Doughnut Chart)ã€‚
           - äº’å‹•: åœ–è¡¨æ ¹æ“šè¼¸å…¥å‹•æ…‹æ›´æ–°ï¼Œé¼ æ¨™æ‡¸åœé¡¯ç¤ºè©³ç´°è³‡è¨Šã€‚
           - ç†ç”±: ç”œç”œåœˆåœ–éå¸¸é©åˆé¡¯ç¤ºéƒ¨åˆ†èˆ‡æ•´é«”çš„é—œä¿‚ã€‚
           - åº«/æ–¹æ³•: Chart.js (Canvas)ã€‚
        4. å ±å‘Šè³‡è¨Š: æ‰€æœ‰è¼¸å…¥åƒæ•¸ (L, B, H, Î¼, k, Î”a, RH, fpu, Es, Ec, Ap, Ïƒj, Anet, Inet, Ycg, Ha, MDL, MADL)
           - ç›®æ¨™: å…è¨±ç”¨æˆ¶ä¿®æ”¹è¨ˆç®—ä¾æ“šã€‚
           - å‘ˆç¾æ–¹å¼: æ•¸å­—è¼¸å…¥æ¡† (HTML <input type="number">) æ­é…è‡ªè¨‚æ­¥é€²æŒ‰éˆ•å’Œä¸‹æ‹‰é¸å–®ã€‚
           - äº’å‹•: ç”¨æˆ¶å¯ä»¥æ‰‹å‹•è¼¸å…¥ã€ä½¿ç”¨æŒ‰éˆ•å¾®èª¿æˆ–å¾é¸å–®ä¸­é¸æ“‡ã€‚
           - ç†ç”±: æä¾›éˆæ´»çš„è¼¸å…¥æ–¹å¼ï¼Œè‡ªè¨‚æŒ‰éˆ•æä¾›äº†æ¯”ç€è¦½å™¨é è¨­æ›´å¥½çš„æ§åˆ¶ã€‚
           - åº«/æ–¹æ³•: HTML + Vanilla JSã€‚
        5. (æ–°å¢) å ±å‘Šè³‡è¨Š: 6ç¨®æå¤±çš„è¨ˆç®—éç¨‹
           - ç›®æ¨™: é€æ˜åŒ–é¡¯ç¤ºè¨ˆç®—ä¾æ“šçš„å…¬å¼å’Œä¸­é–“å€¼ã€‚
           - å‘ˆç¾æ–¹å¼: 6å€‹å…§å®¹å€å¡Š (HTML)ï¼Œåœ¨å–®æ¬„ä¸­å‚ç›´æ’åˆ—ã€‚
           - äº’å‹•: æ ¹æ“šå·¦å´è¼¸å…¥å‹•æ…‹æ›´æ–°æ‰€æœ‰å€¼ã€‚(ç¾åœ¨åŒ…å«æ‰€æœ‰ç²¾ç¢ºå…¬å¼)
           - ç†ç”±: æ»¿è¶³é«˜ç´šç”¨æˆ¶æˆ–å­¸ç”Ÿå°è¨ˆç®—éç¨‹çš„å¥½å¥‡å¿ƒå’Œé©—è­‰éœ€æ±‚ã€‚å–®æ¬„ä½ˆå±€å¯ç¢ºä¿é–±è®€é †æš¢ã€‚
           - åº«/METHOD: Vanilla JSã€‚
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

    <div class="screen-ui">
        <div class="container mx-auto p-4 sm:p-8 max-w-7xl">
            <header class="mb-8">
                <h1 class="text-3xl font-bold text-slate-800">é åŠ›æå¤±è¨ˆç®—å™¨ (Prestressed Loss Calculator)</h1>
                <p class="text-lg text-slate-600 mt-2">æ ¹æ“šè¼¸å…¥åƒæ•¸ä¼°ç®—æ–½å·¥éšæ®µèˆ‡é•·æœŸé åŠ›æå¤±ã€‚</p>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

                <!-- ====== è¼¸å…¥åƒæ•¸æ¬„ ====== -->
                <div id="input-section" class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 lg:row-span-2">
                    <h2 class="text-xl font-semibold text-slate-700 mb-6 border-b pb-3">è¼¸å…¥åƒæ•¸</h2>

                    <!-- åŸºç¤åƒæ•¸ -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6">
                        <div>
                            <label for="L" class="input-label block mb-1">æ©‹æ¢è·¨åº¦ (L)</label>
                            <div class="input-group">
                                <div class="input-container">
                                    <input type="number" id="L" value="1240" step="10" class="input-field">
                                    <span class="unit-display">cm</span>
                                    <button class="stepper-btn" data-target="L" data-step="10"
                                        data-action="inc">+</button>
                                    <button class="stepper-btn" data-target="L" data-step="10"
                                        data-action="dec">-</button>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="B" class="input-label block mb-1">éŒ¨å›ºé»è‡³æ¢ä¸­å¤®æ°´å¹³è·é›¢ (B)</label>
                            <div class="input-group">
                                <div class="input-container">
                                    <input type="number" id="B" value="615" step="5" class="input-field">
                                    <span class="unit-display">cm</span>
                                    <button class="stepper-btn" data-target="B" data-step="5"
                                        data-action="inc">+</button>
                                    <button class="stepper-btn" data-target="B" data-step="5"
                                        data-action="dec">-</button>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="H" class="input-label block mb-1">éŒ¨å›ºé»è‡³æ¢ä¸­å¤®å‚ç›´è·é›¢ (H)</label>
                            <div class="input-group">
                                <div class="input-container">
                                    <input type="number" id="H" value="20" step="1" class="input-field">
                                    <span class="unit-display">cm</span>
                                    <button class="stepper-btn" data-target="H" data-step="1"
                                        data-action="inc">+</button>
                                    <button class="stepper-btn" data-target="H" data-step="1"
                                        data-action="dec">-</button>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="mu" class="input-label block mb-1">æ‘©æ“¦æ›²ç‡æ•ˆæ‡‰ä¿‚æ•¸ (Î¼)</label>
                            <div class="input-group">
                                <div class="input-container">
                                    <input type="number" id="mu" value="0.25" step="0.01" class="input-field">
                                    <span class="unit-display">1/rad</span>
                                    <button class="stepper-btn" data-target="mu" data-step="0.01"
                                        data-action="inc">+</button>
                                    <button class="stepper-btn" data-target="mu" data-step="0.01"
                                        data-action="dec">-</button>
                                </div>
                            </div>
                            <p class="suggestion-text pl-0 md:pl-0 text-left">å»ºè­°å€¼: 0.15 ~ 0.25 (éé‹…å¥—ç®¡)</p>
                        </div>

                        <div>
                            <label for="k" class="input-label block mb-1">æ³¢æµªæ‘©æ“¦ä¿‚æ•¸ (k)</label>
                            <div class="input-group">
                                <div class="input-container">
                                    <input type="number" id="k" value="0.0049" step="0.0001" class="input-field">
                                    <span class="unit-display">1/m</span>
                                    <button class="stepper-btn" data-target="k" data-step="0.0001"
                                        data-action="inc">+</button>
                                    <button class="stepper-btn" data-target="k" data-step="0.0001"
                                        data-action="dec">-</button>
                                </div>
                            </div>
                            <p class="suggestion-text pl-0 md:pl-0 text-left">å»ºè­°å€¼: 0.0049 (éé‹…é‡‘å±¬å¥—ç®¡)</p>
                        </div>

                        <div>
                            <label for="delta_a" class="input-label block mb-1">éŒ¨å…·æ»‘å‹•é‡ (Î”a)</label>
                            <div class="input-group">
                                <div class="input-container">
                                    <input type="number" id="delta_a" value="6" step="0.5" class="input-field">
                                    <span class="unit-display">mm</span>
                                    <button class="stepper-btn" data-target="delta_a" data-step="0.5"
                                        data-action="inc">+</button>
                                    <button class="stepper-btn" data-target="delta_a" data-step="0.5"
                                        data-action="dec">-</button>
                                </div>
                            </div>
                            <p class="suggestion-text pl-0 md:pl-0 text-left">å»ºè­°å€¼: å°ç£(6mm), æ—¥æœ¬(5-7mm)</p>
                        </div>

                        <div>
                            <label for="RH" class="input-label block mb-1">å¹´å¹³å‡æ¿•åº¦ (RH)</label>
                            <div class="input-group">
                                <div class="input-container">
                                    <input type="number" id="RH" value="80" step="1" class="input-field">
                                    <span class="unit-display">%</span>
                                    <button class="stepper-btn" data-target="RH" data-step="1"
                                        data-action="inc">+</button>
                                    <button class="stepper-btn" data-target="RH" data-step="1"
                                        data-action="dec">-</button>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- é¡å¤–å·¥ç¨‹åƒæ•¸ -->
                    <h3 class="text-lg font-semibold text-slate-700 mb-4 mt-6 border-b pb-2">é¡å¤–å·¥ç¨‹åƒæ•¸ (è¨ˆç®—ç”¨)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6">

                        <div>
                            <label for="steel_type" class="input-label block mb-1">é åŠ›é‹¼è…±ç¨®é¡</label>
                            <div class="input-group">
                                <select id="steel_type" class="input-field w-full bg-white">
                                    <option value="12.7">SWPR7BL 12.7mm</option>
                                    <option value="15.2">SWPR7BL 15.2mm</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label for="Ap" class="input-label block mb-1">é‹¼è…±æ–·é¢ç© (Ap)</label>
                            <div class="input-group">
                                <input type="number" id="Ap" value="0.9875" class="input-field bg-slate-50" readonly>
                                <span class="unit-display">cmÂ²</span>
                            </div>
                        </div>

                        <div>
                            <label for="num_ducts" class="input-label block mb-1">ä½ˆå­”æ•¸</label>
                            <div class="input-group">
                                <select id="num_ducts" class="input-field w-full bg-white">
                                    <option value="12" selected>12å­”</option>
                                    <option value="15">15å­”</option>
                                    <option value="19">19å­”</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label for="num_strands" class="input-label block mb-1">é‹¼è…±è‚¡æ•¸</label>
                            <div class="input-group">
                                <div class="input-container">
                                    <input type="number" id="num_strands" value="10" step="1" class="input-field">
                                    <span class="unit-display">è‚¡</span>
                                    <button class="stepper-btn" data-target="num_strands" data-step="1"
                                        data-action="inc">+</button>
                                    <button class="stepper-btn" data-target="num_strands" data-step="1"
                                        data-action="dec">-</button>
                                </div>
                            </div>
                        </div>

                        <div class="md:col-span-2">
                            <label for="total_Ap_display" class="input-label block mb-1">é‹¼è…±ç¸½æ–·é¢ç© (Total Ap)</label>
                            <div class="input-group">
                                <input type="number" id="total_Ap_display" value="0.0" class="input-field bg-slate-100"
                                    readonly>
                                <span class="unit-display">cmÂ²</span>
                            </div>
                        </div>

                        <!-- GEOMETRY FIELDS -->
                        <div>
                            <label for="Anet" class="input-label block mb-1">æ©‹æ¢ä¸­å¤®æ·¨æ–·é¢ç© (Anet)</label>
                            <div class="input-group">
                                <div class="input-container">
                                    <input type="number" id="Anet" value="39690.99" step="100" class="input-field">
                                    <span class="unit-display">cmÂ²</span>
                                    <button class="stepper-btn" data-target="Anet" data-step="100"
                                        data-action="inc">+</button>
                                    <button class="stepper-btn" data-target="Anet" data-step="100"
                                        data-action="dec">-</button>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="Inet" class="input-label block mb-1">æ©‹æ¢ä¸­å¤®æ·¨æ–·æ…£æ€§çŸ© (Inet)</label>
                            <div class="input-group">
                                <div class="input-container">
                                    <input type="number" id="Inet" value="19285477.94" step="10000" class="input-field">
                                    <span class="unit-display">cmâ´</span>
                                    <button class="stepper-btn" data-target="Inet" data-step="10000"
                                        data-action="inc">+</button>
                                    <button class="stepper-btn" data-target="Inet" data-step="10000"
                                        data-action="dec">-</button>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="MDL" class="input-label block mb-1">æ©‹æ¢éœè¼‰é‡å½çŸ© (MDL)</label>
                            <div class="input-group">
                                <div class="input-container">
                                    <input type="number" id="MDL" value="248.71" step="10" class="input-field">
                                    <span class="unit-display">tf*m</span>
                                    <button class="stepper-btn" data-target="MDL" data-step="10"
                                        data-action="inc">+</button>
                                    <button class="stepper-btn" data-target="MDL" data-step="10"
                                        data-action="dec">-</button>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="MADL" class="input-label block mb-1">æ©‹æ¢é™„æ›è¼‰é‡å½çŸ© (MADL)</label>
                            <div class="input-group">
                                <div class="input-container">
                                    <input type="number" id="MADL" value="62.89" step="10" class="input-field">
                                    <span class="unit-display">tf*m</span>
                                    <button class="stepper-btn" data-target="MADL" data-step="10"
                                        data-action="inc">+</button>
                                    <button class="stepper-btn" data-target="MADL" data-step="10"
                                        data-action="dec">-</button>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="Ycg" class="input-label block mb-1">é‡å¿ƒä½ç½®_è·é ‚éƒ¨ (Ycg)</label>
                            <div class="input-group">
                                <div class="input-container">
                                    <input type="number" id="Ycg" value="32.28" step="0.1" class="input-field">
                                    <span class="unit-display">cm</span>
                                    <button class="stepper-btn" data-target="Ycg" data-step="0.1"
                                        data-action="inc">+</button>
                                    <button class="stepper-btn" data-target="Ycg" data-step="0.1"
                                        data-action="dec">-</button>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="Ha" class="input-label block mb-1">éŒ¨å›ºé»è‡³æ¢é ‚éƒ¨å‚ç›´è·é›¢ (Ha)</label>
                            <div class="input-group">
                                <div class="input-container">
                                    <input type="number" id="Ha" value="55" step="1" class="input-field">
                                    <span class="unit-display">cm</span>
                                    <button class="stepper-btn" data-target="Ha" data-step="1"
                                        data-action="inc">+</button>
                                    <button class="stepper-btn" data-target="Ha" data-step="1"
                                        data-action="dec">-</button>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="ep_display" class="input-label block mb-1">é‹¼è…±èˆ‡æ¢é‡å¿ƒåå¿ƒå€¼ (ep)</label>
                            <div class="input-group">
                                <input type="number" id="ep_display" value="0.0" class="input-field bg-slate-100"
                                    readonly>
                                <span class="unit-display">cm</span>
                            </div>
                            <p class="suggestion-text pl-0 md:pl-0 text-left">ep = Ha - Ycg</p>
                        </div>
                        <!-- END GEOMETRY FIELDS -->


                        <div>
                            <label for="fpu" class="input-label block mb-1">æŠ—æ‹‰å¼·åº¦ (fpu)</label>
                            <div class="input-group">
                                <input type="number" id="fpu" value="18861" class="input-field bg-slate-50" readonly>
                                <span class="unit-display">kgf/cmÂ²</span>
                            </div>
                        </div>

                        <div>
                            <label for="fpy" class="input-label block mb-1">é™ä¼å¼·åº¦ (fpy)</label>
                            <div class="input-group">
                                <input type="number" id="fpy" value="16110" class="input-field bg-slate-50" readonly>
                                <span class="unit-display">kgf/cmÂ²</span>
                            </div>
                        </div>

                        <div>
                            <label for="Es" class="input-label block mb-1">é‹¼ææ¥Šæ°ä¿‚æ•¸ (Es)</label>
                            <div class="input-group">
                                <input type="number" id="Es" value="2080000" class="input-field bg-slate-50" readonly>
                                <span class="unit-display">kgf/cmÂ²</span>
                            </div>
                        </div>

                        <div>
                            <label for="Ec" class="input-label block mb-1">æ··å‡åœŸå½ˆæ€§æ¨¡æ•¸ (Ec)</label>
                            <div class="input-group">
                                <div class="input-container">
                                    <input type="number" id="Ec" value="280000" step="1000" class="input-field">
                                    <span class="unit-display">kgf/cmÂ²</span>
                                    <button class="stepper-btn" data-target="Ec" data-step="1000"
                                        data-action="inc">+</button>
                                    <button class="stepper-btn" data-target="Ec" data-step="1000"
                                        data-action="dec">-</button>
                                </div>
                            </div>
                        </div>

                        <div class="md:col-span-2">
                            <label for="sigma_j" class="input-label block mb-1">åˆå§‹æ–½é åŠ› (fpj / Ïƒj)</label>
                            <div class="input-group">
                                <div class="input-container">
                                    <input type="number" id="sigma_j" value="13903" step="10" class="input-field">
                                    <span class="unit-display">kgf/cmÂ²</span>
                                    <button class="stepper-btn" data-target="sigma_j" data-step="10"
                                        data-action="inc">+</button>
                                    <button class="stepper-btn" data-target="sigma_j" data-step="10"
                                        data-action="dec">-</button>
                                </div>
                            </div>
                            <p class="suggestion-text pl-0 md:pl-0 text-left">é è¨­å€¼: 0.737 * fpu</p>
                        </div>

                    </div>
                </div>

                <!-- ====== è¨ˆç®—çµæœæ¬„ (Tabbed) ====== -->
                <div class="space-y-8">
                    <!-- Tab Buttons -->
                    <div class="flex items-center">
                        <button id="btn-results-tab" class="tab-btn active">è¨ˆç®—çµæœ</button>
                        <button id="btn-details-tab" class="tab-btn">é åŠ›æå¤±è¨ˆç®—</button>
                        <!-- Enhanced PDF Export Button -->
                        <button id="btn-export-pdf"
                            class="ml-auto bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-md shadow flex items-center gap-2 text-sm font-medium transition-colors">
                            <span>ğŸ“„</span> è¼¸å‡º PDF è¨ˆç®—æ›¸
                        </button>
                    </div>

                    <!-- Tab Panel 1: è¨ˆç®—çµæœ (Results Summary) -->
                    <div id="results-tab" class="tab-panel space-y-8 pt-8">

                        <!-- Designer Input -->
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                            <label for="designer_name" class="input-label block mb-1 font-semibold text-slate-700">è¨ˆç®—äººå“¡
                                (Designer)</label>
                            <input type="text" id="designer_name" class="input-field w-full"
                                placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å (Name)">
                        </div>

                        <!-- æ–½å·¥éšæ®µé åŠ›æå¤± -->
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                            <h2 class="text-xl font-semibold text-slate-700 mb-4">æ–½å·¥éšæ®µé åŠ›æå¤± (Î”Ïƒ_Stage)</h2>
                            <div class="overflow-x-auto">
                                <table class="result-table">
                                    <thead>
                                        <tr>
                                            <th>æå¤±é …ç›®</th>
                                            <th>æå¤±æ‡‰åŠ› (kgf/cmÂ²)</th>
                                            <th>æå¤±ç™¾åˆ†æ¯” (%)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="stage-results-body">
                                        <tr>
                                            <td>æ‘©æ“¦æå¤± (Friction)</td>
                                            <td id="loss_friction">0.00</td>
                                            <td id="perc_friction">0.0%</td>
                                        </tr>
                                        <tr>
                                            <td>æ»‘å‹•æå¤± (Anchorage Set)</td>
                                            <td id="loss_anchorage">0.00</td>
                                            <td id="perc_anchorage">0.0%</td>
                                        </tr>
                                        <tr>
                                            <td>å½ˆæ€§ç¸®çŸ­æå¤± (Elastic Shortening)</td>
                                            <td id="loss_elastic">0.00</td>
                                            <td id="perc_elastic">0.0%</td>
                                        </tr>
                                    </tbody>
                                    <tfoot>
                                        <tr class="total-row">
                                            <td>æ–½å·¥éšæ®µç¸½æå¤±</td>
                                            <td id="loss_stage_total">0.00</td>
                                            <td id="perc_stage_total">0.0%</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                        <!-- é•·æœŸé åŠ›æå¤± -->
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                            <h2 class="text-xl font-semibold text-slate-700 mb-4">é•·æœŸé åŠ›æå¤± (Î”Ïƒ_LongTerm)</h2>
                            <div class="overflow-x-auto">
                                <table class="result-table">
                                    <thead>
                                        <tr>
                                            <th>æå¤±é …ç›®</th>
                                            <th>æå¤±æ‡‰åŠ› (kgf/cmÂ²)</th>
                                            <th>æå¤±ç™¾åˆ†æ¯” (%)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="longterm-results-body">
                                        <tr>
                                            <td>ä¹¾ç¸®æå¤± (Shrinkage)</td>
                                            <td id="loss_shrinkage">0.00</td>
                                            <td id="perc_shrinkage">0.0%</td>
                                        </tr>
                                        <tr>
                                            <td>æ½›è®Šæå¤± (Creep)</td>
                                            <td id="loss_creep">0.00</td>
                                            <td id="perc_creep">0.0%</td>
                                        </tr>
                                        <tr>
                                            <td>é¬†å¼›æå¤± (Relaxation)</td>
                                            <td id="loss_relaxation">0.00</td>
                                            <td id="perc_relaxation">0.0%</td>
                                        </tr>
                                    </tbody>
                                    <tfoot>
                                        <tr class="total-row">
                                            <td>é•·æœŸç¸½æå¤±</td>
                                            <td id="loss_longterm_total">0.00</td>
                                            <td id="perc_longterm_total">0.0%</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                        <!-- ç¸½é åŠ›æå¤± -->
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                            <h2 class="text-xl font-semibold text-slate-700 mb-4">ç¸½é åŠ›æå¤± (Î”Ïƒ_Total)</h2>
                            <div class="overflow-x-auto">
                                <table class="result-table">
                                    <tbody id="total-results-body">
                                        <tr class="total-row">
                                            <td class="w-1/3">ç¸½æå¤±</td>
                                            <td class="w-1/3" id="loss_total">0.00</td>
                                            <td class="w-1/3" id="perc_total">0.0%</td>
                                        </tr>
                                        <tr>
                                            <td>åˆå§‹æ–½é åŠ› (Ïƒj)</td>
                                            <td id="val_sigma_j">0.00</td>
                                            <td>100.0%</td>
                                        </tr>
                                        <tr>
                                            <td>æœ‰æ•ˆé åŠ› (Ïƒe)</td>
                                            <td id="val_sigma_e">0.00</td>
                                            <td id="perc_sigma_e">0.0%</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- è¦–è¦ºåŒ–åœ–è¡¨ -->
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                            <h2 class="text-xl font-semibold text-slate-700 mb-4">æå¤±åˆ†ä½ˆåœ–</h2>
                            <div class="chart-container"
                                style="position: relative; height:40vh; max-height: 400px; width:100%; max-width: 600px; margin: auto;">
                                <canvas id="lossChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Panel 2: é åŠ›æå¤±è¨ˆç®— (Calculation Details) -->
                    <div id="details-tab" class="tab-panel hidden pt-8">
                        <!-- This div is now flex-col, forcing single-column layout -->
                        <div class="flex flex-col gap-6">

                            <!-- 1. æ‘©æ“¦æå¤± -->
                            <div class="bg-white p-5 rounded-lg shadow-sm border border-slate-200">
                                <h3 class="text-lg font-semibold text-slate-700">1. æ‘©æ“¦æå¤± (Friction)</h3>
                                <div class="formula-display">
                                    Î± = arctan(2*H / B)
                                    S = L / 2 (m)
                                    T_center = Ïƒ_j / exp(k*S + Î¼*Î±)
                                    Î”Ïƒ_F = Ïƒ_j - T_center
                                </div>
                                <ul class="variable-list text-sm">
                                    <li><span>Ïƒ_j (åˆå§‹æ–½é åŠ›)</span><span
                                            id="detail_f_sigma_j">0.00</span><span>kgf/cmÂ²</span>
                                    </li>
                                    <li><span>L (æ©‹æ¢è·¨åº¦)</span><span id="detail_f_L">0.00</span><span>cm</span></li>
                                    <li><span>H (å‚ç›´è·é›¢)</span><span id="detail_f_H">0.00</span><span>cm</span></li>
                                    <li><span>B (æ°´å¹³è·é›¢)</span><span id="detail_f_B">0.00</span><span>cm</span></li>
                                    <li><span>k (æ³¢æµªæ•ˆæ‡‰)</span><span id="detail_f_k">0.00</span><span>1/m</span></li>
                                    <li><span>Î¼ (æ›²ç‡æ•ˆæ‡‰)</span><span id="detail_f_mu">0.00</span><span>1/rad</span></li>
                                    <li><span>Î± (ç¸±å‘ç¸½è§’åº¦)</span><span id="detail_f_alpha">0.0000</span><span>rad</span>
                                    </li>
                                </ul>
                                <div class="calculation-step">
                                    <div id="detail_f_calc_alpha">Î± = arctan(2 * 0 / 0) = 0 rad</div>
                                    <div id="detail_f_calc_S_m">S = 0cm / 2 = 0 m</div>
                                    <div id="detail_f_calc_Tcenter">T_center = 0 / exp(0*0 + 0*0) = 0 kgf/cmÂ²</div>
                                    <div id="detail_f_calc_loss">Î”Ïƒ_F = 0 - 0</div>
                                </div>
                                <div class="final-loss-result">
                                    <span>æ‘©æ“¦æå¤±:</span>
                                    <span id="detail_f_result">= 0.00 kgf/cmÂ²</span>
                                </div>
                            </div>

                            <!-- 2. æ»‘å‹•æå¤± -->
                            <div class="bg-white p-5 rounded-lg shadow-sm border border-slate-200">
                                <h3 class="text-lg font-semibold text-slate-700">2. æ»‘å‹•æå¤± (Anchorage Set)</h3>
                                <div class="formula-display">
                                    m_slide = (k/100) + 2*Î¼*H/(B^2)
                                    exp_term = exp(-m_slide * L / 2)
                                    Term1 = (m_slide * Es * Î”a_cm) / (1 - exp_term)
                                    Term2 = Ïƒ_j * (1 - exp_term)
                                    Î”Ïƒ_A = Term1 - Term2
                                </div>
                                <ul class="variable-list text-sm">
                                    <li><span>k (æ³¢æµªæ•ˆæ‡‰)</span><span id="detail_a_k">0.00</span><span>1/m</span></li>
                                    <li><span>Î¼ (æ›²ç‡æ•ˆæ‡‰)</span><span id="detail_a_mu">0.00</span><span>1/rad</span></li>
                                    <li><span>H (å‚ç›´è·é›¢)</span><span id="detail_a_H">0.00</span><span>cm</span></li>
                                    <li><span>B (æ°´å¹³è·é›¢)</span><span id="detail_a_B">0.00</span><span>cm</span></li>
                                    <li><span>L (æ©‹æ¢è·¨åº¦)</span><span id="detail_a_L">0.00</span><span>cm</span></li>
                                    <li><span>Es (é‹¼ææ¨¡æ•¸)</span><span id="detail_a_Es">0</span><span>kgf/cmÂ²</span></li>
                                    <li><span>Î”a (æ»‘å‹•é‡)</span><span id="detail_a_delta_a">0.00</span><span>mm</span></li>
                                    <li><span>Ïƒ_j (åˆå§‹æ–½é åŠ›)</span><span
                                            id="detail_a_sigma_j">0.00</span><span>kgf/cmÂ²</span>
                                    </li>
                                </ul>
                                <div class="calculation-step">
                                    <div id="detail_a_calc_m">m_slide = (0/100) + 2*0*0/(0^2) = 0</div>
                                    <div id="detail_a_calc_exp">exp_term = exp(-0 * 0 / 2) = 0</div>
                                    <div id="detail_a_calc_t1">Term1 = (0 * 0 * 0) / (1 - 0) = 0</div>
                                    <div id="detail_a_calc_t2">Term2 = 0 * (1 - 0) = 0</div>
                                    <div id="detail_a_calc_loss">Î”Ïƒ_A = 0 - 0</div>
                                </div>
                                <div class="final-loss-result">
                                    <span>æ»‘å‹•æå¤±:</span>
                                    <span id="detail_a_result">= 0.00 kgf/cmÂ²</span>
                                </div>
                            </div>

                            <!-- 3. å½ˆæ€§ç¸®çŸ­æå¤± -->
                            <div class="bg-white p-5 rounded-lg shadow-sm border border-slate-200">
                                <h3 class="text-lg font-semibold text-slate-700">3. å½ˆæ€§ç¸®çŸ­ (Elastic Shortening)</h3>
                                <div class="formula-display">
                                    n = Es / Ec
                                    a = Total_Ap / Anet
                                    b = (Total_Ap * ep^2) / Inet
                                    c = (MDL * 10^5 * ep) / Inet
                                    d = Ïƒ_j - Î”Ïƒ_F - Î”Ïƒ_A
                                    Ïƒx = (d + 0.5*n*c) / (1 + 0.5*n*(a+b))
                                    Î”Ïƒ_ES = 0.5*n*(a*Ïƒx + b*Ïƒx - c)
                                </div>
                                <ul class="variable-list text-sm">
                                    <li><span>n (æ¨¡æ•¸æ¯”)</span><span id="detail_e_n">0.00</span><span></span></li>
                                    <li><span>Total_Ap (é‹¼è…±ç¸½é¢ç©)</span><span
                                            id="detail_e_Total_Ap">0.00</span><span>cmÂ²</span></li>
                                    <li><span>Anet (æ·¨æ–·é¢ç©)</span><span id="detail_e_Anet">0.00</span><span>cmÂ²</span>
                                    </li>
                                    <li><span>Inet (æ·¨æ–·æ…£æ€§çŸ©)</span><span id="detail_e_Inet">0.00</span><span>cmâ´</span>
                                    </li>
                                    <li><span>ep (åå¿ƒå€¼)</span><span id="detail_e_ep">0.00</span><span>cm</span></li>
                                    <li><span>MDL (éœè¼‰å½çŸ©)</span><span id="detail_e_MDL">0.00</span><span>tf*m</span></li>
                                    <li><span>Ïƒ_j (åˆå§‹æ–½é åŠ›)</span><span
                                            id="detail_e_sigma_j">0.00</span><span>kgf/cmÂ²</span>
                                    </li>
                                    <li><span>Î”Ïƒ_F (æ‘©æ“¦æå¤±)</span><span
                                            id="detail_e_loss_f">0.00</span><span>kgf/cmÂ²</span>
                                    </li>
                                    <li><span>Î”Ïƒ_A (æ»‘å‹•æå¤±)</span><span
                                            id="detail_e_loss_a">0.00</span><span>kgf/cmÂ²</span>
                                    </li>
                                </ul>
                                <div class="calculation-step">
                                    <div id="detail_e_calc_a">a = 0 / 0 = 0</div>
                                    <div id="detail_e_calc_b">b = (0 * 0^2) / 0 = 0</div>
                                    <div id="detail_e_calc_c">c = (0 * 10^5 * 0) / 0 = 0</div>
                                    <div id="detail_e_calc_d">d = 0 - 0 - 0 = 0</div>
                                    <div id="detail_e_calc_sx">Ïƒx = (0 + 0.5*0*0) / (1 + 0.5*0*(0+0)) = 0</div>
                                    <div id="detail_e_calc_loss">Î”Ïƒ_ES = 0.5*0*(0*0 + 0*0 - 0) = 0</div>
                                </div>
                                <div class="final-loss-result">
                                    <span>å½ˆæ€§ç¸®çŸ­æå¤±:</span>
                                    <span id="detail_e_result">= 0.00 kgf/cmÂ²</span>
                                </div>
                            </div>

                            <!-- 4. ä¹¾ç¸®æå¤± -->
                            <div class="bg-white p-5 rounded-lg shadow-sm border border-slate-200">
                                <h3 class="text-lg font-semibold text-slate-700">4. ä¹¾ç¸®æå¤± (Shrinkage)</h3>
                                <div class="formula-display">Î”Ïƒ_SH = 0.8 * (1195 - 10.55 * RH)</div>
                                <ul class="variable-list text-sm">
                                    <li><span>RH (å¹´å¹³å‡æ¿•åº¦)</span><span id="detail_sh_RH">0.0</span><span>%</span></li>
                                </ul>
                                <div class="calculation-step">
                                    <div id="detail_sh_calc">= 0.8 * (1195 - 10.55 * 0)</div>
                                </div>
                                <div class="final-loss-result">
                                    <span>ä¹¾ç¸®æå¤±:</span>
                                    <span id="detail_sh_result">= 0.00 kgf/cmÂ²</span>
                                </div>
                            </div>

                            <!-- 5. æ½›è®Šæå¤± -->
                            <div class="bg-white p-5 rounded-lg shadow-sm border border-slate-200">
                                <h3 class="text-lg font-semibold text-slate-700">5. æ½›è®Šæå¤± (Creep)</h3>
                                <div class="formula-display">
                                    e = (MADL * 10^5 * ep) / Inet
                                    f = (Î”Ïƒ_ES * 2) / n
                                    Î”Ïƒ_CR = 12*f - 7*e
                                </div>
                                <ul class="variable-list text-sm">
                                    <li><span>MADL (é™„æ›å½çŸ©)</span><span id="detail_c_MADL">0.00</span><span>tf*m</span>
                                    </li>
                                    <li><span>ep (åå¿ƒå€¼)</span><span id="detail_c_ep">0.00</span><span>cm</span></li>
                                    <li><span>Inet (æ·¨æ–·æ…£æ€§çŸ©)</span><span id="detail_c_Inet">0.00</span><span>cmâ´</span>
                                    </li>
                                    <li><span>Î”Ïƒ_ES (å½ˆç¸®æå¤±)</span><span
                                            id="detail_c_loss_elastic">0.00</span><span>kgf/cmÂ²</span></li>
                                    <li><span>n (æ¨¡æ•¸æ¯”)</span><span id="detail_c_n">0.00</span><span></span></li>
                                </ul>
                                <div class="calculation-step">
                                    <div id="detail_c_calc_e">e = (0 * 10^5 * 0) / 0 = 0</div>
                                    <div id="detail_c_calc_f">f = (0 * 2) / 0 = 0</div>
                                    <div id="detail_c_calc_loss">Î”Ïƒ_CR = 12 * 0 - 7 * 0 = 0</div>
                                </div>
                                <div class="final-loss-result">
                                    <span>æ½›è®Šæå¤±:</span>
                                    <span id="detail_c_result">= 0.00 kgf/cmÂ²</span>
                                </div>
                            </div>

                            <!-- 6. é¬†å¼›æå¤± -->
                            <div class="bg-white p-5 rounded-lg shadow-sm border border-slate-200">
                                <h3 class="text-lg font-semibold text-slate-700">6. é¬†å¼›æå¤± (Relaxation)</h3>
                                <div class="formula-display">
                                    FR = max(0, 0.7*fpu - T_center)
                                    Î”Ïƒ_R = 350 - 0.07*FR - 0.1*Î”Ïƒ_ES - 0.05*(Î”Ïƒ_SH + Î”Ïƒ_CR)
                                </div>
                                <ul class="variable-list text-sm">
                                    <li><span>fpu (æŠ—æ‹‰å¼·åº¦)</span><span id="detail_r_fpu">0.00</span><span>kgf/cmÂ²</span>
                                    </li>
                                    <li><span>T_center (ä¸­å¤®é»æ‡‰åŠ›)</span><span
                                            id="detail_r_tcenter">0.00</span><span>kgf/cmÂ²</span></li>
                                    <li><span>Î”Ïƒ_ES (å½ˆç¸®æå¤±)</span><span
                                            id="detail_r_loss_es">0.00</span><span>kgf/cmÂ²</span>
                                    </li>
                                    <li><span>Î”Ïƒ_SH (ä¹¾ç¸®æå¤±)</span><span
                                            id="detail_r_loss_sh">0.00</span><span>kgf/cmÂ²</span>
                                    </li>
                                    <li><span>Î”Ïƒ_CR (æ½›è®Šæå¤±)</span><span
                                            id="detail_r_loss_cr">0.00</span><span>kgf/cmÂ²</span>
                                    </li>
                                </ul>
                                <div class="calculation-step">
                                    <div id="detail_r_calc_fr">FR = max(0, 0.7*0 - 0) = 0</div>
                                    <div id="detail_r_calc_loss">Î”Ïƒ_R = 350 - 0.07*0 - 0.1*0 - 0.05*(0 + 0) = 0</div>
                                </div>
                                <div class="final-loss-result">
                                    <span>é¬†å¼›æå¤±:</span>
                                    <span id="detail_r_result">= 0.00 kgf/cmÂ²</span>
                                </div>
                            </div>

                        </div>
                    </div>

                </div>
            </div>
        </div>


    </div> <!-- Close screen-ui -->

    <!-- ====== PRINT UI STRUCTURE (Hidden on Screen) ====== -->
    <div class="print-ui">
        <div class="print-page">
            <header class="print-header">
                <h1>é åŠ›æå¤±è¨ˆç®—æ›¸</h1>
                <h2>Prestressed Loss Calculation Report</h2>
            </header>

            <div class="print-section">
                <div class="print-kv-grid">
                    <div class="print-kv-item"><span class="print-kv-label">åˆ—å°æ—¥æœŸ:</span><span class="print-kv-value"
                            id="p_date">--</span></div>
                    <div class="print-kv-item"><span class="print-kv-label">è¨ˆç®—äººå“¡:</span><span class="print-kv-value"
                            id="p_designer_name">--</span></div>
                </div>
            </div>

            <!-- 1. Input Parameters -->
            <div class="print-section">
                <h3 class="print-section-title">1. è¨­è¨ˆåƒæ•¸ (Design Parameters)</h3>
                <div class="print-kv-grid">
                    <div class="print-kv-item"><span class="print-kv-label">è·¨åº¦ (L):</span><span class="print-kv-value"
                            id="p_L">--</span> cm</div>
                    <div class="print-kv-item"><span class="print-kv-label">æ°´å¹³è·é›¢ (B):</span><span class="print-kv-value"
                            id="p_B">--</span> cm</div>
                    <div class="print-kv-item"><span class="print-kv-label">å‚ç›´è·é›¢ (H):</span><span class="print-kv-value"
                            id="p_H">--</span> cm</div>
                    <div class="print-kv-item"><span class="print-kv-label">æ‘©æ“¦ä¿‚æ•¸ (Î¼):</span><span class="print-kv-value"
                            id="p_mu">--</span> 1/rad</div>
                    <div class="print-kv-item"><span class="print-kv-label">æ³¢æµªæ‘©æ“¦ä¿‚æ•¸ (k):</span><span
                            class="print-kv-value" id="p_k">--</span> 1/m</div>
                    <div class="print-kv-item"><span class="print-kv-label">éŒ¨å…·æ»‘å‹• (Î”a):</span><span
                            class="print-kv-value" id="p_delta_a">--</span> mm</div>
                    <div class="print-kv-item"><span class="print-kv-label">æ¿•åº¦ (RH):</span><span class="print-kv-value"
                            id="p_RH">--</span> %</div>
                    <div class="print-kv-item"><span class="print-kv-label">åˆå§‹é åŠ› (Ïƒj):</span><span
                            class="print-kv-value" id="p_sigma_j">--</span> kgf/cmÂ²</div>
                    <div class="print-kv-item"><span class="print-kv-label">é åŠ›é‹¼è…±:</span><span class="print-kv-value"
                            id="p_steel_type">--</span></div>
                    <div class="print-kv-item"><span class="print-kv-label">ä½ˆå­”æ•¸:</span><span class="print-kv-value"
                            id="p_num_ducts">--</span> å­”</div>
                    <div class="print-kv-item"><span class="print-kv-label">é‹¼è…±è‚¡æ•¸:</span><span class="print-kv-value"
                            id="p_num_strands">--</span> è‚¡</div>
                    <div class="print-kv-item"><span class="print-kv-label">ç¸½æ–·é¢ç© (Ap):</span><span
                            class="print-kv-value" id="p_total_ap">--</span> cmÂ²</div>
                    <div class="print-kv-item"><span class="print-kv-label">æŠ—æ‹‰å¼·åº¦ (fpu):</span><span
                            class="print-kv-value" id="p_fpu">--</span> kgf/cmÂ²</div>
                    <div class="print-kv-item"><span class="print-kv-label">é™ä¼å¼·åº¦ (fpy):</span><span
                            class="print-kv-value" id="p_fpy">--</span> kgf/cmÂ²</div>
                    <div class="print-kv-item"><span class="print-kv-label">é‹¼ææ¨¡æ•¸ (Es):</span><span
                            class="print-kv-value" id="p_Es">--</span> kgf/cmÂ²</div>
                    <div class="print-kv-item"><span class="print-kv-label">æ··å‡åœŸæ¨¡æ•¸ (Ec):</span><span
                            class="print-kv-value" id="p_Ec">--</span> kgf/cmÂ²</div>
                    <div class="print-kv-item"><span class="print-kv-label">æ·¨æ–·é¢ç© (Anet):</span><span
                            class="print-kv-value" id="p_Anet">--</span> cmÂ²</div>
                    <div class="print-kv-item"><span class="print-kv-label">æ·¨æ–·æ…£æ€§çŸ© (Inet):</span><span
                            class="print-kv-value" id="p_Inet">--</span> cmâ´</div>
                    <div class="print-kv-item"><span class="print-kv-label">é‡å¿ƒåå¿ƒå€¼ (ep):</span><span
                            class="print-kv-value" id="p_ep">--</span> cm</div>
                    <div class="print-kv-item"><span class="print-kv-label">éœè¼‰å½çŸ© (MDL):</span><span
                            class="print-kv-value" id="p_MDL">--</span> tf-m</div>
                    <div class="print-kv-item"><span class="print-kv-label">é™„æ›å½çŸ© (MADL):</span><span
                            class="print-kv-value" id="p_MADL">--</span> tf-m</div>
                </div>
            </div>

            <!-- 2. Result Summary -->
            <div class="print-section">
                <h3 class="print-section-title">2. è¨ˆç®—çµæœæ‘˜è¦ (Summary)</h3>
                <table class="print-table">
                    <thead>
                        <tr>
                            <th>æå¤±é …ç›® (Loss Item)</th>
                            <th>æ‡‰åŠ›æå¤± (kgf/cmÂ²)</th>
                            <th>ç™¾åˆ†æ¯” (%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>æ‘©æ“¦æå¤± (Friction)</td>
                            <td class="num" id="p_loss_friction">0.00</td>
                            <td class="num" id="p_perc_friction">0.0%</td>
                        </tr>
                        <tr>
                            <td>æ»‘å‹•æå¤± (Anchorage)</td>
                            <td class="num" id="p_loss_anchorage">0.00</td>
                            <td class="num" id="p_perc_anchorage">0.0%</td>
                        </tr>
                        <tr>
                            <td>å½ˆæ€§ç¸®çŸ­ (Elastic)</td>
                            <td class="num" id="p_loss_elastic">0.00</td>
                            <td class="num" id="p_perc_elastic">0.0%</td>
                        </tr>
                        <tr style="background:#eee; font-weight:bold;">
                            <td>æ–½å·¥éšæ®µå°è¨ˆ</td>
                            <td class="num" id="p_loss_stage">0.00</td>
                            <td class="num" id="p_perc_stage">0.0%</td>
                        </tr>
                        <tr>
                            <td colspan="3" style="border:none; height:5px;"></td>
                        </tr>
                        <tr>
                            <td>ä¹¾ç¸®æå¤± (Shrinkage)</td>
                            <td class="num" id="p_loss_shrinkage">0.00</td>
                            <td class="num" id="p_perc_shrinkage">0.0%</td>
                        </tr>
                        <tr>
                            <td>æ½›è®Šæå¤± (Creep)</td>
                            <td class="num" id="p_loss_creep">0.00</td>
                            <td class="num" id="p_perc_creep">0.0%</td>
                        </tr>
                        <tr>
                            <td>é¬†å¼›æå¤± (Relaxation)</td>
                            <td class="num" id="p_loss_relaxation">0.00</td>
                            <td class="num" id="p_perc_relaxation">0.0%</td>
                        </tr>
                        <tr style="background:#eee; font-weight:bold;">
                            <td>é•·æœŸæå¤±å°è¨ˆ</td>
                            <td class="num" id="p_loss_longterm">0.00</td>
                            <td class="num" id="p_perc_longterm">0.0%</td>
                        </tr>
                        <tr>
                            <td colspan="3" style="border:none; height:10px;"></td>
                        </tr>
                        <tr style="font-size:12pt; border:2px solid black;">
                            <td><strong>ç¸½æå¤± (Total Loss)</strong></td>
                            <td class="num"><strong><span id="p_loss_total">0.00</span></strong></td>
                            <td class="num"><strong><span id="p_perc_total">0.0%</span></strong></td>
                        </tr>
                        <tr>
                            <td>æœ‰æ•ˆé åŠ› (Effective Ïƒe)</td>
                            <td class="num" id="p_sigma_e">0.00</td>
                            <td class="num" id="p_perc_sigma_e">0.0%</td>
                        </tr>
                    </tbody>
                </table>
            </div>



            <div class="print-footer">
                <span>Generated by Prestress Loss Calculator</span>
                <span>Page 1/2</span>
            </div>
        </div>

        <div class="print-page">
            <header class="print-header">
                <h2>è©³ç´°è¨ˆç®—éç¨‹ (Detailed Calculations)</h2>
            </header>

            <div class="print-section">
                <!-- 1. Friction -->
                <div class="print-calc-block">
                    <div class="print-formula">1. æ‘©æ“¦æå¤± (Friction)</div>
                    <ul class="print-variable-list">
                        <li><span>Ïƒj:</span><span id="p_detail_f_sigma_j">--</span></li>
                        <li><span>L:</span><span id="p_detail_f_L">--</span></li>
                        <li><span>H:</span><span id="p_detail_f_H">--</span></li>
                        <li><span>B:</span><span id="p_detail_f_B">--</span></li>
                        <li><span>k:</span><span id="p_detail_f_k">--</span></li>
                        <li><span>Î¼:</span><span id="p_detail_f_mu">--</span></li>
                        <li><span>Î±:</span><span id="p_detail_f_alpha">--</span></li>
                    </ul>
                    <div class="print-sub" id="p_detail_f_calc_alpha">--</div>
                    <div class="print-sub" id="p_detail_f_calc_S_m">--</div>
                    <div class="print-sub" id="p_detail_f_calc_Tcenter">--</div>
                    <div class="print-sub" id="p_detail_f_calc_loss">--</div>
                    <div class="print-sub" id="p_detail_f_result">--</div>
                </div>

                <!-- 2. Anchorage -->
                <div class="print-calc-block">
                    <div class="print-formula">2. æ»‘å‹•æå¤± (Anchorage Set)</div>
                    <ul class="print-variable-list">
                        <li><span>k:</span><span id="p_detail_a_k">--</span></li>
                        <li><span>Î¼:</span><span id="p_detail_a_mu">--</span></li>
                        <li><span>H:</span><span id="p_detail_a_H">--</span></li>
                        <li><span>B:</span><span id="p_detail_a_B">--</span></li>
                        <li><span>L:</span><span id="p_detail_a_L">--</span></li>
                        <li><span>Es:</span><span id="p_detail_a_Es">--</span></li>
                        <li><span>Î”a:</span><span id="p_detail_a_delta_a">--</span></li>
                        <li><span>Ïƒj:</span><span id="p_detail_a_sigma_j">--</span></li>
                    </ul>
                    <div class="print-sub" id="p_detail_a_calc_m">--</div>
                    <div class="print-sub" id="p_detail_a_calc_exp">--</div>
                    <div class="print-sub" id="p_detail_a_calc_t1">--</div>
                    <div class="print-sub" id="p_detail_a_calc_t2">--</div>
                    <div class="print-sub" id="p_detail_a_calc_loss">--</div>
                    <div class="print-sub" id="p_detail_a_result">--</div>
                </div>

                <!-- 3. Elastic -->
                <div class="print-calc-block">
                    <div class="print-formula">3. å½ˆæ€§ç¸®çŸ­ (Elastic Shortening)</div>
                    <ul class="print-variable-list">
                        <li><span>n:</span><span id="p_detail_e_n">--</span></li>
                        <li><span>Total Ap:</span><span id="p_detail_e_Total_Ap">--</span></li>
                        <li><span>Anet:</span><span id="p_detail_e_Anet">--</span></li>
                        <li><span>Inet:</span><span id="p_detail_e_Inet">--</span></li>
                        <li><span>ep:</span><span id="p_detail_e_ep">--</span></li>
                        <li><span>MDL:</span><span id="p_detail_e_MDL">--</span></li>
                        <li><span>Ïƒj:</span><span id="p_detail_e_sigma_j">--</span></li>
                        <li><span>Î”Ïƒ_F:</span><span id="p_detail_e_loss_f">--</span></li>
                        <li><span>Î”Ïƒ_A:</span><span id="p_detail_e_loss_a">--</span></li>
                    </ul>
                    <div class="print-sub" id="p_detail_e_calc_a">--</div>
                    <div class="print-sub" id="p_detail_e_calc_b">--</div>
                    <div class="print-sub" id="p_detail_e_calc_c">--</div>
                    <div class="print-sub" id="p_detail_e_calc_d">--</div>
                    <div class="print-sub" id="p_detail_e_calc_sx">--</div>
                    <div class="print-sub" id="p_detail_e_calc_loss">--</div>
                    <div class="print-sub" id="p_detail_e_result">--</div>
                </div>

                <!-- 4. Shrinkage -->
                <div class="print-calc-block">
                    <div class="print-formula">4. ä¹¾ç¸®æå¤± (Shrinkage)</div>
                    <ul class="print-variable-list">
                        <li><span>RH:</span><span id="p_detail_sh_RH">--</span></li>
                    </ul>
                    <div class="print-sub" id="p_detail_sh_calc">--</div>
                    <div class="print-sub" id="p_detail_sh_result">--</div>
                </div>

                <!-- 5. Creep -->
                <div class="print-calc-block">
                    <div class="print-formula">5. æ½›è®Šæå¤± (Creep)</div>
                    <ul class="print-variable-list">
                        <li><span>MADL:</span><span id="p_detail_c_MADL">--</span></li>
                        <li><span>ep:</span><span id="p_detail_c_ep">--</span></li>
                        <li><span>Inet:</span><span id="p_detail_c_Inet">--</span></li>
                        <li><span>Î”Ïƒ_ES:</span><span id="p_detail_c_loss_elastic">--</span></li>
                        <li><span>n:</span><span id="p_detail_c_n">--</span></li>
                    </ul>
                    <div class="print-sub" id="p_detail_c_calc_e">--</div>
                    <div class="print-sub" id="p_detail_c_calc_f">--</div>
                    <div class="print-sub" id="p_detail_c_calc_loss">--</div>
                    <div class="print-sub" id="p_detail_c_result">--</div>
                </div>

                <!-- 6. Relaxation -->
                <div class="print-calc-block">
                    <div class="print-formula">6. é¬†å¼›æå¤± (Relaxation)</div>
                    <ul class="print-variable-list">
                        <li><span>fpu:</span><span id="p_detail_r_fpu">--</span></li>
                        <li><span>T_center:</span><span id="p_detail_r_tcenter">--</span></li>
                        <li><span>Î”Ïƒ_ES:</span><span id="p_detail_r_loss_es">--</span></li>
                        <li><span>Î”Ïƒ_SH:</span><span id="p_detail_r_loss_sh">--</span></li>
                        <li><span>Î”Ïƒ_CR:</span><span id="p_detail_r_loss_cr">--</span></li>
                    </ul>
                    <div class="print-sub" id="p_detail_r_calc_fr">--</div>
                    <div class="print-sub" id="p_detail_r_calc_loss">--</div>
                    <div class="print-sub" id="p_detail_r_result">--</div>
                </div>
            </div>

            <div class="print-footer">
                <span>Generated by Prestress Loss Calculator</span>
                <span>Page 2/2</span>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const inputs = {};
            const steelTypes = {
                // 1 MPa = 10.19716 kgf/cm^2
                "12.7": { fpu_mpa: 1850, fpy_mpa: 1580, Ap: 0.9875 },
                "15.2": { fpu_mpa: 1880, fpy_mpa: 1600, Ap: 1.3867 }
            };
            // 2.04 * 10^5 MPa * 10.19716 = 2080220.64 kgf/cm^2 -> 2080000
            const Es_val = 2080000;

            const inputIds = [
                'L', 'B', 'H', 'mu', 'k', 'delta_a', 'RH',
                'Ap', 'Ec', 'sigma_j', 'fpu', 'fpy', 'Es', 'steel_type',
                'num_ducts', 'num_strands',
                'Anet', 'Inet', 'Ycg', 'Ha', 'MDL', 'MADL'
            ];

            inputIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) inputs[id] = el;
            });

            inputs.Es.value = Es_val;

            let lossChart;

            const btnResultsTab = document.getElementById('btn-results-tab');
            const btnDetailsTab = document.getElementById('btn-details-tab');
            const resultsTab = document.getElementById('results-tab');
            const detailsTab = document.getElementById('details-tab');

            function getValues() {
                const values = {};
                inputIds.forEach(id => {
                    const el = inputs[id];
                    if (el) {
                        if (el.type === 'number') {
                            values[id] = parseFloat(el.value) || 0;
                        } else {
                            values[id] = el.value;
                        }
                    }
                });

                // Convert units
                values.L_m = values.L / 100;
                values.B_m = values.B / 100;
                values.H_m = values.H / 100;
                values.delta_a_cm = values.delta_a / 10;
                values.MDL_kgf_cm = values.MDL * 1000 * 100; // tf*m to kgf*cm
                values.MADL_kgf_cm = values.MADL * 1000 * 100; // tf*m to kgf*cm

                return values;
            }

            function updateSteelParams() {
                const selectedType = inputs.steel_type.value;
                const steelData = steelTypes[selectedType];

                const fpu_kgf = Math.round(steelData.fpu_mpa * 10.19716);
                const fpy_kgf = Math.round(steelData.fpy_mpa * 10.19716);

                inputs.fpu.value = fpu_kgf;
                inputs.fpy.value = fpy_kgf;
                inputs.Ap.value = steelData.Ap.toFixed(4); // Update Ap field

                // Recalculate default sigma_j
                const default_sigma_j = Math.round(0.737 * fpu_kgf);
                inputs.sigma_j.value = default_sigma_j;

                calculateAndDisplay();
            }

            function updatePrintView(v, losses, intermediate) {
                // Sync Header
                const dateEl = document.getElementById('p_date');
                if (dateEl) dateEl.textContent = new Date().toLocaleDateString('zh-TW');

                // Sync Designer (New)
                const designerInput = document.getElementById('designer_name');
                const pDesigner = document.getElementById('p_designer_name');
                if (designerInput && pDesigner) {
                    pDesigner.textContent = designerInput.value || '';
                }

                // Sync Inputs
                const safeSet = (id, val) => { const e = document.getElementById(id); if (e) e.textContent = val; };

                safeSet('p_L', v.L.toFixed(1));
                safeSet('p_B', v.B.toFixed(1));
                safeSet('p_H', v.H.toFixed(1));
                safeSet('p_mu', v.mu.toFixed(4));
                safeSet('p_k', v.k.toFixed(4));
                safeSet('p_delta_a', v.delta_a.toFixed(1));
                safeSet('p_RH', v.RH.toFixed(1));
                safeSet('p_sigma_j', v.sigma_j.toFixed(2));
                safeSet('p_steel_type', (v.steel_type === '12.7' ? 'SWPR7BL 12.7mm' : 'SWPR7BL 15.2mm'));
                safeSet('p_num_ducts', v.num_ducts);
                safeSet('p_num_strands', v.num_strands);
                safeSet('p_total_ap', intermediate.total_Ap.toFixed(4));
                safeSet('p_fpu', v.fpu.toFixed(0));
                safeSet('p_fpy', v.fpy.toFixed(0));
                safeSet('p_Es', v.Es.toLocaleString());
                safeSet('p_Ec', v.Ec.toLocaleString());
                safeSet('p_Anet', v.Anet.toFixed(2));
                safeSet('p_Inet', v.Inet.toExponential(2));
                safeSet('p_ep', intermediate.ep.toFixed(2));
                safeSet('p_MDL', v.MDL.toFixed(2));
                safeSet('p_MADL', v.MADL.toFixed(2));

                // Sync Results
                const safeCopy = (pId, srcId) => {
                    const p = document.getElementById(pId);
                    const s = document.getElementById(srcId);
                    if (p && s) p.textContent = s.textContent;
                };

                safeSet('p_loss_friction', losses.friction.toFixed(2));
                safeCopy('p_perc_friction', 'perc_friction');

                safeSet('p_loss_anchorage', losses.anchorage.toFixed(2));
                safeCopy('p_perc_anchorage', 'perc_anchorage');

                safeSet('p_loss_elastic', losses.elastic.toFixed(2));
                safeCopy('p_perc_elastic', 'perc_elastic');

                safeSet('p_loss_stage', losses.stage_total.toFixed(2));
                safeCopy('p_perc_stage', 'perc_stage_total');

                safeSet('p_loss_shrinkage', losses.shrinkage.toFixed(2));
                safeCopy('p_perc_shrinkage', 'perc_shrinkage');

                safeSet('p_loss_creep', losses.creep.toFixed(2));
                safeCopy('p_perc_creep', 'perc_creep');

                safeSet('p_loss_relaxation', losses.relaxation.toFixed(2));
                safeCopy('p_perc_relaxation', 'perc_relaxation');

                safeSet('p_loss_longterm', losses.longterm_total.toFixed(2));
                safeCopy('p_perc_longterm', 'perc_longterm_total');

                safeSet('p_loss_total', losses.total.toFixed(2));
                safeCopy('p_perc_total', 'perc_total');

                safeSet('p_sigma_e', (v.sigma_j - losses.total).toFixed(2));
                safeCopy('p_perc_sigma_e', 'perc_sigma_e');

                // 1. Friction
                safeSet('p_detail_f_sigma_j', v.sigma_j.toFixed(2));
                safeSet('p_detail_f_L', v.L.toFixed(1));
                safeSet('p_detail_f_H', v.H.toFixed(1));
                safeSet('p_detail_f_B', v.B.toFixed(1));
                safeSet('p_detail_f_k', v.k.toFixed(4));
                safeSet('p_detail_f_mu', v.mu.toFixed(4));
                safeSet('p_detail_f_alpha', intermediate.alpha.toFixed(4));

                safeSet('p_detail_f_calc_alpha', document.getElementById('detail_f_calc_alpha').textContent);
                safeSet('p_detail_f_calc_S_m', document.getElementById('detail_f_calc_S_m').textContent);
                safeSet('p_detail_f_calc_Tcenter', document.getElementById('detail_f_calc_Tcenter').textContent);
                safeSet('p_detail_f_calc_loss', document.getElementById('detail_f_calc_loss').textContent);
                safeSet('p_detail_f_result', document.getElementById('detail_f_result').textContent);

                // 2. Anchorage
                safeSet('p_detail_a_k', v.k.toFixed(4));
                safeSet('p_detail_a_mu', v.mu.toFixed(4)); // Fixed to 4 decimals for consistency
                safeSet('p_detail_a_H', v.H.toFixed(1));
                safeSet('p_detail_a_B', v.B.toFixed(1));
                safeSet('p_detail_a_L', v.L.toFixed(1));
                safeSet('p_detail_a_Es', v.Es.toLocaleString());
                safeSet('p_detail_a_delta_a', v.delta_a.toFixed(1));
                safeSet('p_detail_a_sigma_j', v.sigma_j.toFixed(2));

                safeSet('p_detail_a_calc_m', document.getElementById('detail_a_calc_m').textContent);
                safeSet('p_detail_a_calc_exp', document.getElementById('detail_a_calc_exp').textContent);
                safeSet('p_detail_a_calc_t1', document.getElementById('detail_a_calc_t1').textContent);
                safeSet('p_detail_a_calc_t2', document.getElementById('detail_a_calc_t2').textContent);
                safeSet('p_detail_a_calc_loss', document.getElementById('detail_a_calc_loss').textContent);
                safeSet('p_detail_a_result', document.getElementById('detail_a_result').textContent);

                // 3. Elastic
                safeSet('p_detail_e_n', intermediate.n.toFixed(2));
                safeSet('p_detail_e_Total_Ap', intermediate.total_Ap.toFixed(2)); // Use intermediate value
                safeSet('p_detail_e_Anet', v.Anet.toFixed(2));
                safeSet('p_detail_e_Inet', v.Inet.toExponential(2));
                safeSet('p_detail_e_ep', intermediate.ep.toFixed(2));
                safeSet('p_detail_e_MDL', v.MDL.toFixed(2));
                safeSet('p_detail_e_sigma_j', v.sigma_j.toFixed(2));
                safeSet('p_detail_e_loss_f', losses.friction.toFixed(2));
                safeSet('p_detail_e_loss_a', losses.anchorage.toFixed(2));

                safeSet('p_detail_e_calc_a', document.getElementById('detail_e_calc_a').textContent);
                safeSet('p_detail_e_calc_b', document.getElementById('detail_e_calc_b').textContent);
                safeSet('p_detail_e_calc_c', document.getElementById('detail_e_calc_c').textContent);
                safeSet('p_detail_e_calc_d', document.getElementById('detail_e_calc_d').textContent);
                safeSet('p_detail_e_calc_sx', document.getElementById('detail_e_calc_sx').textContent);
                safeSet('p_detail_e_calc_loss', document.getElementById('detail_e_calc_loss').textContent);
                safeSet('p_detail_e_result', document.getElementById('detail_e_result').textContent);

                // 4. Shrinkage
                safeSet('p_detail_sh_RH', v.RH.toFixed(1));
                safeSet('p_detail_sh_calc', document.getElementById('detail_sh_calc').textContent);
                safeSet('p_detail_sh_result', document.getElementById('detail_sh_result').textContent);

                // 5. Creep
                safeSet('p_detail_c_MADL', v.MADL.toFixed(2));
                safeSet('p_detail_c_ep', intermediate.ep.toFixed(2));
                safeSet('p_detail_c_Inet', v.Inet.toExponential(2));
                safeSet('p_detail_c_loss_elastic', losses.elastic.toFixed(2));
                safeSet('p_detail_c_n', intermediate.n.toFixed(2));

                safeSet('p_detail_c_calc_e', document.getElementById('detail_c_calc_e').textContent);
                safeSet('p_detail_c_calc_f', document.getElementById('detail_c_calc_f').textContent);
                safeSet('p_detail_c_calc_loss', document.getElementById('detail_c_calc_loss').textContent);
                safeSet('p_detail_c_result', document.getElementById('detail_c_result').textContent);

                // 6. Relaxation
                safeSet('p_detail_r_fpu', v.fpu.toFixed(2));
                safeSet('p_detail_r_tcenter', intermediate.Tcenter.toFixed(2)); // Use intermediate
                safeSet('p_detail_r_loss_es', losses.elastic.toFixed(2));
                safeSet('p_detail_r_loss_sh', losses.shrinkage.toFixed(2));
                safeSet('p_detail_r_loss_cr', losses.creep.toFixed(2));

                safeSet('p_detail_r_calc_fr', document.getElementById('detail_r_calc_fr').textContent);
                safeSet('p_detail_r_calc_loss', document.getElementById('detail_r_calc_loss').textContent);
                safeSet('p_detail_r_result', document.getElementById('detail_r_result').textContent);
            }

            function updateCalculationDetails(v, losses, intermediate) {

                const {
                    alpha, delta_a_cm, n, Tcenter, m_slide, exp_term, term1, term2,
                    a, b, c, d, sigma_x, loss_elastic_raw,
                    e_param, f_param, loss_creep_raw,
                    FR_param, loss_relaxation_raw,
                    total_Ap, ep
                } = intermediate;

                // 1. Friction
                document.getElementById('detail_f_sigma_j').textContent = v.sigma_j.toFixed(2);
                document.getElementById('detail_f_L').textContent = v.L.toFixed(1);
                document.getElementById('detail_f_H').textContent = v.H.toFixed(1);
                document.getElementById('detail_f_B').textContent = v.B.toFixed(1);
                document.getElementById('detail_f_k').textContent = v.k.toFixed(4);
                document.getElementById('detail_f_mu').textContent = v.mu.toFixed(4);
                document.getElementById('detail_f_alpha').textContent = alpha.toFixed(4);

                const S_m_friction = v.L_m / 2;
                document.getElementById('detail_f_calc_alpha').textContent = `Î± = arctan(2 * ${v.H.toFixed(1)} / ${v.B.toFixed(1)}) = ${alpha.toFixed(4)} rad`;
                document.getElementById('detail_f_calc_S_m').textContent = `S = ${v.L.toFixed(1)}cm / 2 = ${S_m_friction.toFixed(2)} m`;
                document.getElementById('detail_f_calc_Tcenter').textContent = `T_center = ${v.sigma_j.toFixed(2)} / exp(${v.k.toFixed(4)}*${S_m_friction.toFixed(2)} + ${v.mu.toFixed(4)}*${alpha.toFixed(4)}) = ${Tcenter.toFixed(2)} kgf/cmÂ²`;
                document.getElementById('detail_f_calc_loss').textContent = `Î”Ïƒ_F = ${v.sigma_j.toFixed(2)} - ${Tcenter.toFixed(2)}`;
                document.getElementById('detail_f_result').textContent = `= ${losses.friction.toFixed(2)} kgf/cmÂ²`;

                // 2. Anchorage Set
                document.getElementById('detail_a_k').textContent = v.k.toFixed(4);
                document.getElementById('detail_a_mu').textContent = v.mu.toFixed(2);
                document.getElementById('detail_a_H').textContent = v.H.toFixed(1);
                document.getElementById('detail_a_B').textContent = v.B.toFixed(1);
                document.getElementById('detail_a_L').textContent = v.L.toFixed(1);
                document.getElementById('detail_a_Es').textContent = v.Es.toLocaleString();
                document.getElementById('detail_a_delta_a').textContent = v.delta_a.toFixed(1);
                document.getElementById('detail_a_sigma_j').textContent = v.sigma_j.toFixed(2);

                document.getElementById('detail_a_calc_m').textContent = `m_slide = (${v.k.toFixed(4)}/100) + 2*${v.mu.toFixed(2)}*${v.H.toFixed(1)}/(${v.B.toFixed(1)}^2) = ${m_slide.toExponential(4)}`;
                document.getElementById('detail_a_calc_exp').textContent = `exp_term = exp(-${m_slide.toExponential(4)} * ${v.L.toFixed(1)} / 2) = ${exp_term.toFixed(4)}`;
                document.getElementById('detail_a_calc_t1').textContent = `Term1 = (${m_slide.toExponential(4)} * ${v.Es.toLocaleString()} * ${delta_a_cm.toFixed(2)}) / (1 - ${exp_term.toFixed(4)}) = ${term1.toFixed(2)}`;
                document.getElementById('detail_a_calc_t2').textContent = `Term2 = ${v.sigma_j.toFixed(2)} * (1 - ${exp_term.toFixed(4)}) = ${term2.toFixed(2)}`;
                document.getElementById('detail_a_calc_loss').textContent = `Î”Ïƒ_A = ${term1.toFixed(2)} - ${term2.toFixed(2)}`;
                document.getElementById('detail_a_result').textContent = `= ${losses.anchorage.toFixed(2)} kgf/cmÂ²`;

                // 3. Elastic Shortening (NEW)
                document.getElementById('detail_e_n').textContent = n.toFixed(2);
                document.getElementById('detail_e_Total_Ap').textContent = total_Ap.toFixed(2);
                document.getElementById('detail_e_Anet').textContent = v.Anet.toFixed(2);
                document.getElementById('detail_e_Inet').textContent = v.Inet.toExponential(2);
                document.getElementById('detail_e_ep').textContent = ep.toFixed(2);
                document.getElementById('detail_e_MDL').textContent = v.MDL.toFixed(2);
                document.getElementById('detail_e_sigma_j').textContent = v.sigma_j.toFixed(2);
                document.getElementById('detail_e_loss_f').textContent = losses.friction.toFixed(2);
                document.getElementById('detail_e_loss_a').textContent = losses.anchorage.toFixed(2);

                document.getElementById('detail_e_calc_a').textContent = `a = ${total_Ap.toFixed(2)} / ${v.Anet.toFixed(2)} = ${a.toExponential(4)}`;
                document.getElementById('detail_e_calc_b').textContent = `b = (${total_Ap.toFixed(2)} * ${ep.toFixed(2)}^2) / ${v.Inet.toExponential(2)} = ${b.toExponential(4)}`;
                document.getElementById('detail_e_calc_c').textContent = `c = (${v.MDL.toFixed(2)} * 10^5 * ${ep.toFixed(2)}) / ${v.Inet.toExponential(2)} = ${c.toFixed(2)}`;
                document.getElementById('detail_e_calc_d').textContent = `d = ${v.sigma_j.toFixed(2)} - ${losses.friction.toFixed(2)} - ${losses.anchorage.toFixed(2)} = ${d.toFixed(2)}`;
                document.getElementById('detail_e_calc_sx').textContent = `Ïƒx = (${d.toFixed(2)} + 0.5*${n.toFixed(2)}*${c.toFixed(2)}) / (1 + 0.5*${n.toFixed(2)}*(${a.toExponential(4)}+${b.toExponential(4)})) = ${sigma_x.toFixed(2)}`;
                document.getElementById('detail_e_calc_loss').textContent = `Î”Ïƒ_ES = 0.5*${n.toFixed(2)}*(${a.toExponential(4)}*${sigma_x.toFixed(2)} + ${b.toExponential(4)}*${sigma_x.toFixed(2)} - ${c.toFixed(2)}) = ${loss_elastic_raw.toFixed(2)}`;
                document.getElementById('detail_e_result').textContent = `= ${losses.elastic.toFixed(2)} kgf/cmÂ²`;

                // 4. Shrinkage (NEW)
                document.getElementById('detail_sh_RH').textContent = v.RH.toFixed(1);
                document.getElementById('detail_sh_calc').textContent = `= 0.8 * (1195 - 10.55 * ${v.RH.toFixed(1)})`;
                document.getElementById('detail_sh_result').textContent = `= ${losses.shrinkage.toFixed(2)} kgf/cmÂ²`;

                // 5. Creep (NEW)
                document.getElementById('detail_c_MADL').textContent = v.MADL.toFixed(2);
                document.getElementById('detail_c_ep').textContent = ep.toFixed(2);
                document.getElementById('detail_c_Inet').textContent = v.Inet.toExponential(2);
                document.getElementById('detail_c_loss_elastic').textContent = losses.elastic.toFixed(2);
                document.getElementById('detail_c_n').textContent = n.toFixed(2);

                document.getElementById('detail_c_calc_e').textContent = `e = (${v.MADL.toFixed(2)} * 10^5 * ${ep.toFixed(2)}) / ${v.Inet.toExponential(2)} = ${e_param.toFixed(2)}`;
                document.getElementById('detail_c_calc_f').textContent = `f = (${losses.elastic.toFixed(2)} * 2) / ${n.toFixed(2)} = ${f_param.toFixed(2)}`;
                document.getElementById('detail_c_calc_loss').textContent = `Î”Ïƒ_CR = 12 * ${f_param.toFixed(2)} - 7 * ${e_param.toFixed(2)} = ${loss_creep_raw.toFixed(2)}`;
                document.getElementById('detail_c_result').textContent = `= ${losses.creep.toFixed(2)} kgf/cmÂ²`;

                // 6. Relaxation (NEW)
                document.getElementById('detail_r_fpu').textContent = v.fpu.toFixed(2);
                document.getElementById('detail_r_tcenter').textContent = Tcenter.toFixed(2);
                document.getElementById('detail_r_loss_es').textContent = losses.elastic.toFixed(2);
                document.getElementById('detail_r_loss_sh').textContent = losses.shrinkage.toFixed(2);
                document.getElementById('detail_r_loss_cr').textContent = losses.creep.toFixed(2);

                document.getElementById('detail_r_calc_fr').textContent = `FR = max(0, 0.7*${v.fpu.toFixed(2)} - ${Tcenter.toFixed(2)}) = ${FR_param.toFixed(2)}`;
                document.getElementById('detail_r_calc_loss').textContent = `Î”Ïƒ_R = 350 - 0.07*${FR_param.toFixed(2)} - 0.1*${losses.elastic.toFixed(2)} - 0.05*(${losses.shrinkage.toFixed(2)} + ${losses.creep.toFixed(2)}) = ${loss_relaxation_raw.toFixed(2)}`;
                document.getElementById('detail_r_result').textContent = `= ${losses.relaxation.toFixed(2)} kgf/cmÂ²`;

                // Sync to Print View (Must be called AFTER updating screen DOM)
                updatePrintView(v, losses, intermediate);
            }

            function calculateAndDisplay() {
                const v = getValues();
                const sigma_j = v.sigma_j;

                // Calculate and display Total Ap
                const steelData = steelTypes[v.steel_type];
                const Ap_single = steelData.Ap;
                const total_Ap = Ap_single * v.num_ducts * v.num_strands;
                document.getElementById('total_Ap_display').value = total_Ap.toFixed(4);

                // Calculate and display ep
                const ep = v.Ha - v.Ycg;
                const ep_display_el = document.getElementById('ep_display');
                if (ep_display_el) {
                    ep_display_el.value = ep.toFixed(2);
                }

                if (sigma_j === 0) {
                    return;
                }

                // --- 1. æ–½å·¥éšæ®µæå¤± (Î”Ïƒ_Stage) ---

                // 1a. æ‘©æ“¦æå¤± (Friction Loss, Î”Ïƒ_F)
                const alpha = (v.B > 0) ? Math.atan(2 * v.H / v.B) : 0; // ç¸½è§’åº¦ (rad)
                const S_m_friction = v.L_m / 2; // é‹¼è…±é•·åº¦ (m), ä½¿ç”¨ L/2
                const Tcenter = sigma_j / Math.exp(v.k * S_m_friction + v.mu * alpha);
                const loss_friction = sigma_j - Tcenter;

                // 1b. æ»‘å‹•æå¤± (Anchorage Set Loss, Î”Ïƒ_A)
                const k_cm = v.k / 100; // k from 1/m to 1/cm
                const delta_a_cm = v.delta_a_cm;
                const L_cm = v.L;

                const m_slide = (v.B > 0 && v.B !== 0) ? (k_cm + (2 * v.mu * v.H) / (v.B * v.B)) : k_cm;

                const exp_term_val = -m_slide * L_cm / 2;
                const exp_term = Math.exp(exp_term_val);

                let term1 = 0;
                const denominator_a = 1 - exp_term;
                if (denominator_a !== 0 && denominator_a !== 1) { // Avoid division by zero or NaN
                    term1 = (m_slide * v.Es * delta_a_cm) / denominator_a;
                }

                const term2 = v.sigma_j * (1 - exp_term);

                const loss_anchorage_raw = term1 - term2; // Use user's formula directly
                const final_loss_anchorage = (loss_anchorage_raw < 0) ? 0 : loss_anchorage_raw; // Loss cannot be negative

                // 1c. å½ˆæ€§ç¸®çŸ­æå¤± (Elastic Shortening Loss, Î”Ïƒ_ES) - **NEW FORMULA**
                const n = (v.Ec > 0) ? v.Es / v.Ec : 0;

                const a = (v.Anet > 0) ? total_Ap / v.Anet : 0;
                const b = (v.Inet > 0) ? (total_Ap * ep * ep) / v.Inet : 0;
                const c = (v.Inet > 0) ? (v.MDL_kgf_cm * ep) / v.Inet : 0; // ** c is positive **
                const d = v.sigma_j - loss_friction - final_loss_anchorage;

                const numerator_sx = d + 0.5 * n * c;
                const denominator_sx = 1 + 0.5 * n * (a + b); // ** Corrected denominator **

                const sigma_x = (denominator_sx !== 0) ? numerator_sx / denominator_sx : 0;

                const loss_elastic_raw = 0.5 * n * (a * sigma_x + b * sigma_x - c); // ** New ES formula **
                const final_loss_elastic = (loss_elastic_raw < 0) ? 0 : loss_elastic_raw; // Prevent negative elastic loss

                const loss_stage_total = loss_friction + final_loss_anchorage + final_loss_elastic;

                // --- 2. é•·æœŸæå¤± (Î”Ïƒ_LongTerm) ---
                const sigma_after_stage = sigma_j - loss_stage_total;

                // 2a. ä¹¾ç¸®æå¤± (Shrinkage Loss, Î”Ïƒ_SH) - **NEW FORMULA**
                const loss_shrinkage_raw = 0.8 * (1195 - 10.55 * v.RH);
                const loss_shrinkage = (loss_shrinkage_raw < 0) ? 0 : loss_shrinkage_raw;

                // 2b. æ½›è®Šæå¤± (Creep Loss, Î”Ïƒ_CR) - **NEW FORMULA**
                const e_param = (v.Inet > 0) ? (v.MADL_kgf_cm * ep) / v.Inet : 0;
                const f_param = (n > 0) ? (final_loss_elastic * 2) / n : 0;
                const loss_creep_raw = 12 * f_param - 7 * e_param;
                const final_loss_creep = (loss_creep_raw < 0) ? 0 : loss_creep_raw;

                // 2c. é¬†å¼›æå¤± (Relaxation Loss, Î”Ïƒ_R) - **NEW FORMULA**
                const FR_param = Math.max(0, 0.7 * v.fpu - Tcenter);
                const loss_relaxation_raw = 350 - 0.07 * FR_param - 0.1 * final_loss_elastic - 0.05 * (loss_shrinkage + final_loss_creep);
                const final_loss_relaxation = (loss_relaxation_raw < 0) ? 0 : loss_relaxation_raw;

                const loss_longterm_total = loss_shrinkage + final_loss_creep + final_loss_relaxation;

                // --- ç¸½æå¤± ---
                const loss_total = loss_stage_total + loss_longterm_total;
                const sigma_e = sigma_j - loss_total; // æœ‰æ•ˆé åŠ›

                // --- æ›´æ–°è¡¨æ ¼ ---
                const losses = {
                    friction: loss_friction,
                    anchorage: final_loss_anchorage,
                    elastic: final_loss_elastic,
                    stage_total: loss_stage_total,
                    shrinkage: loss_shrinkage,
                    creep: final_loss_creep,
                    relaxation: final_loss_relaxation,
                    longterm_total: loss_longterm_total,
                    total: loss_total
                };

                for (const key in losses) {
                    const el = document.getElementById(`loss_${key}`);
                    if (el) {
                        el.textContent = losses[key].toFixed(2);
                    }

                    const perc_el = document.getElementById(`perc_${key}`);
                    if (perc_el) {
                        const perc = (sigma_j > 0) ? (losses[key] / sigma_j) * 100 : 0;
                        perc_el.textContent = perc.toFixed(1) + '%';
                    }
                }

                document.getElementById('val_sigma_j').textContent = sigma_j.toFixed(2);
                document.getElementById('val_sigma_e').textContent = sigma_e.toFixed(2);
                document.getElementById('perc_sigma_e').textContent = (sigma_j > 0) ? ((sigma_e / sigma_j) * 100).toFixed(1) + '%' : '0.0%';

                // --- æ›´æ–°è©³ç´°è¨ˆç®—éç¨‹ ---
                const intermediate = {
                    alpha, delta_a_cm, n, Tcenter, m_slide, exp_term, term1, term2,
                    a, b, c, d, sigma_x, loss_elastic_raw,
                    e_param, f_param, loss_creep_raw,
                    FR_param, loss_relaxation_raw,
                    total_Ap, ep
                };
                updateCalculationDetails(v, losses, intermediate);


                // --- æ›´æ–°åœ–è¡¨ ---
                const chartData = [
                    losses.friction,
                    losses.anchorage,
                    losses.elastic,
                    losses.shrinkage,
                    losses.creep,
                    losses.relaxation,
                    Math.max(0, sigma_e) // æœ‰æ•ˆé åŠ› (ä¸ç‚ºè² )
                ];

                const chartLabels = [
                    'æ‘©æ“¦æå¤±',
                    'æ»‘å‹•æå¤±',
                    'å½ˆæ€§ç¸®çŸ­',
                    'ä¹¾ç¸®æå¤±',
                    'æ½›è®Šæå¤±',
                    'é¬†å¼›æå¤±',
                    'æœ‰æ•ˆé åŠ› (Ïƒe)'
                ];

                const chartColors = [
                    '#f87171', // red-400
                    '#fb923c', // orange-400
                    '#fbbf24', // amber-400
                    '#34d399', // emerald-400
                    '#60a5fa', // blue-400
                    '#c084fc', // purple-400
                    '#475569'  // slate-600
                ];

                if (!lossChart) {
                    const ctx = document.getElementById('lossChart').getContext('2d');
                    lossChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: chartLabels,
                            datasets: [{
                                label: 'æ‡‰åŠ› (kgf/cmÂ²)',
                                data: chartData,
                                backgroundColor: chartColors,
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right',
                                    labels: {
                                        font: {
                                            family: "'Inter', 'Noto Sans TC', sans-serif"
                                        }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            let label = context.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed !== null) {
                                                const value = context.parsed;
                                                const perc = (sigma_j > 0) ? (value / sigma_j) * 100 : 0;
                                                label += `${value.toFixed(2)} kgf/cmÂ² (${perc.toFixed(1)}%)`;
                                            }
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                } else {
                    lossChart.data.datasets[0].data = chartData;
                    lossChart.update();
                }
            }

            // --- äº‹ä»¶ç›£è½å™¨ ---
            inputIds.forEach(id => {
                const el = inputs[id];
                if (el) {
                    if (el.id === 'steel_type') {
                        el.addEventListener('change', updateSteelParams);
                    } else if (el.tagName === 'SELECT') {
                        el.addEventListener('change', calculateAndDisplay); // For num_ducts
                    } else {
                        el.addEventListener('input', calculateAndDisplay); // For all number inputs
                    }
                }
            });

            // Listener for Designer Name
            const designerInput = document.getElementById('designer_name');
            if (designerInput) {
                designerInput.addEventListener('input', () => {
                    const pDesigner = document.getElementById('p_designer_name');
                    if (pDesigner) pDesigner.textContent = designerInput.value || '';
                });
            }

            document.querySelectorAll('.stepper-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetId = btn.dataset.target;
                    const action = btn.dataset.action;
                    const step = parseFloat(btn.dataset.step);
                    const input = document.getElementById(targetId);

                    if (input) {
                        let currentValue = parseFloat(input.value) || 0;
                        let newValue;

                        if (action === 'inc') {
                            newValue = currentValue + step;
                        } else {
                            newValue = currentValue - step;
                        }

                        const decimalPlaces = (step.toString().split('.')[1] || '').length;
                        if (decimalPlaces > 0) {
                            newValue = parseFloat(newValue.toFixed(decimalPlaces));
                        }

                        if (targetId !== 'mu' && targetId !== 'k' && targetId !== 'num_strands' && targetId !== 'MDL' && targetId !== 'MADL') {
                            if (newValue < 0) newValue = 0;
                        }

                        if (targetId === 'num_strands' && newValue < 1) {
                            newValue = 1; // Strands cannot be less than 1
                        }


                        input.value = newValue;
                        input.dispatchEvent(new Event('input'));
                    }
                });
            });

            // Tab switching logic
            btnResultsTab.addEventListener('click', () => {
                btnResultsTab.classList.add('active');
                btnDetailsTab.classList.remove('active');
                resultsTab.classList.remove('hidden');
                detailsTab.classList.add('hidden');
            });

            btnDetailsTab.addEventListener('click', () => {
                btnDetailsTab.classList.add('active');
                btnResultsTab.classList.remove('active');
                detailsTab.classList.remove('hidden');
                resultsTab.classList.add('hidden');
            });

            // PDF Export Logic (Native Print)
            const btnExportPdf = document.getElementById('btn-export-pdf');
            if (btnExportPdf) {
                btnExportPdf.addEventListener('click', () => {
                    window.print();
                });
            }

            // åˆå§‹è¼‰å…¥
            updateSteelParams();
        });
    </script>
</body>

</html>
