<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>桃辦/新北辦儀表板 (靜態生成版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #555; }
        details > summary { list-style: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }
        details summary .arrow { transition: transform 0.2s; }
        details[open] summary .arrow { transform: rotate(90deg); }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
        }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover:not(:disabled) { background-color: #4b5563; }
        /* Modal styles */
        .modal-hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 lg:p-8">

    <div class="w-full max-w-7xl mx-auto">
        <header class="mb-8 text-center relative">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">桃辦/新北辦儀表板555</h1>
            <p class="text-gray-500 mt-2">整合人員資訊與年度執行績效 (資料由後端定時更新)</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:items-start">
            <!-- Personnel Section -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">人員組織</h2>
                </div>
                <div id="accordion-container" class="space-y-3 max-h-[70vh] overflow-y-auto custom-scrollbar pr-2">
                    <div class="text-center p-8 text-gray-500">讀取資料中...</div>
                </div>
            </div>

            <!-- Performance Section -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">114年度執行金額</h2>
                    <button id="refresh-dashboard-btn" class="btn btn-secondary">重新整理</button>
                 </div>
                 <div class="relative">
                     <canvas id="performanceChart"></canvas>
                 </div>
            </div>
        </div>
    </div>

    <!-- Modal for Person Details -->
    <div id="person-modal" class="modal-hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto custom-scrollbar">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 id="modal-name" class="text-2xl font-bold text-gray-900"></h3>
                        <p id="modal-group" class="text-gray-500"></p>
                    </div>
                    <button id="modal-close-btn" class="text-gray-400 hover:text-gray-600">&times;</button>
                </div>
                <div class="space-y-4">
                    <div>
                        <h4 class="font-semibold text-gray-700">職稱</h4>
                        <p id="modal-role" class="text-gray-600"></p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-700">學歷</h4>
                        <p id="modal-education" class="text-gray-600 whitespace-pre-wrap"></p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-700">證照</h4>
                        <ul id="modal-certs-list" class="list-disc list-inside text-gray-600 space-y-1"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        // --- GLOBAL VARIABLES & DOM REFERENCES ---
        let performanceChart = null;
        const accordionContainer = document.getElementById('accordion-container');
        const chartCanvas = document.getElementById('performanceChart');
        const refreshDashboardBtn = document.getElementById('refresh-dashboard-btn');

        // Modal DOM elements
        const personModal = document.getElementById('person-modal');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalName = document.getElementById('modal-name');
        const modalGroup = document.getElementById('modal-group');
        const modalRole = document.getElementById('modal-role');
        const modalEducation = document.getElementById('modal-education');
        const modalCertsList = document.getElementById('modal-certs-list');


        // --- 色彩參考 (用於圖表) ---
        const groupColorMapping = [
            { groupName: '孝智組', color: 'rgba(54, 162, 235, 0.6)', borderColor: 'rgba(54, 162, 235, 1)' },
            { groupName: '囿任組', color: 'rgba(255, 99, 132, 0.6)', borderColor: 'rgba(255, 99, 132, 1)' },
            { groupName: '鎧峻組', color: 'rgba(75, 192, 192, 0.6)', borderColor: 'rgba(75, 192, 192, 1)' },
            { groupName: '巍耀組', color: 'rgba(255, 206, 86, 0.6)', borderColor: 'rgba(255, 206, 86, 1)' },
            { groupName: '柏勛組', color: 'rgba(153, 102, 255, 0.6)', borderColor: 'rgba(153, 102, 255, 1)' }
        ];

        // --- MODAL LOGIC ---
        function showPersonDetails(person) {
            modalName.textContent = person.name || 'N/A';
            modalGroup.textContent = person.group || 'N/A';
            modalRole.textContent = person.role || '組員';
            modalEducation.textContent = person.education.replace(/\\n/g, '\n') || 'N/A';
            
            if (person.certificates && person.certificates.length > 0) {
                modalCertsList.innerHTML = person.certificates
                    .map(cert => `<li>${cert.name || '無效證照資料'}</li>`)
                    .join('');
            } else {
                modalCertsList.innerHTML = '<li>無證照</li>';
            }
            
            personModal.classList.remove('modal-hidden');
        }

        function hidePersonDetails() {
            personModal.classList.add('modal-hidden');
        }

        // --- UI RENDERING ---
        function buildAccordionUI(personnelData) {
            if (!personnelData || personnelData.length === 0) {
                accordionContainer.innerHTML = `<div class="text-center p-8 text-gray-500">目前沒有人員資料。</div>`;
                return;
            }
            
            const groupedData = personnelData.reduce((acc, person) => {
                const group = person.group || "其他人員";
                acc[group] = acc[group] || [];
                acc[group].push(person);
                return acc;
            }, {});

            const groupOrder = [ "副總經理", ...Object.keys(groupedData).filter(g => g !== "副總經理" && g !== "其他人員").sort((a, b) => a.localeCompare(b, 'zh-Hant')), "其他人員" ];
            
            accordionContainer.innerHTML = '';
            
            groupOrder.forEach(groupName => {
                const members = groupedData[groupName];
                if (!members) return;

                const details = document.createElement('details');
                details.className = 'bg-white border border-gray-200 rounded-lg overflow-hidden';
                if (groupName === '副總經理' || groupName.includes('組')) details.open = true;

                const summary = document.createElement('summary');
                summary.className = 'flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 transition';
                summary.innerHTML = `
                    <span class="font-semibold text-gray-700">${groupName}</span>
                    <span class="arrow text-gray-500"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></span>
                `;

                const membersGrid = document.createElement('div');
                membersGrid.className = 'p-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4';
                
                members.forEach(person => {
                    const memberDiv = document.createElement('div');
                    const hasCerts = person.certificates && person.certificates.length > 0 && person.certificates[0].name !== '#N/A';
                    const isManager = person.role === '副理' || person.role === '副總經理';
                    
                    let divClasses = `p-3 border rounded-lg text-left relative cursor-pointer hover:bg-gray-100 hover:shadow-md transition-all duration-200 `;
                    if (isManager) divClasses += 'bg-blue-50 border-blue-200';
                    else divClasses += 'bg-gray-50 border-gray-200';
                    memberDiv.className = divClasses;

                    memberDiv.innerHTML = `
                        <p class="font-semibold text-gray-900 truncate">${person.name}</p>
                        <p class="text-sm text-gray-500">${person.role || '組員'}</p>
                        ${hasCerts ? '<span class="absolute top-2 right-2 h-2.5 w-2.5 rounded-full bg-green-500 ring-2 ring-white" title="持有證照"></span>' : ''}
                    `;
                    memberDiv.addEventListener('click', () => showPersonDetails(person));
                    membersGrid.appendChild(memberDiv);
                });

                details.appendChild(summary);
                details.appendChild(membersGrid);
                accordionContainer.appendChild(details);
            });
        }

        function createOrUpdateChart(chartData) {
            const ctx = chartCanvas.getContext('2d');
            if (performanceChart) {
                performanceChart.data = chartData;
                performanceChart.update();
            } else {
                performanceChart = new Chart(ctx, {
                    type: 'bar',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, ticks: { callback: value => 'NT$ ' + value.toLocaleString() } } },
                        plugins: {
                            legend: { display: false },
                            tooltip: { callbacks: { label: context => `NT$ ${context.parsed.y.toLocaleString()}` } }
                        }
                    }
                });
            }
        }
        
        function renderPerformanceChart(performanceData) {
            const chartData = {
                labels: performanceData.map(p => p.groupName),
                datasets: [{
                    label: '114年度已請領費用 (元)',
                    data: performanceData.map(p => p.amount),
                    backgroundColor: performanceData.map(p => {
                        const mapping = groupColorMapping.find(m => m.groupName === p.groupName);
                        return mapping ? mapping.color : 'rgba(201, 203, 207, 0.6)';
                    }),
                    borderColor: performanceData.map(p => {
                        const mapping = groupColorMapping.find(m => m.groupName === p.groupName);
                        return mapping ? mapping.borderColor : 'rgba(201, 203, 207, 1)';
                    }),
                    borderWidth: 1,
                    borderRadius: 5
                }]
            };
            createOrUpdateChart(chartData);
        }

        // --- MAIN DATA FETCHING LOGIC ---
        async function loadDashboardData() {
            refreshDashboardBtn.disabled = true;
            refreshDashboardBtn.textContent = '讀取中...';
            
            // Use cache-busting query parameter to get the latest file
            const timestamp = new Date().getTime();

            try {
                // Fetch both data files concurrently
                const [personnelRes, performanceRes] = await Promise.all([
                    fetch(`personnelData.json?t=${timestamp}`),
                    fetch(`performanceData.json?t=${timestamp}`)
                ]);

                // Process Personnel Data
                if (personnelRes.ok) {
                    const personnelData = await personnelRes.json();
                    buildAccordionUI(personnelData);
                } else {
                    throw new Error(`找不到人員資料檔案 (personnelData.json): ${personnelRes.statusText}`);
                }
                
                // Process Performance Data
                if (performanceRes.ok) {
                    const values = await performanceRes.json(); // Expected: [["孝智組", ...], ["695,756", ...]]
                    if (!values || !Array.isArray(values) || values.length < 2 || !Array.isArray(values[0]) || !Array.isArray(values[1])) {
                         console.error("績效資料格式不符");
                         renderPerformanceChart([]);
                         return; // Exit if format is wrong
                    }
                    
                    const groupNames = values[0];
                    const groupAmounts = values[1];

                    const performanceData = groupNames.map((groupName, index) => {
                        const amountStr = groupAmounts[index] || "0";
                        const amount = parseInt(String(amountStr).replace(/,/g, ''), 10);
                        return { groupName: groupName, amount: isNaN(amount) ? 0 : amount };
                    });

                    renderPerformanceChart(performanceData);
                } else {
                    throw new Error(`找不到績效資料檔案 (performanceData.json): ${performanceRes.statusText}`);
                }

            } catch (error) {
                console.error("讀取儀表板資料失敗:", error);
                accordionContainer.innerHTML = `<div class="text-center p-8 text-red-500">儀表板資料載入失敗。<br>${error.message}</div>`;
                const ctx = chartCanvas.getContext('2d');
                ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
                ctx.font = "16px 'Noto Sans TC'";
                ctx.fillStyle = "red";
                ctx.textAlign = "center";
                ctx.fillText('無法載入圖表資料', chartCanvas.width / 2, 50);
            } finally {
                refreshDashboardBtn.disabled = false;
                refreshDashboardBtn.textContent = '重新整理';
            }
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', loadDashboardData);
        refreshDashboardBtn.addEventListener('click', loadDashboardData);
        modalCloseBtn.addEventListener('click', hidePersonDetails);
        personModal.addEventListener('click', (event) => {
            if (event.target === personModal) {
                hidePersonDetails();
            }
        });

    </script>
</body>
</html>
